{% extends 'pos/base.html' %}
{% load humanize %}

{% block title %}Gestión de Caja - MegaPos By Megadominio.co{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1><i class="bi bi-cash-stack"></i> Gestión de Caja</h1>
            <p style="color: #64748b; margin: 0.5rem 0 0 0;">
                Administra los movimientos de efectivo de la caja
                {% if hoy %}
                <span class="badge badge-modern badge-info-modern" style="margin-left: 0.5rem;">
                    <i class="bi bi-calendar"></i> {{ hoy|date:"d/m/Y" }}
                </span>
                {% endif %}
            </p>
        </div>
        {% if caja_abierta %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-success-pos" data-bs-toggle="modal" data-bs-target="#registrarIngresoModal">
                <i class="bi bi-plus-circle"></i> Registrar Ingreso
            </button>
            <button class="btn btn-danger-pos" data-bs-toggle="modal" data-bs-target="#registrarGastoModal">
                <i class="bi bi-dash-circle"></i> Registrar Gasto
            </button>
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#cerrarCajaModal" style="background: #6b7280; border: none; color: white;">
                <i class="bi bi-x-circle"></i> Cerrar Caja
            </button>
        </div>
        {% else %}
        <div>
            <button class="btn btn-primary-pos" data-bs-toggle="modal" data-bs-target="#abrirCajaModal">
                <i class="bi bi-box-arrow-in-down"></i> Abrir Caja
            </button>
        </div>
        {% endif %}
    </div>

    {% if caja_mostrar %}
    <!-- Resumen Financiero Mejorado -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card success">
                <div class="stat-card-label">
                    <i class="bi bi-currency-dollar"></i> Total Ventas
                </div>
                <div class="stat-card-value" id="totalVentasDisplay">${{ total_ventas|intcomma|default:"0" }}</div>
                <div class="stat-card-subtitle" style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem;">
                    {{ cantidad_ventas|intcomma|default:"0" }} venta{{ cantidad_ventas|pluralize }}
                    {% if cantidad_ventas > 0 %}
                    • Promedio: ${{ promedio_venta|intcomma|default:"0" }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card danger">
                <div class="stat-card-label">
                    <i class="bi bi-arrow-down-circle"></i> Total Gastos
                </div>
                <div class="stat-card-value" id="totalGastosDisplay">${{ total_gastos|intcomma|default:"0" }}</div>
                <div class="stat-card-subtitle" style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem;">
                    {{ cantidad_gastos|intcomma|default:"0" }} registro{{ cantidad_gastos|pluralize }}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card success">
                <div class="stat-card-label">
                    <i class="bi bi-arrow-up-circle"></i> Total Ingresos
                </div>
                <div class="stat-card-value" id="totalIngresosDisplay">${{ total_ingresos|intcomma|default:"0" }}</div>
                <div class="stat-card-subtitle" style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem;">
                    {{ cantidad_ingresos|intcomma|default:"0" }} registro{{ cantidad_ingresos|pluralize }}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card primary">
                <div class="stat-card-label">
                    <i class="bi bi-calculator"></i> Saldo en Caja
                </div>
                <div class="stat-card-value" id="saldoCajaDisplay">${{ saldo_caja|intcomma|default:"0" }}</div>
                <div class="stat-card-subtitle" style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem;">
                    {% if tiempo_transcurrido %}
                    <i class="bi bi-clock"></i> {{ tiempo_transcurrido }}
                    {% else %}
                    Caja cerrada
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="card-modern">
        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0;">
            <ul class="nav nav-tabs nav-tabs-custom" id="cajaTabs" role="tablist" style="border: none; margin: 0;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen" type="button" role="tab" aria-controls="resumen" aria-selected="true">
                        <i class="bi bi-info-circle"></i> Resumen
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="movimientos-tab" data-bs-toggle="tab" data-bs-target="#movimientos" type="button" role="tab" aria-controls="movimientos" aria-selected="false">
                        <i class="bi bi-list-ul"></i> Todos los Movimientos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab" aria-controls="historial" aria-selected="false">
                        <i class="bi bi-clock-history"></i> Historial
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="cajaTabsContent">
                <!-- Tab Resumen -->
                <div class="tab-pane fade show active" id="resumen" role="tabpanel" aria-labelledby="resumen-tab">
                    <!-- Información General de Caja -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                                    <i class="bi bi-info-circle"></i> Información General
                                </h5>
                                {% if not caja_mostrar.fecha_cierre %}
                                <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#cerrarCajaModal" style="background: #6b7280; border: none; color: white; padding: 0.5rem 1.25rem; font-size: 0.95rem;">
                                    <i class="bi bi-x-circle"></i> Cerrar Caja
                                </button>
                                {% endif %}
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card-modern" style="border-left: 4px solid #0ea5e9; background: #f0f9ff;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div style="flex: 1;">
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: 500;">
                                                        <i class="bi bi-cash-stack" style="color: #0ea5e9;"></i> Caja
                                                    </h6>
                                                    <div style="font-size: 1.3rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
                                                        {{ caja_mostrar.caja }}
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: #64748b;">
                                                        <i class="bi bi-calendar"></i> Apertura: {{ caja_mostrar.fecha_apertura|date:"d/m/Y H:i" }}
                                                        {% if tiempo_transcurrido %}
                                                        <br><i class="bi bi-clock"></i> Tiempo: {{ tiempo_transcurrido }}
                                                        {% endif %}
                                                        {% if caja_mostrar.fecha_cierre %}
                                                        <br><i class="bi bi-x-circle"></i> Cierre: {{ caja_mostrar.fecha_cierre|date:"d/m/Y H:i" }}
                                                        {% endif %}
                                                    </div>
                                                    {% if not caja_mostrar.fecha_cierre %}
                                                    <div style="margin-top: 1rem;">
                                                        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#cerrarCajaModal" style="background: #6b7280; border: none; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;">
                                                            <i class="bi bi-x-circle"></i> Cerrar Caja
                                                        </button>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div style="font-size: 2.5rem; opacity: 0.2; color: #0ea5e9;">
                                                    <i class="bi bi-cash-stack"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card-modern" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div style="flex: 1;">
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: 500;">
                                                        <i class="bi bi-wallet2" style="color: #10b981;"></i> Montos
                                                    </h6>
                                                    <div style="margin-bottom: 0.75rem;">
                                                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Monto Inicial</div>
                                                        <div style="font-size: 1.2rem; font-weight: 700; color: #10b981;">
                                                            ${{ caja_mostrar.monto_inicial|intcomma }}
                                                        </div>
                                                    </div>
                                                    {% if caja_mostrar.fecha_cierre %}
                                                    <div>
                                                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Monto Final</div>
                                                        <div style="font-size: 1.2rem; font-weight: 700; color: #0ea5e9;">
                                                            ${{ caja_mostrar.monto_final|intcomma|default:"0" }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div style="font-size: 2.5rem; opacity: 0.2; color: #10b981;">
                                                    <i class="bi bi-wallet2"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de Movimientos -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="mb-3" style="color: #1e293b; font-weight: 600;">
                                <i class="bi bi-bar-chart"></i> Resumen de Movimientos
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card-modern" style="border-left: 4px solid #3b82f6; background: #eff6ff;">
                                        <div class="card-body text-center">
                                            <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;">
                                                <i class="bi bi-receipt"></i>
                                            </div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem;">
                                                ${{ total_ventas|intcomma|default:"0" }}
                                            </div>
                                            <div style="font-size: 0.9rem; color: #64748b;">
                                                Total Ventas
                                            </div>
                                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                                                {{ cantidad_ventas|intcomma|default:"0" }} venta{{ cantidad_ventas|pluralize }}
                                                {% if cantidad_ventas > 0 %}
                                                <br>Promedio: ${{ promedio_venta|intcomma|default:"0" }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card-modern" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                                        <div class="card-body text-center">
                                            <div style="font-size: 2rem; color: #10b981; margin-bottom: 0.5rem;">
                                                <i class="bi bi-arrow-up-circle"></i>
                                            </div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem;">
                                                ${{ total_ingresos|intcomma|default:"0" }}
                                            </div>
                                            <div style="font-size: 0.9rem; color: #64748b;">
                                                Total Ingresos
                                            </div>
                                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                                                {{ cantidad_ingresos|intcomma|default:"0" }} registro{{ cantidad_ingresos|pluralize }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card-modern" style="border-left: 4px solid #ef4444; background: #fef2f2;">
                                        <div class="card-body text-center">
                                            <div style="font-size: 2rem; color: #ef4444; margin-bottom: 0.5rem;">
                                                <i class="bi bi-arrow-down-circle"></i>
                                            </div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem;">
                                                ${{ total_gastos|intcomma|default:"0" }}
                                            </div>
                                            <div style="font-size: 0.9rem; color: #64748b;">
                                                Total Gastos
                                            </div>
                                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                                                {{ cantidad_gastos|intcomma|default:"0" }} registro{{ cantidad_gastos|pluralize }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card-modern" style="border-left: 4px solid #0ea5e9; background: #f0f9ff;">
                                        <div class="card-body text-center">
                                            <div style="font-size: 2rem; color: #0ea5e9; margin-bottom: 0.5rem;">
                                                <i class="bi bi-calculator"></i>
                                            </div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #0ea5e9; margin-bottom: 0.25rem;">
                                                ${{ saldo_caja|intcomma|default:"0" }}
                                            </div>
                                            <div style="font-size: 0.9rem; color: #64748b;">
                                                Saldo en Caja
                                            </div>
                                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                                                {% if tiempo_transcurrido %}
                                                <i class="bi bi-clock"></i> {{ tiempo_transcurrido }}
                                                {% else %}
                                                Caja cerrada
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desglose de Ventas por Método de Pago -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="mb-3" style="color: #1e293b; font-weight: 600;">
                                <i class="bi bi-credit-card"></i> Desglose de Ventas por Método de Pago
                            </h5>
                            <div class="row g-3">
                                <!-- Efectivo -->
                                <div class="col-md-4">
                                    <div class="card-modern" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500;">
                                                        <i class="bi bi-cash-coin" style="color: #10b981;"></i> Efectivo
                                                    </h6>
                                                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">
                                                        ${{ ventas_efectivo|intcomma|default:"0" }}
                                                    </div>
                                                    <small style="color: #94a3b8;">
                                                        {{ porcentaje_efectivo|floatformat:1|default:"0" }}% del total
                                                    </small>
                                                </div>
                                                <div style="font-size: 2.5rem; opacity: 0.2; color: #10b981;">
                                                    <i class="bi bi-cash-coin"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tarjeta -->
                                <div class="col-md-4">
                                    <div class="card-modern" style="border-left: 4px solid #3b82f6; background: #eff6ff;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500;">
                                                        <i class="bi bi-credit-card" style="color: #3b82f6;"></i> Tarjeta
                                                    </h6>
                                                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">
                                                        ${{ ventas_tarjeta|intcomma|default:"0" }}
                                                    </div>
                                                    <small style="color: #94a3b8;">
                                                        {{ porcentaje_tarjeta|floatformat:1|default:"0" }}% del total
                                                    </small>
                                                </div>
                                                <div style="font-size: 2.5rem; opacity: 0.2; color: #3b82f6;">
                                                    <i class="bi bi-credit-card"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Transferencia -->
                                <div class="col-md-4">
                                    <div class="card-modern" style="border-left: 4px solid #8b5cf6; background: #f5f3ff;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500;">
                                                        <i class="bi bi-bank" style="color: #8b5cf6;"></i> Transferencia
                                                    </h6>
                                                    <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">
                                                        ${{ ventas_transferencia|intcomma|default:"0" }}
                                                    </div>
                                                    <small style="color: #94a3b8;">
                                                        {{ porcentaje_transferencia|floatformat:1|default:"0" }}% del total
                                                    </small>
                                                </div>
                                                <div style="font-size: 2.5rem; opacity: 0.2; color: #8b5cf6;">
                                                    <i class="bi bi-bank"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dinero Físico vs Bancario -->
                    <div class="row">
                        <div class="col-md-12">
                            <h5 class="mb-3" style="color: #1e293b; font-weight: 600;">
                                <i class="bi bi-wallet2"></i> Desglose de Dinero
                            </h5>
                            <div class="row g-3">
                                <!-- Dinero Físico en Caja -->
                                <div class="col-md-6">
                                    <div class="card-modern" style="border-left: 4px solid #f59e0b; background: #fffbeb;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500;">
                                                        <i class="bi bi-cash-stack" style="color: #f59e0b;"></i> Dinero Físico en Caja
                                                    </h6>
                                                    <div style="font-size: 1.8rem; font-weight: 700; color: #f59e0b;">
                                                        ${{ dinero_fisico_caja|intcomma|default:"0" }}
                                                    </div>
                                                    <small style="color: #94a3b8; display: block; margin-top: 0.5rem;">
                                                        Monto Inicial (${{ caja_mostrar.monto_inicial|intcomma|default:"0" }}) + 
                                                        Ventas Efectivo (${{ ventas_efectivo|intcomma|default:"0" }}) + 
                                                        Ingresos (${{ total_ingresos|intcomma|default:"0" }}) - 
                                                        Gastos (${{ total_gastos|intcomma|default:"0" }})
                                                    </small>
                                                </div>
                                                <div style="font-size: 3rem; opacity: 0.2; color: #f59e0b;">
                                                    <i class="bi bi-cash-stack"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dinero en Bancos -->
                                <div class="col-md-6">
                                    <div class="card-modern" style="border-left: 4px solid #6366f1; background: #eef2ff;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500;">
                                                        <i class="bi bi-bank2" style="color: #6366f1;"></i> Dinero en Bancos
                                                    </h6>
                                                    <div style="font-size: 1.8rem; font-weight: 700; color: #6366f1;">
                                                        ${{ ventas_tarjeta|add:ventas_transferencia|intcomma|default:"0" }}
                                                    </div>
                                                    <small style="color: #94a3b8; display: block; margin-top: 0.5rem;">
                                                        Tarjeta (${{ ventas_tarjeta|intcomma|default:"0" }}) + 
                                                        Transferencia (${{ ventas_transferencia|intcomma|default:"0" }})
                                                    </small>
                                                </div>
                                                <div style="font-size: 3rem; opacity: 0.2; color: #6366f1;">
                                                    <i class="bi bi-bank2"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Movimientos Unificados -->
                <div class="tab-pane fade" id="movimientos" role="tabpanel" aria-labelledby="movimientos-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                            <i class="bi bi-list-ul"></i> Todos los Movimientos
                            {% if hoy %}
                            <small style="color: #64748b; font-weight: 400; margin-left: 0.5rem;">({{ hoy|date:"d/m/Y" }})</small>
                            {% endif %}
                        </h5>
                        <span class="badge badge-modern badge-info-modern" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                            Total: {{ movimientos_unificados|length|intcomma }} movimientos
                        </span>
                    </div>
                    <div class="table-responsive">
                        <table class="table-modern table">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Saldo Antes</th>
                                    <th>Saldo Después</th>
                                    <th>Método de Pago</th>
                                    <th>Usuario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for movimiento in movimientos_unificados %}
                                <tr {% if movimiento.tipo == 'apertura' %}style="background: #f8fafc; border-left: 4px solid #0ea5e9;"{% endif %}>
                                    <td><strong>{{ movimiento.fecha|date:"d/m/Y H:i" }}</strong></td>
                                    <td>
                                        {% if movimiento.tipo == 'apertura' %}
                                        <span class="badge badge-modern" style="background: #0ea5e9; color: white;">
                                            <i class="bi bi-box-arrow-in-down"></i> Apertura
                                        </span>
                                        {% elif movimiento.tipo == 'venta' %}
                                        <span class="badge badge-modern" style="background: #3b82f6; color: white;">
                                            <i class="bi bi-receipt"></i> Venta
                                        </span>
                                        {% elif movimiento.tipo == 'retiro' %}
                                        <span class="badge badge-modern" style="background: #f59e0b; color: white;">
                                            <i class="bi bi-cash-coin"></i> Retiro
                                        </span>
                                        {% elif movimiento.tipo == 'gasto' %}
                                        <span class="badge badge-modern badge-danger-modern">
                                            <i class="bi bi-arrow-down-circle"></i> Gasto
                                        </span>
                                        {% elif movimiento.tipo == 'devolucion' %}
                                        <span class="badge badge-modern" style="background: #dc2626; color: white;">
                                            <i class="bi bi-arrow-counterclockwise"></i> Devolución
                                        </span>
                                        {% else %}
                                        <span class="badge badge-modern badge-success-modern">
                                            <i class="bi bi-arrow-up-circle"></i> Ingreso
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if movimiento.tipo == 'apertura' %}<strong>{% endif %}
                                        {{ movimiento.descripcion }}
                                        {% if movimiento.tipo == 'apertura' %}</strong>{% endif %}
                                        {% if movimiento.registradora_nombre %}
                                        <br><small style="color: #64748b;"><i class="bi bi-cash-register"></i> {{ movimiento.registradora_nombre }}</small>
                                        {% endif %}
                                        {% if movimiento.vendedor %}
                                        <br><small style="color: #64748b;">Vendedor: {{ movimiento.vendedor.get_full_name|default:movimiento.vendedor.username }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if movimiento.tipo == 'apertura' %}
                                        <strong style="color: #10b981;">+${{ movimiento.monto|intcomma }}</strong>
                                        {% elif movimiento.tipo == 'venta' %}
                                        <strong style="color: #3b82f6;">+${{ movimiento.monto|intcomma }}</strong>
                                        {% elif movimiento.tipo == 'devolucion' %}
                                        <strong style="color: #dc2626;">${{ movimiento.monto|intcomma }}</strong>
                                        <small style="color: #dc2626; display: block; font-size: 0.8rem;"><i class="bi bi-arrow-counterclockwise"></i> Devolución</small>
                                        {% elif movimiento.tipo == 'retiro' %}
                                        <strong style="color: #f59e0b;">-${{ movimiento.monto|intcomma }}</strong>
                                        {% elif movimiento.tipo == 'gasto' %}
                                        <strong style="color: #ef4444;">-${{ movimiento.monto|intcomma }}</strong>
                                        {% else %}
                                        <strong style="color: #10b981;">+${{ movimiento.monto|intcomma }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong style="color: #64748b; font-size: 0.9rem;">${{ movimiento.saldo_antes|intcomma }}</strong>
                                    </td>
                                    <td>
                                        <strong style="color: #0ea5e9; font-size: 1rem;">${{ movimiento.saldo_despues|intcomma }}</strong>
                                    </td>
                                    <td>
                                        {% if movimiento.metodo_pago %}
                                        <span class="badge badge-modern badge-info-modern">{{ movimiento.metodo_pago }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small style="color: #64748b;">{{ movimiento.usuario.get_full_name|default:movimiento.usuario.username }}</small>
                                    </td>
                                    <td>
                                        {% if movimiento.venta_id %}
                                        <a href="{% url 'pos:detalle_venta' movimiento.venta_id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
                                        No hay movimientos registrados el día de hoy
                                        <br>
                                        <small style="margin-top: 0.5rem; display: block;">Las ventas, gastos e ingresos aparecerán aquí</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Historial -->
                <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab">
                    <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <i class="bi bi-info-circle"></i> <strong>Importante:</strong> Todos los movimientos, ventas y el historial de cajas se conservan permanentemente. Al cerrar una caja, los datos no se borran y permanecen disponibles para consulta.
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                            <i class="bi bi-clock-history"></i> Historial de Cajas
                        </h5>
                        <span class="badge badge-modern badge-info-modern" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                            Total: {{ historial_cajas|length|intcomma }} registros
                        </span>
                    </div>
                    
                    <div class="row g-4">
                        {% for item in historial_cajas %}
                        <div class="col-12">
                            <div class="card-modern" style="border-left: 4px solid {% if item.fecha_cierre %}#64748b{% else %}#10b981{% endif %};">
                                <div class="card-header" style="background: {% if item.fecha_cierre %}linear-gradient(135deg, #64748b 0%, #475569 100%){% else %}linear-gradient(135deg, #10b981 0%, #059669 100%){% endif %}; color: white; padding: 1rem 1.5rem;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0" style="font-weight: 600;">
                                                <i class="bi bi-cash-stack"></i> {{ item.caja.caja }}
                                            </h6>
                                            <small style="opacity: 0.9;">
                                                <i class="bi bi-calendar"></i> {{ item.fecha_apertura|date:"d/m/Y" }}
                                                {% if item.fecha_cierre %}
                                                - {{ item.fecha_cierre|date:"d/m/Y" }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div>
                                            {% if item.fecha_cierre %}
                                            <span class="badge" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem;">
                                                <i class="bi bi-check-circle"></i> Cerrada
                                            </span>
                                            {% else %}
                                            <span class="badge" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem;">
                                                <i class="bi bi-circle-fill"></i> Abierta
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body" style="padding: 1.5rem;">
                                    <div class="row g-3">
                                        <!-- Información Principal -->
                                        <div class="col-md-6">
                                            <h6 style="color: #1e293b; font-weight: 600; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
                                                <i class="bi bi-info-circle"></i> Información General
                                            </h6>
                                            <table class="table table-sm" style="margin-bottom: 0;">
                                                <tbody>
                                                    <tr>
                                                        <td style="color: #64748b; width: 40%; border: none; padding: 0.5rem 0;"><strong>Apertura:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">{{ item.fecha_apertura|date:"d/m/Y H:i" }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Cierre:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            {% if item.fecha_cierre %}
                                                            {{ item.fecha_cierre|date:"d/m/Y H:i" }}
                                                            {% else %}
                                                            <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Monto Inicial:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            <strong style="color: #0ea5e9;">${{ item.monto_inicial|intcomma }}</strong>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Monto Final:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            {% if item.monto_final is not None %}
                                                            <strong style="color: #10b981;">${{ item.monto_final|intcomma }}</strong>
                                                            {% else %}
                                                            <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Movimientos -->
                                        <div class="col-md-6">
                                            <h6 style="color: #1e293b; font-weight: 600; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
                                                <i class="bi bi-arrow-left-right"></i> Movimientos
                                            </h6>
                                            <table class="table table-sm" style="margin-bottom: 0;">
                                                <tbody>
                                                    <tr>
                                                        <td style="color: #64748b; width: 40%; border: none; padding: 0.5rem 0;"><strong>Ventas:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            <strong style="color: #3b82f6;">${{ item.total_ventas|intcomma }}</strong>
                                                            <small style="color: #94a3b8;">({{ item.cantidad_ventas }} venta{{ item.cantidad_ventas|pluralize }})</small>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Ingresos:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            <strong style="color: #10b981;">+${{ item.total_ingresos|intcomma }}</strong>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Gastos:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            <strong style="color: #ef4444;">-${{ item.total_gastos|intcomma }}</strong>
                                                        </td>
                                                    </tr>
                                                    <tr style="background: #f8fafc; border-top: 2px solid #e2e8f0;">
                                                        <td style="color: #1e293b; border: none; padding: 0.75rem 0;"><strong>Saldo Esperado:</strong></td>
                                                        <td style="border: none; padding: 0.75rem 0;">
                                                            <strong style="color: #0ea5e9; font-size: 1.1rem;">${{ item.saldo_esperado|intcomma }}</strong>
                                                        </td>
                                                    </tr>
                                                    {% if item.diferencia is not None %}
                                                    <tr>
                                                        <td style="color: #64748b; border: none; padding: 0.5rem 0;"><strong>Diferencia:</strong></td>
                                                        <td style="border: none; padding: 0.5rem 0;">
                                                            {% if item.diferencia == 0 %}
                                                            <span class="badge badge-modern badge-success-modern">
                                                                <i class="bi bi-check-circle"></i> Cuadra
                                                            </span>
                                                            {% elif item.diferencia > 0 %}
                                                            <strong style="color: #10b981;">+${{ item.diferencia|intcomma }}</strong>
                                                            <small style="color: #94a3b8;">(Sobra)</small>
                                                            {% else %}
                                                            <strong style="color: #ef4444;">${{ item.diferencia|intcomma }}</strong>
                                                            <small style="color: #94a3b8;">(Falta)</small>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No hay historial de cajas</p>
                                <small>Las cajas abiertas y cerradas aparecerán aquí</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Sin Caja Abierta -->
    <div class="card-modern">
        <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <h5 class="mb-0" style="color: white;"><i class="bi bi-exclamation-triangle"></i> Sin Caja Abierta para Hoy</h5>
        </div>
        <div class="card-body text-center py-5">
            <i class="bi bi-cash-stack" style="font-size: 4rem; color: #f59e0b; margin-bottom: 1.5rem; opacity: 0.7;"></i>
            <p style="color: #64748b; font-size: 1.1rem; margin-bottom: 0.5rem;">
                No tienes una caja abierta para el día de hoy.
            </p>
            {% if hoy %}
            <p style="color: #64748b; font-size: 0.95rem; margin-bottom: 1.5rem;">
                <strong>Fecha:</strong> {{ hoy|date:"d/m/Y" }}
            </p>
            {% endif %}
            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1.5rem;">
                Debes abrir una caja diariamente para comenzar a vender y registrar movimientos.
            </p>
            <button class="btn btn-primary-pos btn-lg" data-bs-toggle="modal" data-bs-target="#abrirCajaModal">
                <i class="bi bi-box-arrow-in-down"></i> Abrir Caja para Hoy
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Abrir Caja -->
<div class="modal fade" id="abrirCajaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> Abrir Caja para Hoy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pos:abrir_caja' %}" id="formAbrirCaja">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                        <i class="bi bi-info-circle"></i> <strong>Nota:</strong> La caja debe abrirse y cerrarse diariamente. Todas las ventas se registran en la Caja Principal.
                        {% if hoy %}
                        <br><strong>Fecha:</strong> {{ hoy|date:"d/m/Y" }}
                        {% endif %}
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Monto Inicial *</label>
                        <input type="number" class="form-control form-control-modern" name="monto_inicial" id="montoInicial" step="1" min="0" value="0" required>
                        <small style="color: #94a3b8; font-size: 0.8rem;">Monto con el que inicias la caja</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; border: none;" id="btnCancelarAbrir">Cancelar</button>
                    <button type="submit" class="btn btn-primary-pos" id="btnAbrirCaja">
                        <i class="bi bi-check-circle"></i> Abrir Caja Principal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Registrar Gasto -->
<div class="modal fade" id="registrarGastoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-arrow-down-circle"></i> Registrar Gasto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pos:registrar_gasto' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group-modern">
                        <label class="form-label-modern">Monto *</label>
                        <input type="number" class="form-control form-control-modern" name="monto" step="1" min="1" required placeholder="Ingrese el monto del gasto">
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Descripción *</label>
                        <textarea class="form-control form-control-modern" name="descripcion" rows="4" required placeholder="Ej: Compra de materiales, pago de servicios, transporte, etc."></textarea>
                        <small style="color: #94a3b8; font-size: 0.8rem;">Describe el motivo del gasto</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; border: none;">Cancelar</button>
                    <button type="submit" class="btn btn-danger-pos">
                        <i class="bi bi-dash-circle"></i> Registrar Gasto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Registrar Ingreso -->
<div class="modal fade" id="registrarIngresoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-arrow-up-circle"></i> Registrar Entrada de Dinero</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pos:registrar_ingreso' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group-modern">
                        <label class="form-label-modern">Monto *</label>
                        <input type="number" class="form-control form-control-modern" name="monto" step="1" min="1" required placeholder="Ingrese el monto del ingreso">
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Descripción *</label>
                        <textarea class="form-control form-control-modern" name="descripcion" rows="4" required placeholder="Ej: Depósito de cliente, reembolso, préstamo, etc."></textarea>
                        <small style="color: #94a3b8; font-size: 0.8rem;">Describe el motivo del ingreso</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; border: none;">Cancelar</button>
                    <button type="submit" class="btn btn-success-pos">
                        <i class="bi bi-plus-circle"></i> Registrar Ingreso
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cerrar Caja -->
<div class="modal fade" id="cerrarCajaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-x-circle"></i> Cerrar Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pos:cerrar_caja' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning" style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Advertencia:</strong> Al cerrar la caja, se registrará el monto final y no podrás realizar más ventas con esta caja.
                    </div>
                    <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                        <i class="bi bi-info-circle"></i> <strong>Nota:</strong> Todos los movimientos, ventas y el historial se conservan permanentemente. Podrás consultarlos en cualquier momento desde el historial de cajas.
                    </div>
                    <div class="mb-3">
                        <p style="margin-bottom: 0.5rem;"><strong>Saldo total (incluye tarjeta/transferencia):</strong></p>
                        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 0.5rem; padding: 1rem; text-align: center; margin-bottom: 0.75rem;">
                            <div style="font-size: 1.6rem; font-weight: 700; color: #0c4a6e;">${{ saldo_caja|intcomma|default:"0" }}</div>
                            <small style="color: #64748b;">
                                Monto Inicial ({{ caja_mostrar.monto_inicial|intcomma|default:"0" }}) + Ventas ({{ total_ventas|intcomma|default:"0" }})
                                + Ingresos ({{ total_ingresos|intcomma|default:"0" }}) - Gastos ({{ total_gastos|intcomma|default:"0" }})
                            </small>
                        </div>
                        <p style="margin-bottom: 0.5rem;"><strong>Efectivo disponible para retirar:</strong></p>
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.6rem; font-weight: 700; color: #065f46;">${{ dinero_fisico_caja|intcomma|default:"0" }}</div>
                            <small style="color: #64748b;">
                                (Monto Inicial + Ventas en efectivo + Ingresos - Gastos) — sin tarjeta/transferencia
                            </small>
                        </div>
                        <p style="margin-bottom: 0.5rem; margin-top: 0.75rem;"><strong>Dinero en bancos (tarjeta + transferencia):</strong></p>
                        <div style="background: #fdf2f8; border: 2px solid #ec4899; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.6rem; font-weight: 700; color: #9d174d;">
                                ${{ dinero_bancos|intcomma|default:"0" }}
                            </div>
                            <small style="color: #64748b;">Este valor no está en la caja física; está en bancos.</small>
                        </div>
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Retiro de efectivo</label>
                        <input type="number" class="form-control form-control-modern" name="dinero_retirar_efectivo" id="dineroRetirarEfectivo" step="1" min="0" value="0" placeholder="0">
                        <small style="color: #94a3b8; font-size: 0.8rem;">Efectivo que te llevas de la caja (se registrará como salida).</small>
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Retiro de bancos (tarjeta/transferencia)</label>
                        <input type="number" class="form-control form-control-modern" name="dinero_retirar_bancos" id="dineroRetirarBancos" step="1" min="0" value="0" placeholder="0">
                        <small style="color: #94a3b8; font-size: 0.8rem;">Valor a “retirar”/registrar de bancos (se registrará como salida).</small>
                    </div>
                    <div class="mb-3" id="saldoDespuesRetiro" style="display: none;">
                        <p style="margin-bottom: 0.5rem;"><strong>Saldo después del retiro:</strong></p>
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="saldoCalculado">$0</div>
                        </div>
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">Monto Final en Caja *</label>
                        <input type="number" class="form-control form-control-modern" name="monto_final" id="montoFinal" step="1" min="0" required placeholder="Ingrese el monto contado físicamente">
                        <small style="color: #94a3b8; font-size: 0.8rem;">Monto total contado físicamente en la caja (después del retiro)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; border: none;">Cancelar</button>
                    <button type="submit" class="btn btn-danger-pos">
                        <i class="bi bi-x-circle"></i> Cerrar Caja
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Estilos personalizados para las tabs */
    .nav-tabs-custom {
        border-bottom: none;
    }
    
    .nav-tabs-custom .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 0;
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        background: transparent;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: white;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: white;
        background: rgba(255, 255, 255, 0.2);
        border-bottom: 3px solid white;
        font-weight: 600;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    .tab-pane {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dineroRetirarInput = document.getElementById('dineroRetirar');
        const saldoDespuesRetiro = document.getElementById('saldoDespuesRetiro');
        const saldoCalculado = document.getElementById('saldoCalculado');
        const montoFinalInput = document.getElementById('montoFinal');
        const dineroRetirarEfectivoInput = document.getElementById('dineroRetirarEfectivo');
        const dineroRetirarBancosInput = document.getElementById('dineroRetirarBancos');
        
        // Para retiro: usar SOLO efectivo disponible (no tarjeta/transferencia)
        const saldoInicial = {{ dinero_fisico_caja|default:0 }};
        const bancosInicial = {{ dinero_bancos|default:0 }};

        // Sugerir monto final inicial (efectivo contado) si el input existe
        if (montoFinalInput) {
            montoFinalInput.value = Math.max(0, saldoInicial);
        }
        
        function actualizarSaldosRetiro() {
            const retiroEfectivo = parseFloat(dineroRetirarEfectivoInput?.value) || 0;
            const retiroBancos = parseFloat(dineroRetirarBancosInput?.value) || 0;
            const nuevoEfectivo = saldoInicial - retiroEfectivo;
            const nuevoBancos = bancosInicial - retiroBancos;

            if (retiroEfectivo > 0 || retiroBancos > 0) {
                    saldoDespuesRetiro.style.display = 'block';
                saldoCalculado.textContent =
                    'Efectivo: $' + nuevoEfectivo.toLocaleString('es-ES') +
                    ' | Bancos: $' + nuevoBancos.toLocaleString('es-ES');
                    if (montoFinalInput) {
                    montoFinalInput.value = Math.max(0, nuevoEfectivo);
                    }
                } else {
                    saldoDespuesRetiro.style.display = 'none';
                    if (montoFinalInput) {
                    montoFinalInput.value = Math.max(0, saldoInicial);
                    }
                }
        }

        if (dineroRetirarEfectivoInput && saldoDespuesRetiro && saldoCalculado) {
            dineroRetirarEfectivoInput.addEventListener('input', actualizarSaldosRetiro);
        }
        if (dineroRetirarBancosInput && saldoDespuesRetiro && saldoCalculado) {
            dineroRetirarBancosInput.addEventListener('input', actualizarSaldosRetiro);
        }
        
        // Manejar el formulario de abrir caja
        const formAbrirCaja = document.getElementById('formAbrirCaja');
        const btnAbrirCaja = document.getElementById('btnAbrirCaja');
        const btnCancelarAbrir = document.getElementById('btnCancelarAbrir');
        const abrirCajaModal = document.getElementById('abrirCajaModal');
        
        if (formAbrirCaja && btnAbrirCaja) {
            formAbrirCaja.addEventListener('submit', function(e) {
                // Validar que el monto inicial sea válido
                const montoInicial = document.getElementById('montoInicial');
                if (montoInicial && parseFloat(montoInicial.value) < 0) {
                    e.preventDefault();
                    alert('El monto inicial no puede ser negativo');
                    return false;
                }
                
                // Deshabilitar botones y mostrar indicador de carga
                btnAbrirCaja.disabled = true;
                btnAbrirCaja.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Abriendo...';
                if (btnCancelarAbrir) {
                    btnCancelarAbrir.disabled = true;
                }
                
                // Permitir que el formulario se envíe normalmente
                // Django redirigirá después de procesar
                return true;
            });
            
            // Escuchar cuando el modal se cierre para limpiar el formulario si es necesario
            if (abrirCajaModal) {
                abrirCajaModal.addEventListener('hidden.bs.modal', function() {
                    // Resetear el formulario y botones cuando el modal se cierre
                    if (formAbrirCaja) {
                        formAbrirCaja.reset();
                    }
                    if (btnAbrirCaja) {
                        btnAbrirCaja.disabled = false;
                        btnAbrirCaja.innerHTML = '<i class="bi bi-check-circle"></i> Abrir Caja Principal';
                    }
                    if (btnCancelarAbrir) {
                        btnCancelarAbrir.disabled = false;
                    }
                });
            }
        }
    });
</script>

