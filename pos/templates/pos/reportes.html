{% extends 'pos/base.html' %}
{% load humanize %}

{% block title %}Reportes - MegaPos By Megadominio.co{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-graph-up"></i> Reportes y Estadísticas</h1>
    </div>

    {% if mostrar_seleccion %}
    <div class="row mt-4 g-4">
        <div class="col-md-6">
            <div class="card-modern text-center" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='?tipo=caja'">
                <div class="card-body p-5">
                    <i class="bi bi-cash-coin" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                    <h3 class="mb-3">Reportes de Caja</h3>
                    <p class="text-muted mb-4">Ventas, movimientos de caja, gastos, ingresos y retiros por fecha</p>
                    <a href="?tipo=caja" class="btn btn-primary-pos btn-lg">
                        <i class="bi bi-arrow-right"></i> Ver Reportes de Caja
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-modern text-center" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='?tipo=inventario'">
                <div class="card-body p-5">
                    <i class="bi bi-box-seam" style="font-size: 4rem; color: #007bff; margin-bottom: 1rem;"></i>
                    <h3 class="mb-3">Reportes de Inventario</h3>
                    <p class="text-muted mb-4">Movimientos de stock, entradas, salidas y trazabilidad de productos</p>
                    <a href="?tipo=inventario" class="btn btn-primary-pos btn-lg">
                        <i class="bi bi-arrow-right"></i> Ver Reportes de Inventario
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% elif tipo_reporte == 'inventario' %}
    <div class="card-modern mt-2">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Reporte de Inventario</h5>
            <a href="{% url 'pos:reportes' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a Selección
            </a>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <input type="hidden" name="tipo" value="inventario">
                <div class="col-md-3">
                    <label class="form-label-modern">Producto:</label>
                    <select class="form-select form-control-modern" name="producto" id="filtroProducto">
                        <option value="">Todos los productos</option>
                        {% for producto in productos %}
                        <option value="{{ producto.id }}" {% if producto_id == producto.id|stringformat:"s" %}selected{% endif %}>
                            {{ producto.codigo }} - {{ producto.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label-modern">Tipo:</label>
                    <select class="form-select form-control-modern" name="tipo_mov">
                        <option value="">Todos</option>
                        <option value="entrada" {% if tipo_movimiento == 'entrada' %}selected{% endif %}>Entrada</option>
                        <option value="salida" {% if tipo_movimiento == 'salida' %}selected{% endif %}>Salida</option>
                        <option value="ajuste" {% if tipo_movimiento == 'ajuste' %}selected{% endif %}>Ajuste</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label-modern">Fecha Desde</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_desde" value="{{ fecha_desde }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label-modern">Fecha Hasta</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_hasta" value="{{ fecha_hasta }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary-pos w-100">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card-modern mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Resumen de Entradas y Salidas por Producto</h5>
            <small class="text-muted">Total: {{ resumen_productos.paginator.count|intcomma }} productos</small>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Atributo</th>
                            <th class="text-end">Entradas</th>
                            <th class="text-end">Salidas</th>
                            <th class="text-end">Ajustes</th>
                            <th class="text-end"><strong>Neto</strong></th>
                            <th class="text-end"><strong>Stock Actual</strong></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in resumen_productos %}
                        <tr>
                            <td><strong>{{ item.codigo }}</strong></td>
                            <td>{{ item.nombre }}</td>
                            <td>
                                {{ item.atributos }}
                                {% if item.cantidad_variantes > 1 %}
                                <small class="text-muted">({{ item.cantidad_variantes }} variantes)</small>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-success-modern">{{ item.total_entradas|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-danger-modern">{{ item.total_salidas|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                {% if item.ajustes != 0 %}
                                <span class="badge badge-modern badge-warning-modern">{% if item.ajustes > 0 %}+{% endif %}{{ item.ajustes|intcomma }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.neto > 0 %}text-success{% elif item.neto < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if item.neto > 0 %}+{% endif %}{{ item.neto|intcomma }}
                                </strong>
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.stock_actual > 0 %}text-primary{% elif item.stock_actual == 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ item.stock_actual|intcomma }}
                                </strong>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">No hay productos con movimientos en este rango.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if resumen_productos.paginator.num_pages > 1 %}
            <nav class="mt-3" aria-label="Paginación productos">
                <ul class="pagination pagination-sm mb-0">
                    {% if resumen_productos.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?tipo=inventario&producto={{ producto_id }}&tipo_mov={{ tipo_movimiento }}&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&page={{ resumen_productos.previous_page_number }}">Anterior</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link">Página {{ resumen_productos.number }} de {{ resumen_productos.paginator.num_pages }}</span>
                    </li>
                    {% if resumen_productos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?tipo=inventario&producto={{ producto_id }}&tipo_mov={{ tipo_movimiento }}&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&page={{ resumen_productos.next_page_number }}">Siguiente</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="card-modern mt-2">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Reporte de Caja</h5>
            <a href="{% url 'pos:reportes' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a Selección
            </a>
        </div>
    </div>
    <div class="card-modern mt-2">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtro</h5>
        </div>
        <div class="card-body">
            <form method="get">
                <input type="hidden" name="tipo" value="caja">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Desde</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_desde" value="{{ fecha_desde|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Hasta</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_hasta" value="{{ fecha_hasta|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary-pos w-100">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
            <div class="mt-3 d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-outline-primary"
                   href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&export=movimientos_caja">
                    <i class="bi bi-download"></i> CSV Movimientos (Caja)
                </a>
                <a class="btn btn-sm btn-outline-success"
                   href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&export=movimientos_caja&format=xlsx">
                    <i class="bi bi-file-earmark-excel"></i> Excel Movimientos (Caja)
                </a>
                <span class="text-muted" style="align-self:center;">
                    Rango: <strong>{{ fecha_desde|date:"d/m/Y" }}</strong> a <strong>{{ fecha_hasta|date:"d/m/Y" }}</strong>
                </span>
            </div>
        </div>
    </div>

    {% if not modo_simple %}
    <div class="cards-grid">
        <div class="stat-card success">
            <div class="stat-card-label">
                <i class="bi bi-currency-dollar"></i> Total Ventas (válidas)
            </div>
            <div class="stat-card-value">${{ total_ventas|intcomma }}</div>
        </div>
        <div class="stat-card primary">
            <div class="stat-card-label">
                <i class="bi bi-receipt"></i> Ventas (válidas)
            </div>
            <div class="stat-card-value">{{ cantidad_ventas|intcomma }}</div>
        </div>
        <div class="stat-card info">
            <div class="stat-card-label">
                <i class="bi bi-graph-up-arrow"></i> Promedio por Venta
            </div>
            <div class="stat-card-value">${{ promedio_venta|intcomma }}</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-card-label">
                <i class="bi bi-x-circle"></i> Anuladas
            </div>
            <div class="stat-card-value">{{ cantidad_anuladas|intcomma }}</div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Top productos (por cantidad)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_productos %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.producto__nombre }}</td>
                                    <td><span class="badge badge-modern badge-success-modern">{{ item.total_vendido|intcomma }}</span></td>
                                    <td><strong>${{ item.total_valor|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ventas por método (válidas)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">
                            Efectivo: <strong>${{ ventas_efectivo|intcomma }}</strong> |
                            Tarjeta: <strong>${{ ventas_tarjeta|intcomma }}</strong> |
                            Transferencia: <strong>${{ ventas_transferencia|intcomma }}</strong> |
                            Bancos: <strong>${{ dinero_bancos|intcomma }}</strong>
                        </small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Método</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metodo in ventas_por_metodo %}
                                <tr>
                                    <td>{{ metodo.metodo_pago|capfirst }}</td>
                                    <td>{{ metodo.cantidad|intcomma }}</td>
                                    <td><strong>${{ metodo.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4 g-4">
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Totales de ventas por día</h5>
                    <small class="text-muted">Ventas completadas (válidas) y anuladas</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    {% if modo_simple %}
                                    <th>Día</th>
                                    <th>Ventas OK</th>
                                    <th>Anuladas</th>
                                    <th>Efectivo</th>
                                    <th>Transferencia</th>
                                    <th>Tarjeta</th>
                                    {% else %}
                                    <th>Día</th>
                                    <th>Saldo inicial</th>
                                    <th>Ventas OK</th>
                                    <th>Anuladas</th>
                                    <th>Efectivo</th>
                                    <th>Tarjeta</th>
                                    <th>Transferencia</th>
                                    <th>Gastos (sin retiro)</th>
                                    <th>Ingresos</th>
                                    <th>Retiros</th>
                                    <th>Neto operativo</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in resumen_diario %}
                                <tr>
                                    {% if modo_simple %}
                                    <td><strong>{{ d.dia|date:"d/m/Y" }}</strong></td>
                                    <td><strong>${{ d.ventas_total|intcomma }}</strong> ({{ d.ventas_cantidad|intcomma }})</td>
                                    <td>${{ d.anuladas_total|intcomma }} ({{ d.anuladas_cantidad|intcomma }})</td>
                                    <td>${{ d.ventas_efectivo|intcomma }}</td>
                                    <td>${{ d.ventas_transferencia|intcomma }}</td>
                                    <td>${{ d.ventas_tarjeta|intcomma }}</td>
                                    {% else %}
                                    <td><strong>{{ d.dia|date:"d/m/Y" }}</strong></td>
                                    <td>${{ d.saldo_inicial|intcomma }}</td>
                                    <td>${{ d.ventas_total|intcomma }} ({{ d.ventas_cantidad|intcomma }})</td>
                                    <td>${{ d.anuladas_total|intcomma }} ({{ d.anuladas_cantidad|intcomma }})</td>
                                    <td>${{ d.ventas_efectivo|intcomma }}</td>
                                    <td>${{ d.ventas_tarjeta|intcomma }}</td>
                                    <td>${{ d.ventas_transferencia|intcomma }}</td>
                                    <td>${{ d.gastos_sin_retiro_total|intcomma }} ({{ d.gastos_sin_retiro_cantidad|intcomma }})</td>
                                    <td>${{ d.ingresos_total|intcomma }} ({{ d.ingresos_cantidad|intcomma }})</td>
                                    <td>${{ d.retiros_total|intcomma }} ({{ d.retiros_cantidad|intcomma }})</td>
                                    <td><strong>${{ d.neto_operativo|intcomma }}</strong></td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    {% if modo_simple %}
                                    <td colspan="6" class="text-center text-muted">No hay ventas en este rango.</td>
                                    {% else %}
                                    <td colspan="11" class="text-center text-muted">No hay datos diarios en este rango.</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        {% if not modo_simple %}
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Resumen por usuario (cajero)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in resumen_por_usuario %}
                                <tr>
                                    <td>{{ r.usuario__username|default:"-" }}</td>
                                    <td><span class="badge badge-modern badge-info-modern">{{ r.cantidad|intcomma }}</span></td>
                                    <td><strong>${{ r.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Resumen por vendedor</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Vendedor</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in resumen_por_vendedor %}
                                <tr>
                                    <td>{{ r.vendedor__username|default:"-" }}</td>
                                    <td><span class="badge badge-modern badge-info-modern">{{ r.cantidad|intcomma }}</span></td>
                                    <td><strong>${{ r.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Ventas (detalle)</h5>
                    <small class="text-muted">Incluye anuladas (marcadas) + detalle de ítems</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Método</th>
                                    <th>Total</th>
                                    <th>Items</th>
                                    <th>Usuario</th>
                                    <th>Vendedor</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in ventas_detalle %}
                                <tr>
                                    <td>{{ v.id }}</td>
                                    <td>{{ v.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ v.get_metodo_pago_display }}</td>
                                    <td><strong>${{ v.total|intcomma }}</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#itemsVenta{{ v.id }}"
                                                aria-expanded="false"
                                                aria-controls="itemsVenta{{ v.id }}">
                                            <i class="bi bi-list-ul"></i> Ver ({{ v.items.all|length }})
                                        </button>
                                    </td>
                                    <td>{{ v.usuario.username|default:"-" }}</td>
                                    <td>{{ v.vendedor.username|default:"-" }}</td>
                                    <td>
                                        {% if v.anulada %}
                                        <span class="badge badge-modern badge-danger-modern">Anulada</span>
                                        {% else %}
                                        <span class="badge badge-modern badge-success-modern">OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary" href="{% url 'pos:detalle_venta' v.id %}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr class="collapse" id="itemsVenta{{ v.id }}">
                                    <td colspan="9">
                                        <div class="p-2">
                                            <div class="table-responsive">
                                                <table class="table table-sm mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Producto</th>
                                                            <th>Cantidad</th>
                                                            <th>Precio</th>
                                                            <th>Subtotal</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for it in v.items.all %}
                                                        <tr>
                                                            <td>{{ it.producto.nombre }}</td>
                                                            <td>{{ it.cantidad|intcomma }}</td>
                                                            <td>${{ it.precio_unitario|intcomma }}</td>
                                                            <td><strong>${{ it.subtotal|intcomma }}</strong></td>
                                                        </tr>
                                                        {% empty %}
                                                        <tr>
                                                            <td colspan="4" class="text-center text-muted">Sin ítems</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No hay ventas en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if ventas_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación ventas">
                        <ul class="pagination pagination-sm mb-0">
                            {% if ventas_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_ventas={{ ventas_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ ventas_detalle.number }} de {{ ventas_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if ventas_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_ventas={{ ventas_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Movimientos de Caja (estilo Caja)</h5>
                    <small class="text-muted">
                        Rango seleccionado (todas)
                    </small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Saldo Antes</th>
                                    <th>Saldo Después</th>
                                    <th>Método de Pago</th>
                                    <th>Usuario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in movimientos_caja_detalle %}
                                <tr>
                                    <td>{{ m.fecha_local|date:"d/m/Y H:i" }}</td>
                                    <td>{{ m.tipo }}</td>
                                    <td style="max-width: 520px;">{{ m.descripcion }}</td>
                                    <td><strong>{% if m.delta >= 0 %}+{% endif %}${{ m.delta|intcomma }}</strong></td>
                                    <td>${{ m.saldo_antes|intcomma }}</td>
                                    <td><strong>${{ m.saldo_despues|intcomma }}</strong></td>
                                    <td>{{ m.metodo_pago|default:"-" }}</td>
                                    <td>{{ m.usuario|default:"-" }}</td>
                                    <td>
                                        {% if m.venta_id %}
                                        <a class="btn btn-sm btn-outline-primary" href="{% url 'pos:detalle_venta' m.venta_id %}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No hay movimientos para este filtro.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if movimientos_caja_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación movimientos caja">
                        <ul class="pagination pagination-sm mb-0">
                            {% if movimientos_caja_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs_caja={{ movimientos_caja_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ movimientos_caja_detalle.number }} de {{ movimientos_caja_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if movimientos_caja_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs_caja={{ movimientos_caja_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Movimientos de caja (gastos/ingresos/retiros)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">
                            Gastos (sin retiros): <strong>${{ total_gastos|intcomma }}</strong> |
                            Ingresos: <strong>${{ total_ingresos|intcomma }}</strong> |
                            Retiros: <strong>${{ total_retiros|intcomma }}</strong>
                        </small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Usuario</th>
                                    <th>Caja</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in movimientos_detalle %}
                                <tr>
                                    <td>{{ m.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ m.tipo|capfirst }}</td>
                                    <td>{{ m.descripcion }}</td>
                                    <td><strong>${{ m.monto|intcomma }}</strong></td>
                                    <td>{{ m.usuario.username }}</td>
                                    <td>{{ m.caja_usuario_id|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No hay movimientos en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if movimientos_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación movimientos">
                        <ul class="pagination pagination-sm mb-0">
                            {% if movimientos_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs={{ movimientos_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ movimientos_detalle.number }} de {{ movimientos_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if movimientos_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs={{ movimientos_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Cajas (aperturas/cierres)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Apertura</th>
                                    <th>Cierre</th>
                                    <th>Inicial</th>
                                    <th>Final</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in cajas_detalle %}
                                <tr>
                                    <td>{{ c.id }}</td>
                                    <td>{{ c.fecha_apertura|date:"d/m/Y H:i" }}</td>
                                    <td>{% if c.fecha_cierre %}{{ c.fecha_cierre|date:"d/m/Y H:i" }}{% else %}<span class="badge badge-modern badge-success-modern">Abierta</span>{% endif %}</td>
                                    <td>${{ c.monto_inicial|intcomma }}</td>
                                    <td>{% if c.monto_final is not None %}${{ c.monto_final|intcomma }}{% else %}-{% endif %}</td>
                                    <td>{{ c.usuario.username }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No hay cajas en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if cajas_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación cajas">
                        <ul class="pagination pagination-sm mb-0">
                            {% if cajas_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_cajas={{ cajas_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ cajas_detalle.number }} de {{ cajas_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if cajas_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_cajas={{ cajas_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

