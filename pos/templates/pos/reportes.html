{% extends 'pos/base.html' %}
{% load humanize %}

{% block title %}Reportes - MegaPos By Megadominio.co{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-graph-up"></i> Reportes y Estadísticas</h1>
    </div>

    {% if mostrar_seleccion %}
    <div class="row mt-4 g-4">
        <div class="col-md-6">
            <div class="card-modern text-center" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='?tipo=caja'">
                <div class="card-body p-5">
                    <i class="bi bi-cash-coin" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                    <h3 class="mb-3">Reportes de Caja</h3>
                    <p class="text-muted mb-4">Ventas, movimientos de caja, gastos, ingresos y retiros por fecha</p>
                    <a href="?tipo=caja" class="btn btn-primary-pos btn-lg">
                        <i class="bi bi-arrow-right"></i> Ver Reportes de Caja
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-modern text-center" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='?tipo=inventario'">
                <div class="card-body p-5">
                    <i class="bi bi-box-seam" style="font-size: 4rem; color: #007bff; margin-bottom: 1rem;"></i>
                    <h3 class="mb-3">Reportes de Inventario</h3>
                    <p class="text-muted mb-4">Movimientos de stock, entradas, salidas y trazabilidad de productos</p>
                    <a href="?tipo=inventario" class="btn btn-primary-pos btn-lg">
                        <i class="bi bi-arrow-right"></i> Ver Reportes de Inventario
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% elif tipo_reporte == 'inventario' %}
    <div class="card-modern mt-2">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Reporte de Inventario</h5>
            <a href="{% url 'pos:reportes' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a Selección
            </a>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3" id="formReporteInventario">
                <input type="hidden" name="tipo" value="inventario">
                <div class="col-md-3">
                    <label class="form-label-modern">Producto:</label>
                    <div class="autocomplete-wrapper" style="position: relative; z-index: 10000;">
                        <input type="text" 
                               class="form-control form-control-modern" 
                               id="filtroProducto" 
                               name="producto_nombre"
                               placeholder="Buscar producto (código o nombre)..."
                               autocomplete="off"
                               value="{% if producto_id %}{% for p in productos %}{% if p.id|stringformat:"s" == producto_id %}{{ p.codigo }} - {{ p.nombre }}{% endif %}{% endfor %}{% endif %}">
                        <input type="hidden" name="producto" id="producto_id_hidden" value="{{ producto_id }}">
                        <div class="autocomplete-dropdown" 
                             style="position: fixed; background: white; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; z-index: 99999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 4px; min-width: 300px;">
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label-modern">Tipo:</label>
                    <select class="form-select form-control-modern" name="tipo_mov">
                        <option value="">Todos</option>
                        <option value="ingreso" {% if tipo_movimiento == 'ingreso' %}selected{% endif %}>Ingreso</option>
                        <option value="salida" {% if tipo_movimiento == 'salida' %}selected{% endif %}>Salida</option>
                        <option value="ajuste" {% if tipo_movimiento == 'ajuste' %}selected{% endif %}>Ajuste</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label-modern">Fecha Desde</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_desde" value="{% if fecha_desde %}{{ fecha_desde }}{% endif %}">
                </div>
                <div class="col-md-3">
                    <label class="form-label-modern">Fecha Hasta</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_hasta" value="{% if fecha_hasta %}{{ fecha_hasta }}{% endif %}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary-pos w-100" id="btnGenerarReporte">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </form>
            
            <!-- Barra de carga -->
            <div id="loadingBar" style="display: none; margin-top: 20px;">
                <div class="alert alert-info d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                    <div>
                        <strong>Generando reporte...</strong>
                        <p class="mb-0 small">Estamos procesando los datos, por favor espere.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-modern mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Resumen de Entradas y Salidas por Producto</h5>
                <small class="text-muted">Total: {{ resumen_productos|length|intcomma }} productos</small>
            </div>
            <div>
                <a class="btn btn-sm btn-outline-success"
                   href="?tipo=inventario{% if producto_id %}&producto={{ producto_id }}{% endif %}{% if tipo_movimiento %}&tipo_mov={{ tipo_movimiento }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}&export=resumen_inventario&format=xlsx">
                    <i class="bi bi-file-earmark-excel"></i> Descargar Excel
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Atributo</th>
                            <th class="text-end">Stock Inicial</th>
                            <th class="text-end">Entradas</th>
                            <th class="text-end">Salidas</th>
                            <th class="text-end">Ajustes</th>
                            <th class="text-end"><strong>Neto</strong></th>
                            <th class="text-end"><strong>Stock Actual</strong></th>
                            <th class="text-center">Cantidad Física Contada</th>
                            <th>Análisis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in resumen_productos %}
                        <tr class="{% if item.tiene_problemas %}table-warning{% endif %}">
                            <td><strong>{{ item.codigo }}</strong></td>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.atributo }}</td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-info-modern">{{ item.stock_inicial|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-success-modern">{{ item.total_entradas|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-danger-modern">{{ item.total_salidas|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                {% if item.ajustes != 0 %}
                                <span class="badge badge-modern badge-warning-modern">{% if item.ajustes > 0 %}+{% endif %}{{ item.ajustes|intcomma }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.neto > 0 %}text-success{% elif item.neto < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if item.neto > 0 %}+{% endif %}{{ item.neto|intcomma }}
                                </strong>
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.stock_actual > 0 %}text-primary{% elif item.stock_actual == 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ item.stock_actual|intcomma }}
                                </strong>
                            </td>
                            <td class="text-center">
                                <div class="input-group input-group-sm" style="max-width: 150px; margin: 0 auto;">
                                    <input type="number" 
                                           class="form-control form-control-sm conteo-fisico-input" 
                                           data-codigo="{{ item.codigo }}" 
                                           data-atributo="{{ item.atributo|default:'sin' }}"
                                           value="{% if item.cantidad_contada is not None %}{{ item.cantidad_contada }}{% endif %}"
                                           placeholder="0"
                                           min="0"
                                           style="text-align: center;">
                                    <button class="btn btn-sm {% if item.cantidad_contada is not None %}btn-success{% else %}btn-outline-primary{% endif %} guardar-conteo-btn" 
                                            type="button"
                                            data-codigo="{{ item.codigo }}" 
                                            data-atributo="{{ item.atributo|default:'sin' }}"
                                            data-cantidad-guardada="{% if item.cantidad_contada is not None %}{{ item.cantidad_contada }}{% else %}0{% endif %}"
                                            title="{% if item.cantidad_contada is not None %}Conteo guardado: {{ item.cantidad_contada }}{% else %}Guardar conteo{% endif %}">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1" id="status-{{ item.codigo }}-{{ item.atributo|default:'sin' }}"></small>
                            </td>
                            <td>
                                {% if item.tiene_problemas %}
                                <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" data-bs-target="#analisis-{{ forloop.counter }}" aria-expanded="false">
                                    <i class="bi bi-exclamation-triangle"></i> Ver causas
                                </button>
                                {% else %}
                                <span class="text-muted small">✓ OK</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if item.tiene_problemas %}
                        <tr>
                            <td colspan="10" class="p-0">
                                <div class="collapse" id="analisis-{{ forloop.counter }}">
                                    <div class="card card-body bg-light border-warning m-2">
                                        <h6 class="text-warning mb-2"><i class="bi bi-exclamation-triangle"></i> Análisis de Inconsistencias</h6>
                                        
                                        {% if item.alertas %}
                                        <div class="mb-2">
                                            <strong>Alertas:</strong>
                                            <ul class="mb-0">
                                                {% for alerta in item.alertas %}
                                                <li>{{ alerta }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        {% if item.causas_negativos %}
                                        <div>
                                            <strong>Causas de valores negativos:</strong>
                                            <ul class="mb-0">
                                                {% for causa in item.causas_negativos %}
                                                <li>{{ causa }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        {% if item.neto < 0 %}
                                        <div class="mt-2">
                                            <strong>Explicación del Neto Negativo:</strong>
                                            <p class="mb-0 small">
                                                Neto = Entradas ({{ item.total_entradas }}) - Salidas ({{ item.total_salidas }}) + Ajustes ({{ item.ajustes }}) = {{ item.neto }}
                                                <br>
                                                {% if item.total_salidas > item.total_entradas %}
                                                Las salidas superan las entradas en {{ item.diferencia_salidas_entradas }} unidades.
                                                {% endif %}
                                                {% if item.ajustes < 0 %}
                                                Los ajustes negativos reducen el stock en {{ item.ajustes_abs }} unidades.
                                                {% endif %}
                                            </p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if item.stock_actual < 0 %}
                                        <div class="mt-2">
                                            <strong>Explicación del Stock Negativo:</strong>
                                            <p class="mb-0 small">
                                                El stock actual es negativo ({{ item.stock_actual }}), lo que indica una inconsistencia en el inventario.
                                                Esto puede deberse a:
                                                <ul class="mb-0">
                                                    <li>Ventas realizadas sin stock suficiente</li>
                                                    <li>Ajustes manuales incorrectos</li>
                                                    <li>Movimientos históricos no registrados correctamente</li>
                                                    <li>Eliminación de ingresos que ya tenían movimientos asociados</li>
                                                </ul>
                                            </p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">No hay productos con movimientos en este rango.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Comparativa: Ingresos vs Ventas vs Salidas de Mercancía -->
    <div class="card-modern mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> Comparativa: Ingresos vs Salidas (Ventas) vs Salidas de Mercancía</h5>
        </div>
        <div class="card-body">
            <!-- Cards de resumen general -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="stat-card success">
                        <div class="stat-card-label">
                            <i class="bi bi-arrow-down-circle"></i> Ingresos de Mercancía
                        </div>
                        <div class="stat-card-value">{{ total_ingresos_cantidad|intcomma }}</div>
                        <small class="text-muted">{{ total_ingresos_registros|intcomma }} registros</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card danger">
                        <div class="stat-card-label">
                            <i class="bi bi-cart-x"></i> Salidas por Ventas
                        </div>
                        <div class="stat-card-value">{{ total_ventas_cantidad|intcomma }}</div>
                        <small class="text-muted">{{ total_ventas_registros|intcomma }} items vendidos</small>
                        <div class="mt-2">
                            <strong class="text-muted">Valor: ${{ total_ventas_valor|intcomma }}</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card warning">
                        <div class="stat-card-label">
                            <i class="bi bi-box-arrow-up"></i> Salidas de Mercancía
                        </div>
                        <div class="stat-card-value">{{ total_salidas_cantidad|intcomma }}</div>
                        <small class="text-muted">{{ total_salidas_registros|intcomma }} registros</small>
                    </div>
                </div>
            </div>
            
            <!-- Balance Neto -->
            <div class="alert alert-{% if balance_neto_cantidad >= 0 %}success{% else %}danger{% endif %} mb-4">
                <h6 class="mb-2"><i class="bi bi-calculator"></i> Balance Neto</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>Ingresos</strong> - <strong>Ventas</strong> - <strong>Salidas</strong> = <strong>Balance</strong></span>
                    <span class="h4 mb-0">
                        {{ total_ingresos_cantidad|intcomma }} - {{ total_ventas_cantidad|intcomma }} - {{ total_salidas_cantidad|intcomma }} = 
                        <strong class="{% if balance_neto_cantidad >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ balance_neto_cantidad|intcomma }}
                        </strong>
                    </span>
                </div>
            </div>

            <!-- Tabla comparativa por producto -->
            {% if comparativa_por_producto %}
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Atributo</th>
                            <th class="text-end text-success">Ingresos</th>
                            <th class="text-end text-danger">Ventas (Cant.)</th>
                            <th class="text-end text-info">Ventas (Valor)</th>
                            <th class="text-end text-warning">Salidas Merc.</th>
                            <th class="text-end"><strong>Balance Neto</strong></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in comparativa_por_producto %}
                        <tr>
                            <td><strong>{{ item.codigo }}</strong></td>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.atributo }}</td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-success-modern">{{ item.ingresos_cantidad|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-danger-modern">{{ item.ventas_cantidad|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-info-modern">${{ item.ventas_valor|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge badge-modern badge-warning-modern">{{ item.salidas_cantidad|intcomma }}</span>
                            </td>
                            <td class="text-end">
                                <strong class="{% if item.balance_neto >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if item.balance_neto > 0 %}+{% endif %}{{ item.balance_neto|intcomma }}
                                </strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3" class="text-end"><strong>TOTALES:</strong></th>
                            <th class="text-end text-success">{{ total_ingresos_cantidad|intcomma }}</th>
                            <th class="text-end text-danger">{{ total_ventas_cantidad|intcomma }}</th>
                            <th class="text-end text-info">${{ total_ventas_valor|intcomma }}</th>
                            <th class="text-end text-warning">{{ total_salidas_cantidad|intcomma }}</th>
                            <th class="text-end">
                                <strong class="{% if balance_neto_cantidad >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if balance_neto_cantidad > 0 %}+{% endif %}{{ balance_neto_cantidad|intcomma }}
                                </strong>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Selecciona un rango de fechas para ver la comparativa por producto.
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formReporteInventario');
        const loadingBar = document.getElementById('loadingBar');
        const btnGenerar = document.getElementById('btnGenerarReporte');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                // Si el input de producto tiene texto pero no hay ID seleccionado, limpiar el campo
                const filtroProducto = document.getElementById('filtroProducto');
                const productoIdHidden = document.getElementById('producto_id_hidden');
                if (filtroProducto && productoIdHidden) {
                    if (filtroProducto.value.trim() && !productoIdHidden.value) {
                        // El usuario escribió algo pero no seleccionó de la lista, limpiar
                        productoIdHidden.value = '';
                    }
                }
                
                // Mostrar barra de carga
                if (loadingBar) {
                    loadingBar.style.display = 'block';
                }
                if (btnGenerar) {
                    btnGenerar.disabled = true;
                    btnGenerar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generando...';
                }
                
                // Scroll a la barra de carga
                if (loadingBar) {
                    loadingBar.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
        
        // Autocomplete para filtro de producto
        const filtroProducto = document.getElementById('filtroProducto');
        const productoIdHidden = document.getElementById('producto_id_hidden');
        const autocompleteWrapper = filtroProducto?.closest('.autocomplete-wrapper');
        const dropdown = autocompleteWrapper?.querySelector('.autocomplete-dropdown');
        
        if (filtroProducto && dropdown && productoIdHidden) {
            let searchTimeout;
            
            filtroProducto.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    productoIdHidden.value = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch(`{% url 'pos:buscar_productos' %}?q=${encodeURIComponent(query)}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.productos && data.productos.length > 0) {
                                dropdown.innerHTML = data.productos.map(p => {
                                    const codigoBarras = p.codigo_barras ? ` | Cód. Barras: ${p.codigo_barras}` : '';
                                    return `
                                    <div class="autocomplete-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;" 
                                         data-id="${p.id}" data-codigo="${p.codigo}" data-nombre="${p.nombre}">
                                        <strong>${p.nombre}</strong><br>
                                        <small style="color: #64748b;">Código: ${p.codigo}${codigoBarras} | Stock: ${parseInt(p.stock).toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</small>
                                    </div>
                                `;
                                }).join('');
                                
                                // Calcular posición del dropdown usando getBoundingClientRect
                                const inputRect = filtroProducto.getBoundingClientRect();
                                dropdown.style.display = 'block';
                                dropdown.style.position = 'fixed';
                                dropdown.style.top = (inputRect.bottom + window.scrollY) + 'px';
                                dropdown.style.left = (inputRect.left + window.scrollX) + 'px';
                                dropdown.style.width = inputRect.width + 'px';
                                dropdown.style.zIndex = '99999';
                                dropdown.style.backgroundColor = 'white';
                                
                                // Agregar eventos a los items
                                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                                    item.addEventListener('click', function() {
                                        const productoId = this.dataset.id;
                                        const productoCodigo = this.dataset.codigo;
                                        const productoNombre = this.dataset.nombre;
                                        
                                        filtroProducto.value = `${productoCodigo} - ${productoNombre}`;
                                        productoIdHidden.value = productoId;
                                        dropdown.style.display = 'none';
                                    });
                                    
                                    item.addEventListener('mouseenter', function() {
                                        this.style.background = '#f8fafc';
                                    });
                                    item.addEventListener('mouseleave', function() {
                                        this.style.background = 'white';
                                    });
                                });
                            } else {
                                dropdown.innerHTML = '<div style="padding: 0.5rem; color: #64748b;">No se encontraron productos</div>';
                                // Calcular posición del dropdown usando getBoundingClientRect
                                const inputRect = filtroProducto.getBoundingClientRect();
                                dropdown.style.display = 'block';
                                dropdown.style.position = 'fixed';
                                dropdown.style.top = (inputRect.bottom + window.scrollY) + 'px';
                                dropdown.style.left = (inputRect.left + window.scrollX) + 'px';
                                dropdown.style.width = inputRect.width + 'px';
                                dropdown.style.zIndex = '99999';
                                dropdown.style.backgroundColor = 'white';
                            }
                        })
                        .catch((error) => {
                            console.error('Error en autocomplete:', error);
                            dropdown.style.display = 'none';
                        });
                }, 300);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (filtroProducto && dropdown && 
                    !filtroProducto.contains(e.target) && 
                    !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            // Actualizar posición del dropdown al hacer scroll
            window.addEventListener('scroll', function() {
                if (dropdown.style.display === 'block' && filtroProducto) {
                    const inputRect = filtroProducto.getBoundingClientRect();
                    dropdown.style.top = (inputRect.bottom + window.scrollY) + 'px';
                    dropdown.style.left = (inputRect.left + window.scrollX) + 'px';
                }
            }, true);
            
            // Permitir limpiar el filtro
            filtroProducto.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
                if (e.key === 'Backspace' && this.value === '') {
                    productoIdHidden.value = '';
                }
            });
        }
        
        // Manejar guardado de conteos físicos
        // Usar delegación de eventos para asegurar que funcione incluso si el DOM cambia
        document.addEventListener('click', function(e) {
            // Verificar si el clic fue en un botón de guardar conteo o en su icono
            let btn = null;
            if (e.target && typeof e.target.closest === 'function') {
                btn = e.target.closest('.guardar-conteo-btn');
            }
            // Si no se encontró, intentar con el target directamente
            if (!btn && e.target && e.target.classList && e.target.classList.contains('guardar-conteo-btn')) {
                btn = e.target;
            }
            // Si aún no se encontró, intentar con el parentElement
            if (!btn && e.target && e.target.parentElement && e.target.parentElement.classList && e.target.parentElement.classList.contains('guardar-conteo-btn')) {
                btn = e.target.parentElement;
            }
            if (!btn) return;
            
            // Prevenir múltiples clics
            if (btn.disabled) return;
            
            // Prevenir propagación para evitar doble ejecución
            e.stopPropagation();
            
            const codigo = btn.dataset.codigo;
            let atributo = btn.dataset.atributo || '';
            // Normalizar atributo vacío o '-' a 'sin' para coincidir con el template
            if (!atributo || atributo === '-' || atributo === 'None' || atributo === 'null') {
                atributo = 'sin';
            }
            const input = btn.closest('.input-group').querySelector('.conteo-fisico-input');
            if (!input) {
                console.error('No se encontró el input para el botón', btn);
                return;
            }
            // Obtener el valor del input - puede ser string vacío, "0", o cualquier número
            let cantidad = input.value;
            // Si es null o undefined, usar cadena vacía
            if (cantidad === null || cantidad === undefined) {
                cantidad = '';
            }
            // Trim para eliminar espacios y convertir a string
            cantidad = cantidad.toString().trim();
            console.log('Valor del input:', { raw: input.value, trimmed: cantidad, type: typeof cantidad });
            
            // Obtener elemento de estado (el template usa 'sin' cuando atributo está vacío)
            const statusId = `status-${codigo}-${atributo}`;
            const statusEl = document.getElementById(statusId);
            
            // Para enviar al servidor, convertir 'sin' de vuelta a cadena vacía
            const atributoParaEnviar = atributo === 'sin' ? '' : atributo;
            
            // Validar cantidad - permitir 0 y valores vacíos (se tratarán como 0)
            let cantidadNum;
            // Si está vacío o es null/undefined, interpretar como 0
            if (cantidad === '' || cantidad === null || cantidad === undefined) {
                cantidadNum = 0;
            } else {
                // Convertir a número - usar parseFloat primero para manejar decimales, luego parseInt
                const parsed = parseFloat(cantidad);
                // Verificar si es NaN (no es un número válido)
                if (isNaN(parsed)) {
                    if (statusEl) {
                        statusEl.textContent = '⚠️ La cantidad debe ser un número';
                        statusEl.style.color = '#dc3545';
                    }
                    return;
                }
                // Convertir a entero (redondear hacia abajo)
                cantidadNum = Math.floor(parsed);
            }
            
            // cantidadNum ahora puede ser 0, negativo, o positivo - todos son válidos
            console.log('Guardando conteo:', { codigo, atributo: atributoParaEnviar, cantidad: cantidadNum, cantidadOriginal: cantidad });
            
            // Deshabilitar botón mientras se guarda
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            if (statusEl) {
                statusEl.textContent = 'Guardando...';
                statusEl.style.color = '#6c757d';
            }
            
            // Preparar datos para enviar
            const formData = new FormData();
            formData.append('codigo', codigo);
            formData.append('atributo', atributoParaEnviar);
            // Asegurar que se envíe como string para que el backend lo reciba correctamente
            formData.append('cantidad', cantidadNum.toString());
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            console.log('Enviando datos:', { codigo, atributo: atributoParaEnviar, cantidad: cantidadNum.toString() });
            
            // Enviar petición AJAX
            fetch('{% url "pos:guardar_conteo_fisico" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    // Intentar obtener el mensaje de error del JSON
                    return response.json().then(data => {
                        throw new Error(data.error || `Error HTTP ${response.status}`);
                    }).catch(() => {
                        // Si no se puede parsear JSON, lanzar error genérico
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta del servidor:', data);
                console.log('Comparación:', { 
                    dataCantidad: data.cantidad, 
                    cantidadNum: cantidadNum, 
                    tipoDataCantidad: typeof data.cantidad,
                    tipoCantidadNum: typeof cantidadNum,
                    iguales: data.cantidad == cantidadNum,
                    estrictamenteIguales: data.cantidad === cantidadNum
                });
                if (data.success) {
                    // Verificar que realmente se guardó (la respuesta confirma el guardado)
                    // IMPORTANTE: Usar == en lugar de === para comparar, ya que data.cantidad puede venir como string o número
                    // También verificar que no sea undefined o null
                    const cantidadRecibida = data.cantidad;
                    const cantidadEnviada = cantidadNum;
                    
                    // Comparación flexible: permite comparar string "0" con número 0
                    if (cantidadRecibida !== undefined && cantidadRecibida !== null && 
                        (cantidadRecibida == cantidadEnviada || 
                         parseInt(cantidadRecibida) === cantidadEnviada ||
                         cantidadRecibida === cantidadEnviada.toString())) {
                        // Cambiar botón a verde con fondo (btn-success)
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                        
                        // Actualizar el atributo data-cantidad-guardada
                        btn.setAttribute('data-cantidad-guardada', cantidadNum.toString());
                        
                        // Actualizar el título del botón
                        btn.setAttribute('title', `Conteo guardado: ${cantidadNum}`);
                        
                        if (statusEl) {
                            statusEl.textContent = '✓ Guardado correctamente';
                            statusEl.style.color = '#28a745';
                        }
                        
                        // Mostrar notificación de éxito
                        if (window.showNotification) {
                            const mensaje = `Conteo físico guardado: ${codigo}${atributoParaEnviar ? ' (' + atributoParaEnviar + ')' : ''} - Cantidad: ${cantidadNum}`;
                            window.showNotification(
                                mensaje,
                                'success',
                                'Conteo Guardado',
                                4000
                            );
                        }
                    } else {
                        // Si la cantidad no coincide, mostrar advertencia
                        console.warn('La cantidad guardada no coincide con la enviada');
                        if (statusEl) {
                            statusEl.textContent = '⚠️ Guardado pero cantidad diferente';
                            statusEl.style.color = '#ffc107';
                        }
                    }
                    
                    // Restaurar botón
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    
                    // Limpiar mensaje después de 3 segundos
                    setTimeout(() => {
                        if (statusEl) {
                            statusEl.textContent = '';
                        }
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error al guardar conteo:', error);
                if (statusEl) {
                    statusEl.textContent = '✗ Error: ' + error.message;
                    statusEl.style.color = '#dc3545';
                }
                
                // Mostrar notificación de error
                if (window.showNotification) {
                    window.showNotification(
                        `Error al guardar conteo: ${error.message}`,
                        'error',
                        'Error al Guardar',
                        5000
                    );
                }
                
                // Restaurar botón
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        });
        
        // Permitir guardar con Enter en el input y verificar cambios
        const conteoInputs = document.querySelectorAll('.conteo-fisico-input');
        conteoInputs.forEach(input => {
            // Verificar si el valor cambió respecto al guardado
            input.addEventListener('input', function() {
                const inputEl = this; // Guardar referencia al input
                if (!inputEl || typeof inputEl.closest !== 'function') {
                    console.error('Input no válido o no tiene método closest');
                    return;
                }
                const inputGroup = inputEl.closest('.input-group');
                if (!inputGroup) {
                    console.error('No se encontró el input-group');
                    return;
                }
                const btn = inputGroup.querySelector('.guardar-conteo-btn');
                if (btn) {
                    const cantidadGuardada = parseInt(btn.getAttribute('data-cantidad-guardada') || '0');
                    const cantidadActual = parseInt(inputEl.value) || 0;
                    
                    // Si el valor actual es diferente al guardado, cambiar botón a azul
                    if (cantidadActual !== cantidadGuardada) {
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                        btn.setAttribute('title', 'Guardar conteo');
                    } else {
                        // Si coincide con el guardado (incluyendo 0), mantener verde
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                        btn.setAttribute('title', `Conteo guardado: ${cantidadGuardada}`);
                    }
                }
            });
            
            // Permitir guardar con Enter
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputEl = this; // Guardar referencia al input
                    if (!inputEl || typeof inputEl.closest !== 'function') {
                        console.error('Input no válido o no tiene método closest');
                        return;
                    }
                    const inputGroup = inputEl.closest('.input-group');
                    if (!inputGroup) {
                        console.error('No se encontró el input-group');
                        return;
                    }
                    const btn = inputGroup.querySelector('.guardar-conteo-btn');
                    if (btn) {
                        btn.click();
                    }
                }
            });
        });
    });
    </script>
    {% else %}
    <div class="card-modern mt-2">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Reporte de Caja</h5>
            <a href="{% url 'pos:reportes' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a Selección
            </a>
        </div>
    </div>
    <div class="card-modern mt-2">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtro</h5>
        </div>
        <div class="card-body">
            <form method="get">
                <input type="hidden" name="tipo" value="caja">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Desde</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_desde" value="{{ fecha_desde|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Hasta</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_hasta" value="{{ fecha_hasta|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary-pos w-100">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
            <div class="mt-3 d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-outline-primary"
                   href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&export=movimientos_caja">
                    <i class="bi bi-download"></i> CSV Movimientos (Caja)
                </a>
                <a class="btn btn-sm btn-outline-success"
                   href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&export=movimientos_caja&format=xlsx">
                    <i class="bi bi-file-earmark-excel"></i> Excel Movimientos (Caja)
                </a>
                <span class="text-muted" style="align-self:center;">
                    Rango: <strong>{{ fecha_desde|date:"d/m/Y" }}</strong> a <strong>{{ fecha_hasta|date:"d/m/Y" }}</strong>
                </span>
            </div>
        </div>
    </div>

    {% if not modo_simple %}
    <div class="cards-grid">
        <div class="stat-card success">
            <div class="stat-card-label">
                <i class="bi bi-currency-dollar"></i> Total Ventas (válidas)
            </div>
            <div class="stat-card-value">${{ total_ventas|intcomma }}</div>
        </div>
        <div class="stat-card primary">
            <div class="stat-card-label">
                <i class="bi bi-receipt"></i> Ventas (válidas)
            </div>
            <div class="stat-card-value">{{ cantidad_ventas|intcomma }}</div>
        </div>
        <div class="stat-card info">
            <div class="stat-card-label">
                <i class="bi bi-graph-up-arrow"></i> Promedio por Venta
            </div>
            <div class="stat-card-value">${{ promedio_venta|intcomma }}</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-card-label">
                <i class="bi bi-x-circle"></i> Anuladas
            </div>
            <div class="stat-card-value">{{ cantidad_anuladas|intcomma }}</div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Top productos (por cantidad)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_productos %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.producto__nombre }}</td>
                                    <td><span class="badge badge-modern badge-success-modern">{{ item.total_vendido|intcomma }}</span></td>
                                    <td><strong>${{ item.total_valor|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ventas por método (válidas)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">
                            Efectivo: <strong>${{ ventas_efectivo|intcomma }}</strong> |
                            Tarjeta: <strong>${{ ventas_tarjeta|intcomma }}</strong> |
                            Transferencia: <strong>${{ ventas_transferencia|intcomma }}</strong> |
                            Bancos: <strong>${{ dinero_bancos|intcomma }}</strong>
                        </small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Método</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metodo in ventas_por_metodo %}
                                <tr>
                                    <td>{{ metodo.metodo_pago|capfirst }}</td>
                                    <td>{{ metodo.cantidad|intcomma }}</td>
                                    <td><strong>${{ metodo.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4 g-4">
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Totales de ventas por día</h5>
                    <small class="text-muted">Ventas completadas (válidas) y anuladas</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    {% if modo_simple %}
                                    <th>Día</th>
                                    <th>Ventas OK</th>
                                    <th>Anuladas</th>
                                    <th>Efectivo</th>
                                    <th>Transferencia</th>
                                    <th>Tarjeta</th>
                                    {% else %}
                                    <th>Día</th>
                                    <th>Saldo inicial</th>
                                    <th>Ventas OK</th>
                                    <th>Anuladas</th>
                                    <th>Efectivo</th>
                                    <th>Tarjeta</th>
                                    <th>Transferencia</th>
                                    <th>Gastos (sin retiro)</th>
                                    <th>Ingresos</th>
                                    <th>Retiros</th>
                                    <th>Neto operativo</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in resumen_diario %}
                                <tr>
                                    {% if modo_simple %}
                                    <td><strong>{{ d.dia|date:"d/m/Y" }}</strong></td>
                                    <td><strong>${{ d.ventas_total|intcomma }}</strong> ({{ d.ventas_cantidad|intcomma }})</td>
                                    <td>${{ d.anuladas_total|intcomma }} ({{ d.anuladas_cantidad|intcomma }})</td>
                                    <td>${{ d.ventas_efectivo|intcomma }}</td>
                                    <td>${{ d.ventas_transferencia|intcomma }}</td>
                                    <td>${{ d.ventas_tarjeta|intcomma }}</td>
                                    {% else %}
                                    <td><strong>{{ d.dia|date:"d/m/Y" }}</strong></td>
                                    <td>${{ d.saldo_inicial|intcomma }}</td>
                                    <td>${{ d.ventas_total|intcomma }} ({{ d.ventas_cantidad|intcomma }})</td>
                                    <td>${{ d.anuladas_total|intcomma }} ({{ d.anuladas_cantidad|intcomma }})</td>
                                    <td>${{ d.ventas_efectivo|intcomma }}</td>
                                    <td>${{ d.ventas_tarjeta|intcomma }}</td>
                                    <td>${{ d.ventas_transferencia|intcomma }}</td>
                                    <td>${{ d.gastos_sin_retiro_total|intcomma }} ({{ d.gastos_sin_retiro_cantidad|intcomma }})</td>
                                    <td>${{ d.ingresos_total|intcomma }} ({{ d.ingresos_cantidad|intcomma }})</td>
                                    <td>${{ d.retiros_total|intcomma }} ({{ d.retiros_cantidad|intcomma }})</td>
                                    <td><strong>${{ d.neto_operativo|intcomma }}</strong></td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    {% if modo_simple %}
                                    <td colspan="6" class="text-center text-muted">No hay ventas en este rango.</td>
                                    {% else %}
                                    <td colspan="11" class="text-center text-muted">No hay datos diarios en este rango.</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        {% if not modo_simple %}
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Resumen por usuario (cajero)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in resumen_por_usuario %}
                                <tr>
                                    <td>{{ r.usuario__username|default:"-" }}</td>
                                    <td><span class="badge badge-modern badge-info-modern">{{ r.cantidad|intcomma }}</span></td>
                                    <td><strong>${{ r.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Resumen por vendedor</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Vendedor</th>
                                    <th>Cantidad</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in resumen_por_vendedor %}
                                <tr>
                                    <td>{{ r.vendedor__username|default:"-" }}</td>
                                    <td><span class="badge badge-modern badge-info-modern">{{ r.cantidad|intcomma }}</span></td>
                                    <td><strong>${{ r.total|intcomma }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Ventas (detalle)</h5>
                    <small class="text-muted">Incluye anuladas (marcadas) + detalle de ítems</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Método</th>
                                    <th>Total</th>
                                    <th>Items</th>
                                    <th>Usuario</th>
                                    <th>Vendedor</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in ventas_detalle %}
                                <tr>
                                    <td>{{ v.id }}</td>
                                    <td>{{ v.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ v.get_metodo_pago_display }}</td>
                                    <td><strong>${{ v.total|intcomma }}</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#itemsVenta{{ v.id }}"
                                                aria-expanded="false"
                                                aria-controls="itemsVenta{{ v.id }}">
                                            <i class="bi bi-list-ul"></i> Ver ({{ v.items.all|length }})
                                        </button>
                                    </td>
                                    <td>{{ v.usuario.username|default:"-" }}</td>
                                    <td>{{ v.vendedor.username|default:"-" }}</td>
                                    <td>
                                        {% if v.anulada %}
                                        <span class="badge badge-modern badge-danger-modern">Anulada</span>
                                        {% else %}
                                        <span class="badge badge-modern badge-success-modern">OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary" href="{% url 'pos:detalle_venta' v.id %}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr class="collapse" id="itemsVenta{{ v.id }}">
                                    <td colspan="9">
                                        <div class="p-2">
                                            <div class="table-responsive">
                                                <table class="table table-sm mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Producto</th>
                                                            <th>Cantidad</th>
                                                            <th>Precio</th>
                                                            <th>Subtotal</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for it in v.items.all %}
                                                        <tr>
                                                            <td>{{ it.producto.nombre }}</td>
                                                            <td>{{ it.cantidad|intcomma }}</td>
                                                            <td>${{ it.precio_unitario|intcomma }}</td>
                                                            <td><strong>${{ it.subtotal|intcomma }}</strong></td>
                                                        </tr>
                                                        {% empty %}
                                                        <tr>
                                                            <td colspan="4" class="text-center text-muted">Sin ítems</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No hay ventas en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if ventas_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación ventas">
                        <ul class="pagination pagination-sm mb-0">
                            {% if ventas_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_ventas={{ ventas_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ ventas_detalle.number }} de {{ ventas_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if ventas_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_ventas={{ ventas_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-12">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Movimientos de Caja (estilo Caja)</h5>
                    <small class="text-muted">
                        Rango seleccionado (todas)
                    </small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Saldo Antes</th>
                                    <th>Saldo Después</th>
                                    <th>Método de Pago</th>
                                    <th>Usuario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in movimientos_caja_detalle %}
                                <tr>
                                    <td>{{ m.fecha_local|date:"d/m/Y H:i" }}</td>
                                    <td>{{ m.tipo }}</td>
                                    <td style="max-width: 520px;">{{ m.descripcion }}</td>
                                    <td><strong>{% if m.delta >= 0 %}+{% endif %}${{ m.delta|intcomma }}</strong></td>
                                    <td>${{ m.saldo_antes|intcomma }}</td>
                                    <td><strong>${{ m.saldo_despues|intcomma }}</strong></td>
                                    <td>{{ m.metodo_pago|default:"-" }}</td>
                                    <td>{{ m.usuario|default:"-" }}</td>
                                    <td>
                                        {% if m.venta_id %}
                                        <a class="btn btn-sm btn-outline-primary" href="{% url 'pos:detalle_venta' m.venta_id %}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No hay movimientos para este filtro.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if movimientos_caja_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación movimientos caja">
                        <ul class="pagination pagination-sm mb-0">
                            {% if movimientos_caja_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs_caja={{ movimientos_caja_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ movimientos_caja_detalle.number }} de {{ movimientos_caja_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if movimientos_caja_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs_caja={{ movimientos_caja_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Movimientos de caja (gastos/ingresos/retiros)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">
                            Gastos (sin retiros): <strong>${{ total_gastos|intcomma }}</strong> |
                            Ingresos: <strong>${{ total_ingresos|intcomma }}</strong> |
                            Retiros: <strong>${{ total_retiros|intcomma }}</strong>
                        </small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Usuario</th>
                                    <th>Caja</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in movimientos_detalle %}
                                <tr>
                                    <td>{{ m.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ m.tipo|capfirst }}</td>
                                    <td>{{ m.descripcion }}</td>
                                    <td><strong>${{ m.monto|intcomma }}</strong></td>
                                    <td>{{ m.usuario.username }}</td>
                                    <td>{{ m.caja_usuario_id|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No hay movimientos en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if movimientos_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación movimientos">
                        <ul class="pagination pagination-sm mb-0">
                            {% if movimientos_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs={{ movimientos_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ movimientos_detalle.number }} de {{ movimientos_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if movimientos_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_movs={{ movimientos_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Cajas (aperturas/cierres)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Apertura</th>
                                    <th>Cierre</th>
                                    <th>Inicial</th>
                                    <th>Final</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in cajas_detalle %}
                                <tr>
                                    <td>{{ c.id }}</td>
                                    <td>{{ c.fecha_apertura|date:"d/m/Y H:i" }}</td>
                                    <td>{% if c.fecha_cierre %}{{ c.fecha_cierre|date:"d/m/Y H:i" }}{% else %}<span class="badge badge-modern badge-success-modern">Abierta</span>{% endif %}</td>
                                    <td>${{ c.monto_inicial|intcomma }}</td>
                                    <td>{% if c.monto_final is not None %}${{ c.monto_final|intcomma }}{% else %}-{% endif %}</td>
                                    <td>{{ c.usuario.username }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No hay cajas en este rango.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if cajas_detalle.paginator.num_pages > 1 %}
                    <nav class="mt-3" aria-label="Paginación cajas">
                        <ul class="pagination pagination-sm mb-0">
                            {% if cajas_detalle.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_cajas={{ cajas_detalle.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}
                            <li class="page-item disabled">
                                <span class="page-link">Página {{ cajas_detalle.number }} de {{ cajas_detalle.paginator.num_pages }}</span>
                            </li>
                            {% if cajas_detalle.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tipo=caja&fecha_desde={{ fecha_desde|date:'Y-m-d' }}&fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&page_cajas={{ cajas_detalle.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

