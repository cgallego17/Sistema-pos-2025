<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema POS{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Navegación superior */
        .top-nav {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 0.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
        }
        
        .nav-item {
            flex: 0 0 auto;
        }
        
        .nav-link-custom {
            display: inline-block;
            padding: 0.5rem 1rem;
            color: #667eea;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.2s;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .nav-link-custom:hover,
        .nav-link-custom.active {
            background: #f0f0f0;
        }
        
        .nav-link-custom i {
            margin-right: 6px;
            font-size: 16px;
        }
        
        /* Contenedor principal */
        .main-container {
            padding: 0;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ============================================
           SISTEMA DE NOTIFICACIONES
           ============================================ */
        .notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 400px;
            width: 100%;
            pointer-events: none;
        }
        
        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            pointer-events: auto;
            position: relative;
            overflow: hidden;
            border-left: 4px solid;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 400px;
            min-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.error {
            border-left-color: #ef4444;
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
        }
        
        .notification.info {
            border-left-color: #3b82f6;
        }
        
        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        
        .notification.success .notification-icon {
            color: #10b981;
        }
        
        .notification.error .notification-icon {
            color: #ef4444;
        }
        
        .notification.warning .notification-icon {
            color: #f59e0b;
        }
        
        .notification.info .notification-icon {
            color: #3b82f6;
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        
        .notification-close:hover {
            color: #64748b;
        }
        
        .notification.hiding {
            transform: translateX(400px);
            opacity: 0;
        }
        
        /* Sidebar de vendedor */
        .sidebar-vendedor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-vendedor-overlay.active {
            display: block;
            opacity: 1;
        }
        
        .sidebar-vendedor {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-vendedor.active {
            right: 0;
        }
        
        .sidebar-vendedor-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-vendedor-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .sidebar-vendedor-cerrar {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        
        .sidebar-vendedor-cerrar:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar-vendedor-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .sidebar-vendedor-loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .usuario-btn {
            width: 100%;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .usuario-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(4px);
        }
        
        .usuario-btn.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        
        .usuario-btn-nombre {
            font-weight: 700;
            font-size: 1rem;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .usuario-btn-username {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .usuario-btn-email {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }
        
        .metodo-pago-label,
        .vendedor-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.4rem;
        }
        
        /* ============================================
           ESTILOS GLOBALES DEL SISTEMA
           ============================================ */
        
        /* Cards modernos */
        .card-modern {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: none;
            overflow: hidden;
        }
        
        .card-modern .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            border: none;
            font-weight: 600;
        }
        
        .card-modern .card-body {
            padding: 1rem;
        }
        
        /* Botones con estilo POS */
        .btn-primary-pos {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .btn-primary-pos:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            color: white;
        }
        
        .btn-success-pos {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        
        .btn-success-pos:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            color: white;
        }
        
        .btn-danger-pos {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        
        .btn-danger-pos:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            color: white;
        }
        
        /* Inputs modernos */
        .form-control-modern {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: #f8fafc;
        }
        
        .form-control-modern:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Tablas modernas */
        .table-modern {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .table-modern thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .table-modern thead th {
            border: none;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .table-modern tbody tr {
            transition: all 0.2s ease;
        }
        
        .table-modern tbody tr:hover {
            background: #f8fafc;
            transform: translateX(2px);
        }
        
        .table-modern tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        /* Badges modernos */
        .badge-modern {
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .badge-success-modern {
            background: #d1fae5;
            color: #059669;
        }
        
        .badge-danger-modern {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-warning-modern {
            background: #fef3c7;
            color: #d97706;
        }
        
        .badge-info-modern {
            background: #dbeafe;
            color: #2563eb;
        }
        
        /* Contenedor de página */
        .page-container {
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }
        
        /* Grid de cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border-left: 4px solid;
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card.primary {
            border-left-color: #667eea;
        }
        
        .stat-card.success {
            border-left-color: #10b981;
        }
        
        .stat-card.warning {
            border-left-color: #f59e0b;
        }
        
        .stat-card.danger {
            border-left-color: #ef4444;
        }
        
        .stat-card.info {
            border-left-color: #3b82f6;
        }
        
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Formularios modernos */
        .form-group-modern {
            margin-bottom: 1rem;
        }
        
        .form-label-modern {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        /* Override Bootstrap para mantener consistencia */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transform: translateY(-2px);
            color: white;
        }
        
        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            padding: 0.75rem 1rem;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .table thead th {
            border: none;
            font-weight: 600;
        }
        
        .table tbody tr {
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        /* Cards de productos */
        .product-card {
            background: white;
            border-radius: 4px;
            padding: 10px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
            height: 100%;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .product-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transform: translateY(-1px);
            border-color: #bdbdbd;
        }
        
        .product-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin: 0 auto 8px;
            display: block;
            background: #fafafa;
            border-radius: 3px;
            padding: 4px;
        }
        
        .product-name {
            font-size: 11px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 6px;
            min-height: 28px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        
        .product-price {
            font-size: 15px;
            font-weight: 700;
            color: #6f42c1;
            margin-bottom: 4px;
        }
        
        .product-stock {
            font-size: 10px;
            color: #198754;
            background: #d1e7dd;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .product-code {
            font-size: 9px;
            color: #9e9e9e;
            margin-top: 2px;
        }
        
        .fire-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #ff6b00;
            font-size: 18px;
            z-index: 1;
        }
        
        /* Panel lateral del carrito */
        .cart-panel {
            background: white;
            border-radius: 6px;
            padding: 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .cart-header {
            background: #6f42c1;
            color: white;
            padding: 14px 16px;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .cart-header .badge {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 0;
            padding: 16px;
        }
        
        .cart-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
            font-size: 13px;
        }
        
        .cart-item .btn-group-sm .btn {
            padding: 2px 8px;
            font-size: 12px;
        }
        
        .cart-footer {
            border-top: 1px solid #e0e0e0;
            padding: 16px;
            background: #fafafa;
        }
        
        .total-display {
            font-size: 28px;
            font-weight: 700;
            color: #6f42c1;
            text-align: right;
            line-height: 1.2;
        }
        
        .btn-process {
            background: #007bff;
            border: none;
            color: white;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            width: 100%;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .btn-process:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        
        /* Búsqueda */
        .search-box {
            background: white;
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #dee2e6;
        }
        
        .search-input {
            border: 1.5px solid #ced4da;
            border-radius: 5px;
            padding: 10px 12px;
            font-size: 13px;
            width: 100%;
        }
        
        .search-input:focus {
            border-color: #6f42c1;
            box-shadow: 0 0 0 0.15rem rgba(111,66,193,.15);
            outline: none;
        }
        
        /* Método de pago */
        .payment-method {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .payment-btn {
            flex: 1;
            padding: 8px 4px;
            border: 1.5px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
            text-align: center;
        }
        
        .payment-btn i {
            font-size: 16px;
            display: block;
            margin-bottom: 4px;
        }
        
        .payment-btn.active {
            border-color: #007bff;
            background: #e7f3ff;
            color: #007bff;
        }
        
        .payment-btn:hover:not(.active) {
            border-color: #adb5bd;
            background: #f8f9fa;
        }
        
        .form-select-sm {
            font-size: 13px;
            padding: 6px 10px;
        }
        
        .input-group-sm .form-control {
            font-size: 13px;
        }
        
        .input-group-sm .input-group-text {
            font-size: 13px;
        }
        
        /* Grid de productos - 5 columnas por defecto */
        .productosGrid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .productosGrid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .productosGrid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 992px) {
            .productosGrid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                overflow-x: auto;
            }
            
            .cart-panel {
                position: relative;
                height: auto;
                margin-top: 20px;
            }
            
            .productosGrid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .productosGrid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% load humanize %}
    {% if user.is_authenticated %}
    <!-- Navegación Superior -->
    <nav class="top-nav">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="{% url 'pos:home' %}" class="nav-link-custom {% if request.path == '/' %}active{% endif %}">
                    <i class="bi bi-grid-fill"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:vender' %}" class="nav-link-custom {% if 'vender' in request.path %}active{% endif %}">
                    <i class="bi bi-cart-fill"></i> POS
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:productos' %}" class="nav-link-custom {% if 'productos' in request.path %}active{% endif %}">
                    <i class="bi bi-box-seam-fill"></i> Productos
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:inventario' %}" class="nav-link-custom {% if 'inventario' in request.path or 'ingreso-mercancia' in request.path or 'salida-mercancia' in request.path %}active{% endif %}">
                    <i class="bi bi-box-seam-fill"></i> Inventario
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:caja' %}" class="nav-link-custom {% if 'caja' in request.path and 'caja-gastos' not in request.path %}active{% endif %}">
                    <i class="bi bi-cash-stack"></i> Caja
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:lista_ventas' %}" class="nav-link-custom {% if 'ventas' in request.path or 'historial' in request.path %}active{% endif %}">
                    <i class="bi bi-clock-history"></i> Historial
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:marketing' %}" class="nav-link-custom {% if 'marketing' in request.path %}active{% endif %}">
                    <i class="bi bi-megaphone-fill"></i> Marketing
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:formulario_clientes' %}" class="nav-link-custom {% if 'formulario-clientes' in request.path %}active{% endif %}">
                    <i class="bi bi-file-earmark-text-fill"></i> Formulario Clientes
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'pos:clientes_potenciales' %}" class="nav-link-custom {% if 'clientes-potenciales' in request.path %}active{% endif %}">
                    <i class="bi bi-people-fill"></i> Clientes Potenciales
                </a>
            </li>
            {% if user.is_staff %}
            <li class="nav-item">
                <a href="{% url 'pos:usuarios' %}" class="nav-link-custom {% if 'usuarios' in request.path %}active{% endif %}">
                    <i class="bi bi-person-fill"></i> Usuarios
                </a>
            </li>
            {% endif %}
            <li class="nav-item ms-auto">
                <a href="{% url 'pos:logout' %}" class="nav-link-custom text-danger">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Contenido Principal -->
    <div class="main-container">
        {% block content %}{% endblock %}
    </div>
    {% else %}
    <div class="container">
        {% block full_content %}{% endblock %}
    </div>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- Sistema de Notificaciones -->
    <div class="notifications-container" id="notifications-container"></div>
    
    <script>
        // ============================================
        // SISTEMA DE NOTIFICACIONES FLOTANTES
        // ============================================
        // Esperar a que el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            const notificationsContainer = document.getElementById('notifications-container');
            if (!notificationsContainer) {
                console.error('Contenedor de notificaciones no encontrado');
                return;
            }
            
            let notificationIdCounter = 0;
            
            // Mapeo de tags de Django a tipos de notificación
            const djangoTagMap = {
                'success': 'success',
                'error': 'error',
                'danger': 'error',
                'warning': 'warning',
                'info': 'info',
                'debug': 'info'
            };
            
            // Definir showNotification
            window.showNotification = function(message, type = 'info', title = null, duration = 4000) {
                if (!notificationsContainer) {
                    console.error('Contenedor de notificaciones no disponible');
                    return null;
                }
                
                const notificationId = 'notification-' + (++notificationIdCounter);
                const icons = {
                    success: '✓',
                    error: '✕',
                    warning: '⚠',
                    info: 'ℹ'
                };
                
                const notification = document.createElement('div');
                notification.id = notificationId;
                notification.className = `notification ${type}`;
                
                const icon = icons[type] || icons.info;
                
                notification.innerHTML = `
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-content">
                        ${title ? `<div class="notification-title">${title}</div>` : ''}
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="closeNotification('${notificationId}')" title="Cerrar">×</button>
                `;
                
                notificationsContainer.appendChild(notification);
                
                // Animación de entrada
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                if (duration > 0) {
                    setTimeout(() => {
                        closeNotification(notificationId);
                    }, duration);
                }
                
                return notificationId;
            };
            
            window.closeNotification = function(notificationId) {
                const notification = document.getElementById(notificationId);
                if (notification) {
                    notification.classList.add('hiding');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            };
            
            // Convertir mensajes de Django a notificaciones flotantes
            {% if messages %}
            {% for message in messages %}
            (function() {
                const tag = '{{ message.tags|default:"info" }}';
                const messageType = djangoTagMap[tag] || 'info';
                setTimeout(function() {
                    showNotification(
                        '{{ message|escapejs }}',
                        messageType,
                        null,
                        5000
                    );
                }, 100);
            })();
            {% endfor %}
            {% endif %}
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

{% extends 'pos/base.html' %}

{% block title %}Gestión de Caja - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-cash-stack"></i> Gestión de Caja</h1>
    </div>

    <div class="row">
        <div class="col-md-8">
            {% if caja_abierta %}
            <div class="card-modern">
                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Caja Abierta</h5>
                </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p style="margin-bottom: 0.75rem;"><strong>Caja:</strong> {{ caja_abierta.caja }}</p>
                        <p style="margin-bottom: 0.75rem;"><strong>Fecha Apertura:</strong> {{ caja_abierta.fecha_apertura|date:"d/m/Y H:i" }}</p>
                        <p style="margin-bottom: 0;"><strong>Monto Inicial:</strong> ${{ caja_abierta.monto_inicial|intcomma }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card success">
                            <div class="stat-card-label">
                                <i class="bi bi-currency-dollar"></i> Total Ventas
                            </div>
                            <div class="stat-card-value">${{ total_ventas|intcomma }}</div>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 1.5rem 0; border-color: #e2e8f0;">
                
                <h5 style="margin-bottom: 1rem; font-weight: 600;">Ventas de Hoy</h5>
                <div class="table-responsive">
                    <table class="table-modern table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Hora</th>
                                <th>Total</th>
                                <th>Método</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas_caja %}
                            <tr>
                                <td>{{ venta.id }}</td>
                                <td>{{ venta.fecha|date:"H:i" }}</td>
                                <td>${{ venta.total|intcomma }}</td>
                                <td><span class="badge badge-modern badge-info-modern">{{ venta.get_metodo_pago_display }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay ventas en esta caja</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
            {% else %}
            <div class="card-modern">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Sin Caja Abierta</h5>
                </div>
                <div class="card-body text-center">
                    <p style="color: #64748b; margin-bottom: 1.5rem;">No tienes una caja abierta. Debes abrir una caja para comenzar a vender.</p>
                    <button class="btn btn-primary-pos btn-lg" data-bs-toggle="modal" data-bs-target="#abrirCajaModal">
                        <i class="bi bi-box-arrow-in-down"></i> Abrir Caja
                    </button>
                </div>
            </div>
            {% endif %}
    </div>
    
        <div class="col-md-4">
            {% if caja_abierta %}
            <div class="card-modern">
                <div class="card-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <h5 class="mb-0">Cerrar Caja</h5>
                </div>
                <div class="card-body">
                    <p style="color: #64748b; margin-bottom: 1rem;">Al cerrar la caja, se registrará el monto final y no podrás realizar más ventas con esta caja.</p>
                    <form method="post" action="{% url 'pos:cerrar_caja' %}">
                        {% csrf_token %}
                        <div class="form-group-modern">
                            <label class="form-label-modern">Monto Final en Caja</label>
                            <input type="number" class="form-control form-control-modern" name="monto_final" step="100" required>
                            <small style="color: #94a3b8; font-size: 0.8rem;">Monto total contado físicamente</small>
                        </div>
                        <button type="submit" class="btn btn-danger-pos w-100">
                            <i class="bi bi-x-circle"></i> Cerrar Caja
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <div class="card-modern mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Historial de Cajas</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for caja in historial_cajas %}
                    <div style="border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; margin-bottom: 0.75rem;">
                        <strong style="font-size: 0.95rem;">{{ caja.caja }}</strong><br>
                        <small style="color: #64748b;">{{ caja.fecha_apertura|date:"d/m/Y H:i" }}</small><br>
                        {% if caja.fecha_cierre %}
                        <span class="badge badge-modern" style="background: #e2e8f0; color: #64748b;">Cerrada</span>
                        <br style="margin-top: 0.25rem;">Diferencia: ${{ caja.monto_final|add:"-"|add:caja.monto_inicial|intcomma }}
                        {% else %}
                        <span class="badge badge-modern badge-success-modern">Abierta</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p style="color: #64748b; text-align: center; padding: 1rem;">No hay historial</p>
                    {% endfor %}
                </div>
            </div>
        </div>
</div>

    <!-- Modal Abrir Caja -->
    <div class="modal fade" id="abrirCajaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title">Abrir Caja</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'pos:abrir_caja' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <i class="bi bi-info-circle"></i> <strong>Nota:</strong> Todas las ventas se registran en la Caja Principal, independientemente del punto de venta.
                        </div>
                        <div class="form-group-modern">
                            <label class="form-label-modern">Monto Inicial</label>
                            <input type="number" class="form-control form-control-modern" name="monto_inicial" step="100" value="0" required>
                            <small style="color: #94a3b8; font-size: 0.8rem;">Monto con el que inicias la caja</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; border: none;">Cancelar</button>
                        <button type="submit" class="btn btn-primary-pos">Abrir Caja Principal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Clientes Potenciales - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-people-fill"></i> Clientes Potenciales</h1>
        <a href="{% url 'pos:formulario_clientes' %}" class="btn btn-primary-pos">
            <i class="bi bi-plus-circle"></i> Nuevo Cliente
        </a>
    </div>

    <div class="card-modern">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Empresa</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in clientes %}
                    <tr>
                        <td><strong>{{ cliente.nombre }}</strong></td>
                        <td>{{ cliente.email }}</td>
                        <td>{{ cliente.telefono|default:"N/A" }}</td>
                        <td>{{ cliente.empresa|default:"N/A" }}</td>
                        <td><span class="badge badge-modern badge-info-modern">{{ cliente.get_tipo_interes_display }}</span></td>
                        <td>
                            {% if cliente.estado == 'nuevo' %}
                            <span class="badge badge-modern badge-info-modern">Nuevo</span>
                            {% elif cliente.estado == 'contactado' %}
                            <span class="badge badge-modern badge-info-modern">Contactado</span>
                            {% elif cliente.estado == 'en_proceso' %}
                            <span class="badge badge-modern badge-warning-modern">En Proceso</span>
                            {% elif cliente.estado == 'convertido' %}
                            <span class="badge badge-modern badge-success-modern">Convertido</span>
                            {% else %}
                            <span class="badge badge-modern" style="background: #e2e8f0; color: #64748b;">Descartado</span>
                            {% endif %}
                        </td>
                        <td>{{ cliente.fecha_registro|date:"d/m/Y" }}</td>
                        <td>
                            <a href="{% url 'pos:gestionar_cliente' cliente.id %}" class="btn btn-sm btn-warning" style="padding: 0.25rem 0.5rem;">
                                <i class="bi bi-pencil"></i> Gestionar
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay clientes potenciales registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Nuevo Ingreso de Mercancía - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-plus-circle"></i> Nuevo Ingreso de Mercancía</h1>
        <a href="{% url 'pos:ingreso_mercancia' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Ingreso</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formIngreso">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Proveedor *</label>
                                    <input type="text" class="form-control form-control-modern" name="proveedor" value="tersacosmeticos" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Número de Factura</label>
                                    <input type="text" class="form-control form-control-modern" name="numero_factura">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Observaciones</label>
                            <textarea class="form-control form-control-modern" name="observaciones" rows="3"></textarea>
                        </div>
                        
                        <hr style="margin: 1.5rem 0;">
                        
                        <h5 style="margin-bottom: 1rem;">Items del Ingreso</h5>
                        
                        <div id="items-container">
                            <div class="item-row mb-3 p-3" style="border: 1px solid #e2e8f0; border-radius: 8px;">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label class="form-label-modern">Producto *</label>
                                        <div class="autocomplete-wrapper" style="position: relative;">
                                            <input type="text" class="form-control form-control-modern producto-autocomplete" 
                                                   placeholder="Buscar por nombre, código o código de barras..." autocomplete="off" required>
                                            <input type="hidden" class="producto-id" name="producto">
                                            <div class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label-modern">Cantidad *</label>
                                        <input type="number" class="form-control form-control-modern cantidad-input" name="cantidad" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label-modern">Precio Compra *</label>
                                        <input type="number" class="form-control form-control-modern precio-input" name="precio_compra" step="1" min="0" required>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger w-100 eliminar-item" style="display: none;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary-pos btn-sm" id="btn-agregar-item">
                            <i class="bi bi-plus-circle"></i> Agregar Item
                        </button>
                        
                        <input type="hidden" name="items" id="items-json">
                        
                        <hr style="margin: 1.5rem 0;">
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Crear Ingreso
                            </button>
                            <a href="{% url 'pos:ingreso_mercancia' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Inicializar autocomplete para todos los campos de producto
function initAutocomplete(input) {
    const wrapper = input.closest('.autocomplete-wrapper');
    const dropdown = wrapper.querySelector('.autocomplete-dropdown');
    const hiddenInput = wrapper.querySelector('.producto-id');
    const precioInput = input.closest('.item-row').querySelector('.precio-input');
    let searchTimeout;
    
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            hiddenInput.value = '';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/buscar/?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.productos && data.productos.length > 0) {
                        dropdown.innerHTML = data.productos.map(p => {
                            const codigoBarras = p.codigo_barras ? ` | Cód. Barras: ${p.codigo_barras}` : '';
                            return `
                            <div class="autocomplete-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;" 
                                 data-id="${p.id}" data-precio="${p.precio}" data-nombre="${p.nombre}">
                                <strong>${p.nombre}</strong><br>
                                <small style="color: #64748b;">Código: ${p.codigo}${codigoBarras} | Stock: ${p.stock} | Precio: $${parseInt(p.precio).toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</small>
                            </div>
                        `;
                        }).join('');
                        dropdown.style.display = 'block';
                        
                        // Agregar eventos a los items
                        dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const productoId = this.dataset.id;
                                const productoNombre = this.dataset.nombre;
                                const productoPrecio = this.dataset.precio;
                                
                                input.value = productoNombre;
                                hiddenInput.value = productoId;
                                if (precioInput) {
                                    precioInput.value = productoPrecio;
                                }
                                dropdown.style.display = 'none';
                            });
                            
                            item.addEventListener('mouseenter', function() {
                                this.style.background = '#f8fafc';
                            });
                            item.addEventListener('mouseleave', function() {
                                this.style.background = 'white';
                            });
                        });
                    } else {
                        dropdown.innerHTML = '<div style="padding: 0.5rem; color: #64748b;">No se encontraron productos</div>';
                        dropdown.style.display = 'block';
                    }
                })
                .catch(() => {
                    dropdown.style.display = 'none';
                });
        }, 300);
    });
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
}

// Inicializar autocomplete para campos existentes
document.querySelectorAll('.producto-autocomplete').forEach(input => {
    initAutocomplete(input);
});

document.getElementById('formIngreso').addEventListener('submit', function(e) {
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const producto = row.querySelector('.producto-id').value;
        const cantidad = row.querySelector('.cantidad-input').value;
        const precio = row.querySelector('.precio-input').value;
        
        if (producto && cantidad && precio) {
            items.push({
                producto_id: producto,
                cantidad: cantidad,
                precio_compra: precio
            });
        }
    });
    
    document.getElementById('items-json').value = JSON.stringify(items);
});

document.getElementById('btn-agregar-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('div');
    newRow.className = 'item-row mb-3 p-3';
    newRow.style.border = '1px solid #e2e8f0';
    newRow.style.borderRadius = '8px';
    
    newRow.innerHTML = `
        <div class="row g-3">
            <div class="col-md-5">
                <label class="form-label-modern">Producto *</label>
                <div class="autocomplete-wrapper" style="position: relative;">
                    <input type="text" class="form-control form-control-modern producto-autocomplete" 
                           placeholder="Buscar por nombre, código o código de barras..." autocomplete="off" required>
                    <input type="hidden" class="producto-id" name="producto">
                    <div class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label-modern">Cantidad *</label>
                <input type="number" class="form-control form-control-modern cantidad-input" name="cantidad" min="1" value="1" required>
            </div>
            <div class="col-md-3">
                <label class="form-label-modern">Precio Compra *</label>
                                        <input type="number" class="form-control form-control-modern precio-input" name="precio_compra" step="1" min="0" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100 eliminar-item">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(newRow);
    
    // Inicializar autocomplete para el nuevo campo
    const newAutocomplete = newRow.querySelector('.producto-autocomplete');
    if (newAutocomplete) {
        initAutocomplete(newAutocomplete);
    }
    
    newRow.querySelector('.eliminar-item').addEventListener('click', function() {
        newRow.remove();
    });
});

document.querySelectorAll('.eliminar-item').forEach(btn => {
    btn.addEventListener('click', function() {
        if (document.querySelectorAll('.item-row').length > 1) {
            this.closest('.item-row').remove();
        }
    });
});
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Nuevo Producto - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-plus-circle"></i> Nuevo Producto</h1>
        <a href="{% url 'pos:productos' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Producto</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Código *</label>
                            <input type="text" class="form-control form-control-modern" name="codigo" required>
                            <small style="color: #94a3b8;">Código único del producto</small>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Código de Barras</label>
                            <input type="text" class="form-control form-control-modern" name="codigo_barras">
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Nombre *</label>
                            <input type="text" class="form-control form-control-modern" name="nombre" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Precio *</label>
                                    <input type="number" class="form-control form-control-modern" name="precio" step="1" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Stock Inicial *</label>
                                    <input type="number" class="form-control form-control-modern" name="stock" min="0" value="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Imagen</label>
                            <input type="file" class="form-control form-control-modern" name="imagen" accept="image/*">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="activo" id="activo" checked>
                            <label class="form-check-label" for="activo" style="color: #475569;">
                                Producto activo
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Crear Producto
                            </button>
                            <a href="{% url 'pos:productos' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Nueva Salida de Mercancía - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-plus-circle"></i> Nueva Salida de Mercancía</h1>
        <a href="{% url 'pos:salida_mercancia' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información de la Salida</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formSalida">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Tipo de Salida *</label>
                                    <select class="form-select form-control-modern" name="tipo" required>
                                        <option value="devolucion">Devolución</option>
                                        <option value="merma">Merma</option>
                                        <option value="traslado">Traslado</option>
                                        <option value="donacion">Donación</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Destino</label>
                                    <input type="text" class="form-control form-control-modern" name="destino">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Motivo *</label>
                            <textarea class="form-control form-control-modern" name="motivo" rows="3" required></textarea>
                        </div>
                        
                        <hr style="margin: 1.5rem 0;">
                        
                        <h5 style="margin-bottom: 1rem;">Items de la Salida</h5>
                        
                        <div id="items-container">
                            <div class="item-row mb-3 p-3" style="border: 1px solid #e2e8f0; border-radius: 8px;">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label class="form-label-modern">Producto *</label>
                                        <div class="autocomplete-wrapper" style="position: relative;">
                                            <input type="text" class="form-control form-control-modern producto-autocomplete" 
                                                   placeholder="Buscar por nombre, código o código de barras..." autocomplete="off" required>
                                            <input type="hidden" class="producto-id" name="producto">
                                            <div class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label-modern">Cantidad *</label>
                                        <input type="number" class="form-control form-control-modern cantidad-input" name="cantidad" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger w-100 eliminar-item" style="display: none;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary-pos btn-sm" id="btn-agregar-item">
                            <i class="bi bi-plus-circle"></i> Agregar Item
                        </button>
                        
                        <input type="hidden" name="items" id="items-json">
                        
                        <hr style="margin: 1.5rem 0;">
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Crear Salida
                            </button>
                            <a href="{% url 'pos:salida_mercancia' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Inicializar autocomplete para todos los campos de producto
function initAutocomplete(input) {
    const wrapper = input.closest('.autocomplete-wrapper');
    const dropdown = wrapper.querySelector('.autocomplete-dropdown');
    const hiddenInput = wrapper.querySelector('.producto-id');
    const cantidadInput = input.closest('.item-row').querySelector('.cantidad-input');
    let searchTimeout;
    
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            hiddenInput.value = '';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/buscar/?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.productos && data.productos.length > 0) {
                        dropdown.innerHTML = data.productos.map(p => {
                            const codigoBarras = p.codigo_barras ? ` | Cód. Barras: ${p.codigo_barras}` : '';
                            return `
                            <div class="autocomplete-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;" 
                                 data-id="${p.id}" data-stock="${p.stock}" data-nombre="${p.nombre}">
                                <strong>${p.nombre}</strong><br>
                                <small style="color: #64748b;">Código: ${p.codigo}${codigoBarras} | Stock: ${p.stock}</small>
                            </div>
                        `;
                        }).join('');
                        dropdown.style.display = 'block';
                        
                        // Agregar eventos a los items
                        dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const productoId = this.dataset.id;
                                const productoNombre = this.dataset.nombre;
                                const productoStock = this.dataset.stock;
                                
                                input.value = productoNombre;
                                hiddenInput.value = productoId;
                                if (cantidadInput) {
                                    cantidadInput.max = productoStock;
                                }
                                dropdown.style.display = 'none';
                            });
                            
                            item.addEventListener('mouseenter', function() {
                                this.style.background = '#f8fafc';
                            });
                            item.addEventListener('mouseleave', function() {
                                this.style.background = 'white';
                            });
                        });
                    } else {
                        dropdown.innerHTML = '<div style="padding: 0.5rem; color: #64748b;">No se encontraron productos</div>';
                        dropdown.style.display = 'block';
                    }
                })
                .catch(() => {
                    dropdown.style.display = 'none';
                });
        }, 300);
    });
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
}

// Inicializar autocomplete para campos existentes
document.querySelectorAll('.producto-autocomplete').forEach(input => {
    initAutocomplete(input);
});

document.getElementById('formSalida').addEventListener('submit', function(e) {
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const producto = row.querySelector('.producto-id').value;
        const cantidad = row.querySelector('.cantidad-input').value;
        
        if (producto && cantidad) {
            items.push({
                producto_id: producto,
                cantidad: cantidad
            });
        }
    });
    
    document.getElementById('items-json').value = JSON.stringify(items);
});

document.getElementById('btn-agregar-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('div');
    newRow.className = 'item-row mb-3 p-3';
    newRow.style.border = '1px solid #e2e8f0';
    newRow.style.borderRadius = '8px';
    
    newRow.innerHTML = `
        <div class="row g-3">
            <div class="col-md-8">
                <label class="form-label-modern">Producto *</label>
                <div class="autocomplete-wrapper" style="position: relative;">
                    <input type="text" class="form-control form-control-modern producto-autocomplete" 
                           placeholder="Buscar por nombre, código o código de barras..." autocomplete="off" required>
                    <input type="hidden" class="producto-id" name="producto">
                    <div class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label-modern">Cantidad *</label>
                <input type="number" class="form-control form-control-modern cantidad-input" name="cantidad" min="1" value="1" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100 eliminar-item">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(newRow);
    
    // Inicializar autocomplete para el nuevo campo
    const newAutocomplete = newRow.querySelector('.producto-autocomplete');
    if (newAutocomplete) {
        initAutocomplete(newAutocomplete);
    }
    
    newRow.querySelector('.eliminar-item').addEventListener('click', function() {
        newRow.remove();
    });
});

document.querySelectorAll('.eliminar-item').forEach(btn => {
    btn.addEventListener('click', function() {
        if (document.querySelectorAll('.item-row').length > 1) {
            this.closest('.item-row').remove();
        }
    });
});
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Nuevo Usuario - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-plus-circle"></i> Nuevo Usuario</h1>
        <a href="{% url 'pos:usuarios' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Usuario</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Nombre de Usuario *</label>
                                    <input type="text" class="form-control form-control-modern" name="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Email *</label>
                                    <input type="email" class="form-control form-control-modern" name="email" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Nombre</label>
                                    <input type="text" class="form-control form-control-modern" name="first_name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Apellido</label>
                                    <input type="text" class="form-control form-control-modern" name="last_name">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Contraseña *</label>
                            <input type="password" class="form-control form-control-modern" name="password" required>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Grupo</label>
                            <select class="form-select form-control-modern" name="grupo">
                                <option value="">Sin grupo</option>
                                {% for grupo in grupos %}
                                <option value="{{ grupo.id }}">{{ grupo.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_staff" id="is_staff">
                            <label class="form-check-label" for="is_staff" style="color: #475569;">
                                Es staff (puede acceder al admin)
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                            <label class="form-check-label" for="is_active" style="color: #475569;">
                                Usuario activo
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Crear Usuario
                            </button>
                            <a href="{% url 'pos:usuarios' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Detalle Ingreso #{{ ingreso.id }} - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-arrow-down-circle-fill"></i> Ingreso #{{ ingreso.id }}</h1>
        <a href="{% url 'pos:ingreso_mercancia' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Items del Ingreso</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table-modern table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Compra</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ingreso.items.all %}
                                <tr>
                                    <td>{{ item.producto.nombre }}</td>
                                    <td>{{ item.cantidad }}</td>
                                    <td>${{ item.precio_compra|intcomma }}</td>
                                    <td><strong>${{ item.subtotal|intcomma }}</strong></td>
                                </tr>
                                {% endfor %}
                                <tr style="background: #f8fafc;">
                                    <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                                    <td><strong class="text-success fs-4" style="color: #10b981 !important;">${{ ingreso.total|intcomma }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Proveedor:</strong><br>{{ ingreso.proveedor }}</p>
                    <p><strong>Número Factura:</strong><br>{{ ingreso.numero_factura|default:"N/A" }}</p>
                    <p><strong>Fecha:</strong><br>{{ ingreso.fecha|date:"d/m/Y H:i" }}</p>
                    <p><strong>Usuario:</strong><br>{{ ingreso.usuario.get_full_name|default:ingreso.usuario.username }}</p>
                    <p><strong>Estado:</strong><br>
                        {% if ingreso.completado %}
                        <span class="badge badge-modern badge-success-modern">Completado</span>
                        {% else %}
                        <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                        {% endif %}
                    </p>
                    
                    {% if ingreso.observaciones %}
                    <hr>
                    <p><strong>Observaciones:</strong><br>{{ ingreso.observaciones }}</p>
                    {% endif %}
                    
                    {% if not ingreso.completado %}
                    <hr>
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="completar" class="btn btn-success-pos w-100">
                            <i class="bi bi-check-circle"></i> Completar Ingreso
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Detalle Salida #{{ salida.id }} - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-arrow-up-circle-fill"></i> Salida #{{ salida.id }}</h1>
        <a href="{% url 'pos:salida_mercancia' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Items de la Salida</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table-modern table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in salida.items.all %}
                                <tr>
                                    <td>{{ item.producto.nombre }}</td>
                                    <td><strong>{{ item.cantidad }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tipo:</strong><br><span class="badge badge-modern badge-info-modern">{{ salida.get_tipo_display }}</span></p>
                    <p><strong>Destino:</strong><br>{{ salida.destino|default:"N/A" }}</p>
                    <p><strong>Fecha:</strong><br>{{ salida.fecha|date:"d/m/Y H:i" }}</p>
                    <p><strong>Usuario:</strong><br>{{ salida.usuario.get_full_name|default:salida.usuario.username }}</p>
                    <p><strong>Estado:</strong><br>
                        {% if salida.completado %}
                        <span class="badge badge-modern badge-success-modern">Completado</span>
                        {% else %}
                        <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                        {% endif %}
                    </p>
                    
                    <hr>
                    <p><strong>Motivo:</strong><br>{{ salida.motivo }}</p>
                    
                    {% if not salida.completado %}
                    <hr>
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="completar" class="btn btn-success-pos w-100">
                            <i class="bi bi-check-circle"></i> Completar Salida
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Detalle Venta #{{ venta.id }} - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-receipt"></i> Detalle de Venta #{{ venta.id }}</h1>
        <a href="{% url 'pos:lista_ventas' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Items de la Venta</h5>
                </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table-modern table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio Unit.</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% for item in venta.items.all %}
                        <tr>
                            <td>{{ item.producto.nombre }}</td>
                            <td>${{ item.precio_unitario|intcomma }}</td>
                            <td>{{ item.cantidad }}</td>
                            <td><strong>${{ item.subtotal|intcomma }}</strong></td>
                        </tr>
                        {% endfor %}
                            <tr style="background: #f8fafc;">
                                <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                                <td><strong class="text-success fs-4" style="color: #10b981 !important;">${{ venta.total|intcomma }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información de la Venta</h5>
                </div>
            <div class="card-body">
                <p><strong>Fecha:</strong><br>{{ venta.fecha|date:"d/m/Y H:i:s" }}</p>
                <p><strong>Usuario:</strong><br>
                    {% if venta.usuario %}
                        {{ venta.usuario.get_full_name|default:venta.usuario.username }}
                    {% else %}
                        Sistema
                    {% endif %}
                </p>
                <p><strong>Método de Pago:</strong><br>
                    <span class="badge badge-modern badge-info-modern">{{ venta.get_metodo_pago_display }}</span>
                </p>
                
                {% if venta.metodo_pago == 'efectivo' and venta.monto_recibido %}
                <p><strong>Monto Recibido:</strong><br>${{ venta.monto_recibido|intcomma }}</p>
                <p><strong>Cambio:</strong><br>${{ venta.monto_recibido|add:"-"|add:venta.total|intcomma }}</p>
                {% endif %}
                
                {% if venta.email_cliente %}
                <p><strong>Email Cliente:</strong><br>{{ venta.email_cliente }}</p>
                {% endif %}
                
                <p><strong>Estado:</strong><br>
                    {% if venta.anulada %}
                    <span class="badge badge-modern badge-danger-modern">Anulada</span>
                    {% elif venta.completada %}
                    <span class="badge badge-modern badge-success-modern">Completada</span>
                    {% else %}
                    <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                    {% endif %}
                </p>
                
                {% if venta.anulada %}
                <hr>
                <p><strong>Motivo Anulación:</strong><br>{{ venta.motivo_anulacion|default:"No especificado" }}</p>
                <p><strong>Anulada por:</strong><br>
                    {% if venta.usuario_anulacion %}
                        {{ venta.usuario_anulacion.get_full_name|default:venta.usuario_anulacion.username }}
                    {% else %}
                        Sistema
                    {% endif %}
                </p>
                <p><strong>Fecha Anulación:</strong><br>{{ venta.fecha_anulacion|date:"d/m/Y H:i" }}</p>
                {% endif %}
                
                {% if venta.caja %}
                <hr>
                <p><strong>Caja:</strong><br>{{ venta.caja }}</p>
                {% endif %}
            </div>
        </div>
        
            <div class="card-modern mt-3">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary-pos" onclick="imprimirTicket80mm({{ venta.id }})">
                            <i class="bi bi-printer"></i> Imprimir Ticket 80mm
                        </button>
                        <button class="btn" onclick="window.print()" style="background: #6c757d; color: white; border: none;">
                            <i class="bi bi-printer"></i> Imprimir Recibo
                        </button>
                        {% if not venta.anulada %}
                        {% if puede_anular_ventas %}
                        <a href="{% url 'pos:editar_venta' venta.id %}" class="btn btn-warning" style="background: #f59e0b; border: none; color: white;">
                            <i class="bi bi-pencil"></i> Editar Venta
                        </a>
                        <button type="button" class="btn btn-danger-pos" onclick="anularVenta({{ venta.id }})">
                            <i class="bi bi-x-circle"></i> Anular Venta
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        
        <!-- Modal para anular venta -->
        <div class="modal fade" id="modalAnular" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        <h5 class="modal-title">Anular Venta #{{ venta.id }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" action="{% url 'pos:anular_venta' venta.id %}" id="formAnular">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p style="color: #475569; margin-bottom: 1rem;">¿Estás seguro de anular esta venta?</p>
                            <div class="form-group-modern">
                                <label class="form-label-modern">Motivo de anulación:</label>
                                <textarea class="form-control form-control-modern" name="motivo" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" style="background: #6c757d; color: white; border: none;" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger-pos">Anular Venta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
function imprimirTicket80mm(ventaId) {
    const url = `/ventas/${ventaId}/imprimir/`;
    const ventana = window.open(url, '_blank', 'width=300,height=600');
    if (ventana) {
        ventana.onload = function() {
            setTimeout(() => {
                ventana.print();
            }, 500);
        };
    }
}

function anularVenta(ventaId) {
    const modal = new bootstrap.Modal(document.getElementById('modalAnular'));
    modal.show();
}
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Editar Producto - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-pencil"></i> Editar Producto</h1>
        <a href="{% url 'pos:productos' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Producto</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Código *</label>
                            <input type="text" class="form-control form-control-modern" name="codigo" value="{{ producto.codigo }}" required>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Código de Barras</label>
                            <input type="text" class="form-control form-control-modern" name="codigo_barras" value="{{ producto.codigo_barras|default:'' }}">
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Nombre *</label>
                            <input type="text" class="form-control form-control-modern" name="nombre" value="{{ producto.nombre }}" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Precio *</label>
                                    <input type="number" class="form-control form-control-modern" name="precio" step="1" min="0" value="{{ precio_float }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Stock *</label>
                                    <input type="number" class="form-control form-control-modern" name="stock" min="0" value="{{ producto.stock }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Imagen</label>
                            {% if producto.imagen %}
                            <div class="mb-2">
                                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                            </div>
                            {% endif %}
                            <input type="file" class="form-control form-control-modern" name="imagen" accept="image/*">
                            <small style="color: #94a3b8;">Dejar vacío para mantener la imagen actual</small>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="activo" id="activo" {% if producto.activo %}checked{% endif %}>
                            <label class="form-check-label" for="activo" style="color: #475569;">
                                Producto activo
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                            <a href="{% url 'pos:productos' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Editar Usuario - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-pencil"></i> Editar Usuario</h1>
        <a href="{% url 'pos:usuarios' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Usuario</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Nombre de Usuario</label>
                            <input type="text" class="form-control form-control-modern" value="{{ usuario.username }}" disabled>
                            <small style="color: #94a3b8;">El nombre de usuario no se puede cambiar</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Nombre</label>
                                    <input type="text" class="form-control form-control-modern" name="first_name" value="{{ usuario.first_name|default:'' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Apellido</label>
                                    <input type="text" class="form-control form-control-modern" name="last_name" value="{{ usuario.last_name|default:'' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Email *</label>
                            <input type="email" class="form-control form-control-modern" name="email" value="{{ usuario.email|default:'' }}" required>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Nueva Contraseña</label>
                            <input type="password" class="form-control form-control-modern" name="password">
                            <small style="color: #94a3b8;">Dejar vacío para mantener la contraseña actual</small>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Grupo</label>
                            <select class="form-select form-control-modern" name="grupo">
                                <option value="">Sin grupo</option>
                                {% for grupo in grupos %}
                                <option value="{{ grupo.id }}" {% if grupo in usuario_grupos %}selected{% endif %}>{{ grupo.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_staff" id="is_staff" {% if usuario.is_staff %}checked{% endif %}>
                            <label class="form-check-label" for="is_staff" style="color: #475569;">
                                Es staff (puede acceder al admin)
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {% if usuario.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active" style="color: #475569;">
                                Usuario activo
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                            <a href="{% url 'pos:usuarios' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Editar Venta #{{ venta.id }} - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-pencil"></i> Editar Venta #{{ venta.id }}</h1>
        <a href="{% url 'pos:detalle_venta' venta.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Items de la Venta</h5>
                </div>
            <div class="card-body">
                <form method="post" id="form-editar-venta">
                    {% csrf_token %}
                    <div class="table-responsive">
                        <table class="table-modern table" id="items-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                        <tbody>
                            {% for item in venta.items.all %}
                            <tr data-item-id="{{ item.id }}">
                                <td>
                                    <select class="form-select form-select-sm form-control-modern producto-select" name="producto" required>
                                        <option value="">Seleccionar...</option>
                                        {% for producto in productos %}
                                        <option value="{{ producto.id }}" data-precio="{{ producto.precio }}" {% if producto.id == item.producto.id %}selected{% endif %}>
                                            {{ producto.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <input type="hidden" class="item-id" value="{{ item.id }}">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm form-control-modern precio-input" 
                                           value="{{ item.precio_unitario }}" step="1" min="0" required>
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm form-control-modern cantidad-input" 
                                           value="{{ item.cantidad }}" min="1" required>
                                </td>
                                <td class="subtotal-cell">$<span class="subtotal-value">{{ item.subtotal|intcomma }}</span></td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-danger eliminar-item" style="background: #ef4444; border: none; color: white;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                            <tfoot>
                                <tr style="background: #f8fafc;">
                                    <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                                    <td><strong class="text-success fs-4" id="total-venta" style="color: #10b981 !important;">${{ venta.total|intcomma }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <button type="button" class="btn btn-primary-pos btn-sm mt-3" id="btn-agregar-item">
                        <i class="bi bi-plus-circle"></i> Agregar Item
                    </button>
                </form>
            </div>
        </div>
    </div>
    
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información de Pago</h5>
                </div>
            <div class="card-body">
                <div class="form-group-modern">
                    <label class="form-label-modern">Método de Pago:</label>
                    <select class="form-select form-control-modern" name="metodo_pago" id="metodo-pago">
                        <option value="efectivo" {% if venta.metodo_pago == 'efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="tarjeta" {% if venta.metodo_pago == 'tarjeta' %}selected{% endif %}>Tarjeta</option>
                        <option value="transferencia" {% if venta.metodo_pago == 'transferencia' %}selected{% endif %}>Transferencia</option>
                    </select>
                </div>
                
                <div class="form-group-modern" id="monto-recibido-group" style="display: {% if venta.metodo_pago == 'efectivo' %}block{% else %}none{% endif %};">
                    <label class="form-label-modern">Monto Recibido:</label>
                    <input type="text" class="form-control form-control-modern" name="monto_recibido" 
                           id="monto-recibido" value="{% if venta.monto_recibido %}{{ venta.monto_recibido|intcomma }}{% endif %}">
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary-pos" onclick="guardarCambios()">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                    <a href="{% url 'pos:detalle_venta' venta.id %}" class="btn" style="background: #6c757d; color: white; border: none;">
                        <i class="bi bi-x"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
// Cargar productos para select
const productos = [
    {% for producto in productos %}
    {id: {{ producto.id }}, nombre: "{{ producto.nombre|escapejs }}", precio: {{ producto.precio }}, stock: {{ producto.stock }}},
    {% endfor %}
];

// Event listener para cambio de producto
document.querySelectorAll('.producto-select').forEach(select => {
    select.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.dataset.precio) {
            const row = this.closest('tr');
            row.querySelector('.precio-input').value = option.dataset.precio;
            calcularSubtotal(row);
        }
    });
});

function calcularSubtotal(row) {
    const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
    const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 0;
    const subtotal = precio * cantidad;
    row.querySelector('.subtotal-value').textContent = subtotal.toLocaleString('es-CO', {minimumFractionDigits: 0});
    calcularTotal();
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('#items-table tbody tr').forEach(row => {
        const subtotal = parseFloat(row.querySelector('.subtotal-value').textContent.replace(/[^0-9]/g, '')) || 0;
        total += subtotal;
    });
    document.getElementById('total-venta').textContent = '$' + total.toLocaleString('es-CO', {minimumFractionDigits: 0});
}

// Event listeners
document.querySelectorAll('.precio-input, .cantidad-input').forEach(input => {
    input.addEventListener('input', function() {
        calcularSubtotal(this.closest('tr'));
    });
});

document.querySelectorAll('.eliminar-item').forEach(btn => {
    btn.addEventListener('click', function() {
        if (confirm('¿Eliminar este item?')) {
            this.closest('tr').remove();
            calcularTotal();
        }
    });
});

// Agregar item
document.getElementById('btn-agregar-item').addEventListener('click', function() {
    const tbody = document.querySelector('#items-table tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select class="form-select form-select-sm form-control-modern producto-select" name="producto" required>
                <option value="">Seleccionar...</option>
                ${productos.map(p => `<option value="${p.id}" data-precio="${p.precio}">${p.nombre}</option>`).join('')}
            </select>
            <input type="hidden" class="item-id" value="">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm form-control-modern precio-input" 
                   value="0" step="1" min="0" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm form-control-modern cantidad-input" 
                   value="1" min="1" required>
        </td>
        <td class="subtotal-cell">$<span class="subtotal-value">0</span></td>
        <td>
            <button type="button" class="btn btn-sm btn-danger eliminar-item" style="background: #ef4444; border: none; color: white;">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
    
    // Event listeners para el nuevo row
    newRow.querySelector('.producto-select').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.dataset.precio) {
            newRow.querySelector('.precio-input').value = option.dataset.precio;
            calcularSubtotal(newRow);
        }
    });
    
    newRow.querySelector('.precio-input').addEventListener('input', function() {
        calcularSubtotal(newRow);
    });
    
    newRow.querySelector('.cantidad-input').addEventListener('input', function() {
        calcularSubtotal(newRow);
    });
    
    newRow.querySelector('.eliminar-item').addEventListener('click', function() {
        if (confirm('¿Eliminar este item?')) {
            newRow.remove();
            calcularTotal();
        }
    });
});

// Método de pago
document.getElementById('metodo-pago').addEventListener('change', function() {
    const montoGroup = document.getElementById('monto-recibido-group');
    if (this.value === 'efectivo') {
        montoGroup.style.display = 'block';
    } else {
        montoGroup.style.display = 'none';
    }
});

function guardarCambios() {
    const form = document.getElementById('form-editar-venta');
    const formData = new FormData(form);
    
    // Agregar items
    const items = [];
    document.querySelectorAll('#items-table tbody tr').forEach(row => {
        const productoSelect = row.querySelector('.producto-select');
        const precio = row.querySelector('.precio-input').value;
        const cantidad = row.querySelector('.cantidad-input').value;
        const itemId = row.querySelector('.item-id')?.value;
        
        if (productoSelect.value && precio && cantidad) {
            items.push({
                item_id: itemId || null,
                producto_id: productoSelect.value,
                precio: precio,
                cantidad: cantidad
            });
        }
    });
    
    formData.append('items', JSON.stringify(items));
    formData.append('metodo_pago', document.getElementById('metodo-pago').value);
    formData.append('monto_recibido', document.getElementById('monto-recibido').value);
    
    fetch('{% url "pos:editar_venta" venta.id %}', {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => {
        if (r.ok) {
            window.location.href = '{% url "pos:detalle_venta" venta.id %}';
        } else {
            alert('Error al guardar los cambios');
        }
    })
    .catch(() => {
        alert('Error de conexión');
    });
}
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Formulario de Clientes - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card-modern">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-file-earmark-text-fill"></i> Registro de Cliente Potencial</h4>
                </div>
                <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Nombre Completo *</label>
                        <input type="text" class="form-control form-control-modern" name="nombre" required>
                    </div>
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Email *</label>
                        <input type="email" class="form-control form-control-modern" name="email" required>
                    </div>
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Teléfono</label>
                        <input type="tel" class="form-control form-control-modern" name="telefono">
                    </div>
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Tipo de Interés *</label>
                        <input type="hidden" name="tipo_interes" id="tipo_interes" required>
                        <div class="btn-group w-100" role="group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <button type="button" class="btn btn-tipo-interes" data-value="mayorista" style="padding: 0.75rem; border: 2px solid #e2e8f0; background: #ffffff; color: #475569; transition: all 0.3s;">
                                <i class="bi bi-building"></i><br>
                                <small>Venta Mayorista</small>
                            </button>
                            <button type="button" class="btn btn-tipo-interes" data-value="web" style="padding: 0.75rem; border: 2px solid #e2e8f0; background: #ffffff; color: #475569; transition: all 0.3s;">
                                <i class="bi bi-globe"></i><br>
                                <small>Venta Web</small>
                            </button>
                            <button type="button" class="btn btn-tipo-interes" data-value="ambos" style="padding: 0.75rem; border: 2px solid #e2e8f0; background: #ffffff; color: #475569; transition: all 0.3s;">
                                <i class="bi bi-arrow-left-right"></i><br>
                                <small>Ambos</small>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Empresa</label>
                        <input type="text" class="form-control form-control-modern" name="empresa">
                    </div>
                    
                    <div class="form-group-modern">
                        <label class="form-label-modern">Mensaje o Comentarios</label>
                        <textarea class="form-control form-control-modern" name="mensaje" rows="4"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary-pos btn-lg w-100">
                        <i class="bi bi-check-circle"></i> Registrar Cliente
                    </button>
                </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Manejo de botones de tipo de interés
document.querySelectorAll('.btn-tipo-interes').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remover selección de todos los botones
        document.querySelectorAll('.btn-tipo-interes').forEach(b => {
            b.style.background = '#ffffff';
            b.style.borderColor = '#e2e8f0';
            b.style.color = '#475569';
            b.style.transform = 'scale(1)';
        });
        
        // Seleccionar el botón clickeado
        this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        this.style.borderColor = '#667eea';
        this.style.color = '#ffffff';
        this.style.transform = 'scale(1.02)';
        
        // Establecer el valor en el input hidden
        document.getElementById('tipo_interes').value = this.dataset.value;
    });
});

// Validar que se haya seleccionado un tipo antes de enviar
document.querySelector('form').addEventListener('submit', function(e) {
    const tipoInteres = document.getElementById('tipo_interes').value;
    if (!tipoInteres) {
        e.preventDefault();
        alert('Por favor selecciona un tipo de interés');
        return false;
    }
});
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Gestionar Cliente - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-person"></i> Gestionar Cliente</h1>
        <a href="{% url 'pos:clientes_potenciales' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Información del Cliente</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Nombre:</strong><br>{{ cliente.nombre }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Email:</strong><br>{{ cliente.email }}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Teléfono:</strong><br>{{ cliente.telefono|default:"N/A" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Empresa:</strong><br>{{ cliente.empresa|default:"N/A" }}</p>
                            </div>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Estado *</label>
                            <select class="form-select form-control-modern" name="estado" required>
                                <option value="nuevo" {% if cliente.estado == 'nuevo' %}selected{% endif %}>Nuevo</option>
                                <option value="contactado" {% if cliente.estado == 'contactado' %}selected{% endif %}>Contactado</option>
                                <option value="en_proceso" {% if cliente.estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
                                <option value="convertido" {% if cliente.estado == 'convertido' %}selected{% endif %}>Convertido</option>
                                <option value="descartado" {% if cliente.estado == 'descartado' %}selected{% endif %}>Descartado</option>
                            </select>
                        </div>
                        
                        <div class="form-group-modern">
                            <label class="form-label-modern">Notas Internas</label>
                            <textarea class="form-control form-control-modern" name="notas_internas" rows="5">{{ cliente.notas_internas|default:'' }}</textarea>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-pos">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                            <a href="{% url 'pos:clientes_potenciales' %}" class="btn" style="background: #6c757d; color: white; border: none;">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Detalles</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tipo de Interés:</strong><br><span class="badge badge-modern badge-info-modern">{{ cliente.get_tipo_interes_display }}</span></p>
                    <p><strong>Fecha Registro:</strong><br>{{ cliente.fecha_registro|date:"d/m/Y H:i" }}</p>
                    {% if cliente.fecha_contacto %}
                    <p><strong>Fecha Contacto:</strong><br>{{ cliente.fecha_contacto|date:"d/m/Y H:i" }}</p>
                    {% endif %}
                    {% if cliente.usuario_contacto %}
                    <p><strong>Contactado por:</strong><br>{{ cliente.usuario_contacto.get_full_name|default:cliente.usuario_contacto.username }}</p>
                    {% endif %}
                    {% if cliente.mensaje %}
                    <hr>
                    <p><strong>Mensaje:</strong><br>{{ cliente.mensaje }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}
{% load humanize %}

{% block title %}Inicio - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1><i class="bi bi-house-door"></i> Dashboard</h1>
            <p style="color: #64748b; margin: 0.5rem 0 0 0;">Bienvenido, {{ user.get_full_name|default:user.username }}</p>
        </div>
    </div>

    <!-- Selector de Registradora -->
    <div class="card-modern mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h5 class="mb-0" style="color: white;"><span style="font-size: 1.3rem; margin-right: 0.5rem;">🖨️</span><i class="bi bi-cash-register"></i> Seleccionar Registradora</h5>
        </div>
        <div class="card-body">
            {% if registradora_seleccionada %}
            <div class="alert alert-success" style="background: #d1fae5; border: 1px solid #10b981; color: #065f46; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <i class="bi bi-check-circle"></i> <strong>Registradora activa:</strong> {{ registradora_seleccionada.nombre }}
                </div>
                <form method="post" action="{% url 'pos:cerrar_registradora' %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm" style="background: #ef4444; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 0.375rem; font-size: 0.85rem; font-weight: 600;">
                        <i class="bi bi-x-circle"></i> Cerrar Registradora
                    </button>
                </form>
            </div>
            {% else %}
            <div class="alert alert-warning" style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                <i class="bi bi-exclamation-triangle"></i> <strong>No hay registradora seleccionada.</strong> Por favor, selecciona una para poder realizar ventas.
            </div>
            {% endif %}
            
            <form method="post" action="{% url 'pos:seleccionar_registradora' %}">
                {% csrf_token %}
                <div class="row g-3">
                    {% for reg in registradoras %}
                    <div class="col-md-4">
                        <button type="submit" name="registradora_id" value="{{ reg.id }}" 
                                class="btn w-100 {% if registradora_seleccionada and registradora_seleccionada.id == reg.id %}btn-success-pos{% elif reg.disponible %}btn-outline-primary{% else %}btn-outline-secondary{% endif %}" 
                                style="padding: 1.5rem; font-size: 1.1rem; border: 2px solid {% if registradora_seleccionada and registradora_seleccionada.id == reg.id %}#10b981{% elif reg.disponible %}#3b82f6{% else %}#94a3b8{% endif %}; {% if not reg.disponible %}opacity: 0.6; cursor: not-allowed;{% endif %}"
                                {% if not reg.disponible %}disabled title="En uso por {{ reg.usuario_activo.get_full_name|default:reg.usuario_activo.username }}"{% endif %}>
                            <div style="font-size: 3rem; display: block; margin-bottom: 0.5rem; line-height: 1;">🖨️</div>
                            <i class="bi bi-cash-register" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem; opacity: 0.8;"></i>
                            {{ reg.nombre }}
                            {% if registradora_seleccionada and registradora_seleccionada.id == reg.id %}
                            <br><small style="font-size: 0.85rem; margin-top: 0.5rem; display: block;"><i class="bi bi-check-circle-fill"></i> Activa</small>
                            {% elif reg.usuario_activo %}
                            <br><small style="font-size: 0.85rem; margin-top: 0.5rem; display: block; color: #ef4444;"><i class="bi bi-x-circle-fill"></i> En uso por {{ reg.usuario_activo.get_full_name|default:reg.usuario_activo.username }}</small>
                            {% endif %}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <!-- Meta de Ventas -->
    <div class="card-modern mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <h5 class="mb-0" style="color: white;"><i class="bi bi-trophy"></i> Meta de Ventas del Mes</h5>
        </div>
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.25rem;">Ventas del Mes</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #1e293b;">${{ ventas_totales_mes|intcomma|default:"0" }}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.25rem;">Meta</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${{ meta_ventas|intcomma }}</div>
                </div>
            </div>
            
            <div style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.85rem; color: #64748b;">Progreso</span>
                    <span id="porcentaje-display" style="font-size: 1.1rem; font-weight: 700; color: #10b981;">0%</span>
                </div>
                <div style="background: #e2e8f0; border-radius: 10px; height: 30px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                    <div id="barra-progreso" style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; width: 0%; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                        {% if porcentaje_meta > 10 %}
                        <span style="color: white; font-size: 0.75rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); position: relative; z-index: 1;"></span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const porcentajeMeta = {{ porcentaje_meta|floatformat:2 }};
                    const barraProgreso = document.getElementById('barra-progreso');
                    const porcentajeDisplay = document.getElementById('porcentaje-display');
                    
                    // Animar la barra
                    setTimeout(function() {
                        barraProgreso.style.width = porcentajeMeta + '%';
                        
                        // Animar el porcentaje
                        let porcentajeActual = 0;
                        const incremento = porcentajeMeta / 60; // 60 frames para la animación
                        const intervalo = setInterval(function() {
                            porcentajeActual += incremento;
                            if (porcentajeActual >= porcentajeMeta) {
                                porcentajeActual = porcentajeMeta;
                                clearInterval(intervalo);
                            }
                            porcentajeDisplay.textContent = porcentajeActual.toFixed(2) + '%';
                        }, 25); // ~60fps
                    }, 300);
                });
            </script>
            
            <style>
                @keyframes shimmer {
                    0% {
                        transform: translateX(-100%);
                    }
                    100% {
                        transform: translateX(100%);
                    }
                }
            </style>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <div style="font-size: 0.85rem; color: #64748b;">
                    <i class="bi bi-calendar"></i> Mes Actual
                </div>
                <div style="font-size: 0.85rem; color: #64748b;">
                    Faltan: ${{ faltan_para_meta|intcomma|default:"0" }}
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="cards-grid">
        <div class="stat-card success">
            <div class="stat-card-label">
                <i class="bi bi-currency-dollar"></i> Ventas Hoy
            </div>
            <div class="stat-card-value">${{ ventas_hoy|intcomma|default:"0" }}</div>
        </div>
        
        <div class="stat-card primary">
            <div class="stat-card-label">
                <i class="bi bi-receipt"></i> Transacciones
            </div>
            <div class="stat-card-value">{{ total_ventas_hoy|default:"0" }}</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-card-label">
                <i class="bi bi-box-seam"></i> Productos
            </div>
            <div class="stat-card-value">{{ productos_count|default:"0" }}</div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-card-label">
                <i class="bi bi-exclamation-triangle"></i> Stock Bajo
            </div>
            <div class="stat-card-value">{{ productos_bajo_stock|default:"0" }}</div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{% url 'pos:vender' %}" class="btn btn-success-pos w-100" style="padding: 1.5rem; font-size: 1.1rem;">
                                <i class="bi bi-cart-plus" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                Nueva Venta
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'pos:productos' %}" class="btn btn-primary-pos w-100" style="padding: 1.5rem; font-size: 1.1rem;">
                                <i class="bi bi-box-seam" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                Ver Productos
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'pos:lista_ventas' %}" class="btn btn-primary-pos w-100" style="padding: 1.5rem; font-size: 1.1rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                <i class="bi bi-receipt" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                Ver Ventas
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Últimas Ventas -->
            <div class="card-modern mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Últimas Ventas</h5>
                </div>
                <div class="card-body">
                    {% if ultimas_ventas %}
                    <div class="table-responsive">
                        <table class="table-modern table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Método</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for venta in ultimas_ventas %}
                                <tr>
                                    <td><strong>{{ venta.id }}</strong></td>
                                    <td>{{ venta.fecha|date:"d/m/Y H:i" }}</td>
                                    <td><strong>${{ venta.total|intcomma }}</strong></td>
                                    <td>
                                        <span class="badge badge-modern badge-info-modern">
                                            {{ venta.get_metodo_pago_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if venta.anulada %}
                                        <span class="badge badge-modern badge-danger-modern">Anulada</span>
                                        {% elif venta.completada %}
                                        <span class="badge badge-modern badge-success-modern">Completada</span>
                                        {% else %}
                                        <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-4">No hay ventas registradas</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Productos con Stock Bajo -->
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Stock Bajo</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if productos_stock_bajo %}
                    <div class="list-group list-group-flush">
                        {% for producto in productos_stock_bajo %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" style="border: none; border-bottom: 1px solid #f1f5f9; padding: 0.75rem 0;">
                            <div>
                                <strong style="font-size: 0.9rem;">{{ producto.nombre }}</strong><br>
                                <small style="color: #64748b;">{{ producto.codigo }}</small>
                            </div>
                            <span class="badge badge-modern badge-danger-modern">{{ producto.stock }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-4">Todos los productos tienen stock suficiente</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Estado de Caja -->
            {% if caja_abierta %}
            <div class="card-modern mt-4">
                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Caja Abierta</h5>
                </div>
                <div class="card-body">
                    <p style="margin-bottom: 0.5rem;"><strong>Caja:</strong> {{ caja_abierta.caja }}</p>
                    <p style="margin-bottom: 0.5rem;"><strong>Apertura:</strong> {{ caja_abierta.fecha_apertura|date:"H:i" }}</p>
                    <p style="margin-bottom: 1rem;"><strong>Monto Inicial:</strong> ${{ caja_abierta.monto_inicial|intcomma }}</p>
                    <a href="{% url 'pos:cerrar_caja' %}" class="btn btn-danger-pos w-100">
                        <i class="bi bi-x-circle"></i> Cerrar Caja
                    </a>
                </div>
            </div>
            {% else %}
            <div class="card-modern mt-4">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Sin Caja Abierta</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">No tienes una caja abierta</p>
                    <a href="{% url 'pos:abrir_caja' %}" class="btn btn-primary-pos w-100">
                        <i class="bi bi-box-arrow-in-down"></i> Abrir Caja
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Ingreso de Mercancía - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-arrow-down-circle-fill"></i> Ingreso de Mercancía</h1>
        <a href="{% url 'pos:crear_ingreso' %}" class="btn btn-primary-pos">
            <i class="bi bi-plus-circle"></i> Nuevo Ingreso
        </a>
    </div>

    <div class="card-modern">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Proveedor</th>
                        <th>Factura</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ingreso in ingresos %}
                    <tr>
                        <td>{{ ingreso.id }}</td>
                        <td>{{ ingreso.fecha|date:"d/m/Y H:i" }}</td>
                        <td>{{ ingreso.proveedor }}</td>
                        <td>{{ ingreso.numero_factura|default:"N/A" }}</td>
                        <td><strong>${{ ingreso.total|intcomma }}</strong></td>
                        <td>
                            {% if ingreso.completado %}
                            <span class="badge badge-modern badge-success-modern">Completado</span>
                            {% else %}
                            <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ingreso.usuario %}
                                {{ ingreso.usuario.get_full_name|default:ingreso.usuario.username }}
                            {% else %}
                                Sistema
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'pos:detalle_ingreso' ingreso.id %}" class="btn btn-sm" style="background: #dbeafe; color: #2563eb; border: none;">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay ingresos registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Inventario - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-box-seam-fill"></i> Inventario</h1>
    </div>

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-4" style="border-bottom: 2px solid #e5e7eb;">
        <li class="nav-item">
            <a class="nav-link {% if tipo_activo == 'ingreso' %}active{% endif %}" 
               href="{% url 'pos:inventario' %}?tipo=ingreso"
               style="{% if tipo_activo == 'ingreso' %}background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;{% else %}color: #667eea;{% endif %}">
                <i class="bi bi-arrow-down-circle-fill"></i> Ingreso de Mercancía
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tipo_activo == 'salida' %}active{% endif %}" 
               href="{% url 'pos:inventario' %}?tipo=salida"
               style="{% if tipo_activo == 'salida' %}background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;{% else %}color: #667eea;{% endif %}">
                <i class="bi bi-arrow-up-circle-fill"></i> Salida de Mercancía
            </a>
        </li>
    </ul>

    <!-- Contenido de Ingresos -->
    {% if tipo_activo == 'ingreso' %}
    <div class="card-modern">
        <div class="card-header-modern">
            <div class="d-flex justify-content-between align-items-center">
                <h3 style="margin: 0; color: white;">Ingreso de Mercancía</h3>
                {% if es_inventario or es_administrador %}
                <a href="{% url 'pos:crear_ingreso' %}" class="btn btn-primary-pos">
                    <i class="bi bi-plus-circle"></i> Nuevo Ingreso
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Proveedor</th>
                        <th>Factura</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ingreso in ingresos %}
                    <tr>
                        <td>{{ ingreso.id }}</td>
                        <td>{{ ingreso.fecha|date:"d/m/Y H:i" }}</td>
                        <td>{{ ingreso.proveedor }}</td>
                        <td>{{ ingreso.numero_factura|default:"N/A" }}</td>
                        <td><strong>${{ ingreso.total|intcomma }}</strong></td>
                        <td>
                            {% if ingreso.completado %}
                            <span class="badge badge-modern badge-success-modern">Completado</span>
                            {% else %}
                            <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ingreso.usuario %}
                                {{ ingreso.usuario.get_full_name|default:ingreso.usuario.username }}
                            {% else %}
                                Sistema
                            {% endif %}
                        </td>
                        <td>
                            {% if es_inventario or es_administrador %}
                            <a href="{% url 'pos:detalle_ingreso' ingreso.id %}" class="btn btn-sm" style="background: #dbeafe; color: #2563eb; border: none;">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay ingresos registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contenido de Salidas -->
    {% if tipo_activo == 'salida' %}
    <div class="card-modern">
        <div class="card-header-modern">
            <div class="d-flex justify-content-between align-items-center">
                <h3 style="margin: 0; color: white;">Salida de Mercancía</h3>
                {% if es_inventario or es_administrador %}
                <a href="{% url 'pos:crear_salida' %}" class="btn btn-primary-pos">
                    <i class="bi bi-plus-circle"></i> Nueva Salida
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Destino</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for salida in salidas %}
                    <tr>
                        <td>{{ salida.id }}</td>
                        <td>{{ salida.fecha|date:"d/m/Y H:i" }}</td>
                        <td><span class="badge badge-modern badge-info-modern">{{ salida.get_tipo_display }}</span></td>
                        <td>{{ salida.destino|default:"N/A" }}</td>
                        <td>{{ salida.motivo|truncatewords:10 }}</td>
                        <td>
                            {% if salida.completado %}
                            <span class="badge badge-modern badge-success-modern">Completado</span>
                            {% else %}
                            <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if salida.usuario %}
                                {{ salida.usuario.get_full_name|default:salida.usuario.username }}
                            {% else %}
                                Sistema
                            {% endif %}
                        </td>
                        <td>
                            {% if es_inventario or es_administrador %}
                            <a href="{% url 'pos:detalle_salida' salida.id %}" class="btn btn-sm" style="background: #dbeafe; color: #2563eb; border: none;">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay salidas registradas</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Ventas - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-receipt"></i> Historial de Ventas</h1>
        <div>
            <span class="badge badge-modern badge-info-modern" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Total: {{ ventas|length }} ventas</span>
        </div>
    </div>

    <div class="card-modern">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5>
        </div>
        <div class="card-body">
        <!-- Filtros -->
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label-modern">Fecha Desde:</label>
                <input type="date" class="form-control form-control-modern" id="fechaDesde">
            </div>
            <div class="col-md-3">
                <label class="form-label-modern">Fecha Hasta:</label>
                <input type="date" class="form-control form-control-modern" id="fechaHasta">
            </div>
            <div class="col-md-3">
                <label class="form-label-modern">Estado:</label>
                <select class="form-select form-control-modern" id="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="completada">Completadas</option>
                    <option value="anulada">Anuladas</option>
                    <option value="pendiente">Pendientes</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label-modern">Método de Pago:</label>
                <select class="form-select form-control-modern" id="filtroMetodo">
                    <option value="">Todos los métodos</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>
        </div>
    </div>
</div>

    <div class="card-modern mt-3">
        <div class="card-body">
            <!-- Tabla de Ventas -->
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Método</th>
                        <th>Usuario</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venta in ventas %}
                    <tr>
                        <td><strong>{{ venta.id }}</strong></td>
                        <td>{{ venta.fecha|date:"d/m/Y H:i" }}</td>
                        <td><strong>${{ venta.total|intcomma }}</strong></td>
                        <td>
                            <span class="badge badge-modern badge-info-modern">
                                <i class="bi bi-{% if venta.metodo_pago == 'efectivo' %}cash{% elif venta.metodo_pago == 'tarjeta' %}credit-card{% else %}arrow-left-right{% endif %}"></i>
                                {{ venta.get_metodo_pago_display }}
                            </span>
                        </td>
                        <td>
                            {% if venta.usuario %}
                                {{ venta.usuario.get_full_name|default:venta.usuario.username }}
                            {% else %}
                                Sistema
                            {% endif %}
                        </td>
                        <td>
                            {% if venta.anulada %}
                            <span class="badge badge-modern badge-danger-modern">Anulada</span>
                            {% elif venta.completada %}
                            <span class="badge badge-modern badge-success-modern">Completada</span>
                            {% else %}
                            <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'pos:detalle_venta' venta.id %}" class="btn btn-sm" style="background: #dbeafe; color: #2563eb; border: none;" title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if not venta.anulada %}
                                <button type="button" class="btn btn-sm btn-primary-pos" onclick="imprimirTicket({{ venta.id }})" title="Imprimir ticket 80mm" style="padding: 0.25rem 0.5rem;">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <a href="{% url 'pos:editar_venta' venta.id %}" class="btn btn-sm btn-warning" title="Editar venta" style="padding: 0.25rem 0.5rem;">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% if user.is_staff %}
                                <button type="button" class="btn btn-sm btn-danger-pos" onclick="anularVenta({{ venta.id }})" title="Anular venta" style="padding: 0.25rem 0.5rem;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No hay ventas registradas</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
            <!-- Paginación aquí si es necesario -->
        </div>
    </div>
</div>

<!-- Modal para anular venta -->
<div class="modal fade" id="modalAnular" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Anular Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formAnular">
                {% csrf_token %}
                <div class="modal-body">
                    <p>¿Estás seguro de anular esta venta?</p>
                    <div class="mb-3">
                        <label class="form-label">Motivo de anulación:</label>
                        <textarea class="form-control" name="motivo" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Anular Venta</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function imprimirTicket(ventaId) {
    const url = `/ventas/${ventaId}/imprimir/`;
    const ventana = window.open(url, '_blank', 'width=300,height=600');
    if (ventana) {
        ventana.onload = function() {
            setTimeout(() => {
                ventana.print();
            }, 500);
        };
    }
}

function anularVenta(ventaId) {
    const modal = new bootstrap.Modal(document.getElementById('modalAnular'));
    const form = document.getElementById('formAnular');
    form.action = `/ventas/${ventaId}/anular/`;
    modal.show();
}

// Filtros
document.getElementById('fechaDesde')?.addEventListener('change', filtrarVentas);
document.getElementById('fechaHasta')?.addEventListener('change', filtrarVentas);
document.getElementById('filtroEstado')?.addEventListener('change', filtrarVentas);
document.getElementById('filtroMetodo')?.addEventListener('change', filtrarVentas);

function filtrarVentas() {
    const fechaDesde = document.getElementById('fechaDesde')?.value;
    const fechaHasta = document.getElementById('fechaHasta')?.value;
    const estado = document.getElementById('filtroEstado')?.value;
    const metodo = document.getElementById('filtroMetodo')?.value;
    
    const filas = document.querySelectorAll('tbody tr');
    filas.forEach(fila => {
        let mostrar = true;
        
        // Filtro por fecha
        if (fechaDesde || fechaHasta) {
            const fechaVenta = fila.querySelector('td:nth-child(2)')?.textContent.trim();
            // Implementar lógica de filtro por fecha si es necesario
        }
        
        // Filtro por estado
        if (estado) {
            const estadoVenta = fila.querySelector('td:nth-child(6)')?.textContent.trim().toLowerCase();
            if (estado === 'completada' && !estadoVenta.includes('completada')) mostrar = false;
            if (estado === 'anulada' && !estadoVenta.includes('anulada')) mostrar = false;
            if (estado === 'pendiente' && !estadoVenta.includes('pendiente')) mostrar = false;
        }
        
        // Filtro por método
        if (metodo) {
            const metodoVenta = fila.querySelector('td:nth-child(4)')?.textContent.trim().toLowerCase();
            if (!metodoVenta.includes(metodo)) mostrar = false;
        }
        
        fila.style.display = mostrar ? '' : 'none';
    });
}
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Iniciar Sesión - Sistema POS{% endblock %}

{% block full_content %}
<div class="row justify-content-center align-items-center" style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="col-md-5">
        <div class="card-modern shadow-lg">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); text-align: center; color: white;">
                <h3><i class="bi bi-shop"></i> Sistema POS</h3>
                <p class="mb-0" style="color: rgba(255,255,255,0.9);">Iniciar Sesión</p>
            </div>
            <div class="card-body p-5">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger" style="background: #fee2e2; border-color: #fca5a5; color: #991b1b;">
                        <i class="bi bi-exclamation-triangle"></i>
                        Usuario o contraseña incorrectos
                    </div>
                    {% endif %}
                    
                    <div class="form-group-modern">
                        <label for="username" class="form-label-modern">
                            <i class="bi bi-person"></i> Usuario
                        </label>
                        <input type="text" class="form-control form-control-modern form-control-lg" 
                               id="username" name="username" required autofocus>
                    </div>
                    
                    <div class="form-group-modern">
                        <label for="password" class="form-label-modern">
                            <i class="bi bi-lock"></i> Contraseña
                        </label>
                        <input type="password" class="form-control form-control-modern form-control-lg" 
                               id="password" name="password" required>
                    </div>
                    
                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="remember">
                        <label class="form-check-label" for="remember" style="color: #475569;">
                            Recordarme
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary-pos btn-lg w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Ingresar
                    </button>
                </form>
                
                <hr class="my-4" style="border-color: #e2e8f0;">
                
                <div class="text-center">
                    <button type="button" class="btn" style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;" data-bs-toggle="modal" data-bs-target="#pinModal">
                        <i class="bi bi-keypad"></i> Acceso Rápido con PIN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal PIN -->
<div class="modal fade" id="pinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-keypad"></i> Acceso con PIN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-5">
                <p style="color: #475569; margin-bottom: 1.5rem;">Ingresa tu PIN de 4 dígitos</p>
                <form method="post" action="{% url 'pos:login_pin' %}">
                    {% csrf_token %}
                    <input type="password" class="form-control form-control-modern form-control-lg text-center" 
                           id="pin" name="pin" maxlength="4" pattern="\d{4}" 
                           placeholder="****" style="font-size: 2rem; letter-spacing: 20px;">
                    <button type="submit" class="btn btn-primary-pos btn-lg w-100 mt-4">
                        <i class="bi bi-check-circle"></i> Ingresar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('pin').addEventListener('input', function(e) {
    if (this.value.length === 4) {
        this.form.submit();
    }
});
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Ranking de Vendedores - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-trophy"></i> Ranking de Vendedores</h1>
    </div>

    <!-- Filtros de Fecha -->
    <div class="card-modern mb-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-calendar-range"></i> Rango de Fechas</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label-modern">Fecha Desde:</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_desde" 
                           value="{{ fecha_desde|date:'Y-m-d' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label-modern">Fecha Hasta:</label>
                    <input type="date" class="form-control form-control-modern" name="fecha_hasta" 
                           value="{{ fecha_hasta|date:'Y-m-d' }}" required>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary-pos w-100">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="cards-grid mb-4">
        <div class="stat-card primary">
            <div class="stat-card-label">
                <i class="bi bi-currency-dollar"></i> Total General
            </div>
            <div class="stat-card-value">${{ total_general|intcomma }}</div>
        </div>
        <div class="stat-card success">
            <div class="stat-card-label">
                <i class="bi bi-receipt"></i> Total Ventas
            </div>
            <div class="stat-card-value">{{ cantidad_general }}</div>
        </div>
        <div class="stat-card info">
            <div class="stat-card-label">
                <i class="bi bi-graph-up"></i> Promedio General
            </div>
            <div class="stat-card-value">${{ promedio_general|intcomma }}</div>
        </div>
        {% if top_vendedor %}
        <div class="stat-card warning">
            <div class="stat-card-label">
                <i class="bi bi-trophy-fill"></i> Top Vendedor
            </div>
            <div class="stat-card-value" style="font-size: 1.2rem;">{{ top_vendedor.nombre_completo }}</div>
            <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                ${{ top_vendedor.total_ventas|intcomma }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Ranking de Vendedores -->
    <div class="card-modern">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> Ranking de Vendedores</h5>
        </div>
        <div class="card-body">
            {% if ranking_vendedores %}
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>Vendedor</th>
                            <th class="text-end">Total Ventas</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Promedio</th>
                            <th class="text-center">% del Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in ranking_vendedores %}
                        <tr>
                            <td>
                                {% if item.posicion == 1 %}
                                <span class="badge badge-modern" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; font-size: 1rem; padding: 0.5rem;">
                                    🥇
                                </span>
                                {% elif item.posicion == 2 %}
                                <span class="badge badge-modern" style="background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%); color: white; font-size: 1rem; padding: 0.5rem;">
                                    🥈
                                </span>
                                {% elif item.posicion == 3 %}
                                <span class="badge badge-modern" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; font-size: 1rem; padding: 0.5rem;">
                                    🥉
                                </span>
                                {% else %}
                                <span class="badge badge-modern badge-info-modern" style="font-size: 1rem; padding: 0.5rem;">
                                    #{{ item.posicion }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <strong style="font-size: 1rem;">{{ item.nombre_completo }}</strong><br>
                                    <small style="color: #64748b;">@{{ item.username }}</small>
                                </div>
                            </td>
                            <td class="text-end">
                                <strong style="font-size: 1.1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    ${{ item.total_ventas|intcomma }}
                                </strong>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-modern badge-success-modern">
                                    {{ item.cantidad_ventas }} ventas
                                </span>
                            </td>
                            <td class="text-end">
                                <span style="color: #64748b; font-weight: 600;">
                                    ${{ item.promedio_venta|intcomma }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if total_general > 0 %}
                                {% widthratio item.total_ventas total_general 100 as porcentaje %}
                                <div class="progress" style="height: 20px; background: #f1f5f9; border-radius: 10px;">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ porcentaje }}%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;"
                                         aria-valuenow="{{ porcentaje }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <span style="font-size: 0.75rem; font-weight: 600; color: white;">{{ porcentaje }}%</span>
                                    </div>
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                <p style="color: #64748b; font-size: 1.1rem;">No hay ventas registradas con vendedor en este período</p>
                <p style="color: #94a3b8; font-size: 0.9rem;">Las ventas deben tener un vendedor seleccionado en el POS para aparecer en el ranking</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.progress {
    height: 20px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% extends 'pos/base.html' %}

{% block title %}Productos - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-box-seam"></i> Gestión de Productos</h1>
        {% if puede_gestionar_productos %}
        <a href="{% url 'pos:crear_producto' %}" class="btn btn-primary-pos">
            <i class="bi bi-plus-circle"></i> Nuevo Producto
        </a>
        {% endif %}
    </div>

    <div class="card-modern">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Búsqueda y Filtros</h5>
        </div>
        <div class="card-body">
            <!-- Búsqueda y Filtros -->
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <input type="text" class="form-control form-control-modern" id="buscarProducto" 
                           placeholder="🔍 Buscar por código o nombre...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-control-modern" id="filtroEstado">
                        <option value="">Todos los productos</option>
                        <option value="activo">Solo activos</option>
                        <option value="inactivo">Solo inactivos</option>
                        <option value="bajo-stock">Stock bajo (&lt;10)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-modern mt-3">
        <div class="card-body">
            <!-- Tabla de Productos -->
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Código Barras</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                <tbody id="tablaProductos">
                    {% for producto in productos %}
                    <tr data-activo="{{ producto.activo|lower }}" data-stock="{{ producto.stock }}">
                        <td><strong>{{ producto.codigo }}</strong></td>
                        <td>
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" 
                                 style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;">
                            {% endif %}
                            {{ producto.nombre }}
                        </td>
                        <td>${{ producto.precio|intcomma }}</td>
                        <td>
                            {% if producto.stock < 10 %}
                            <span class="badge badge-modern badge-danger-modern">{{ producto.stock }}</span>
                            {% else %}
                            <span class="badge badge-modern badge-success-modern">{{ producto.stock }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.activo %}
                            <span class="badge badge-modern badge-success-modern">Activo</span>
                            {% else %}
                            <span class="badge badge-modern" style="background: #e2e8f0; color: #64748b;">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>{{ producto.codigo_barras|default:"N/A" }}</td>
                        <td>
                            {% if puede_gestionar_productos %}
                            <a href="{% url 'pos:editar_producto' producto.id %}" class="btn btn-sm btn-warning" style="padding: 0.25rem 0.5rem;">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% else %}
                            <span class="text-muted" style="font-size: 0.85rem;">Solo lectura</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No hay productos registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Búsqueda
document.getElementById('buscarProducto').addEventListener('input', filtrarProductos);
document.getElementById('filtroEstado').addEventListener('change', filtrarProductos);

function filtrarProductos() {
    let busqueda = document.getElementById('buscarProducto').value.toLowerCase();
    let filtroEstado = document.getElementById('filtroEstado').value;
    let filas = document.querySelectorAll('#tablaProductos tr');
    
    filas.forEach(fila => {
        let texto = fila.textContent.toLowerCase();
        let activo = fila.dataset.activo === 'true';
        let stock = parseInt(fila.dataset.stock);
        
        let mostrar = texto.includes(busqueda);
        
        if (mostrar && filtroEstado) {
            if (filtroEstado === 'activo') mostrar = activo;
            else if (filtroEstado === 'inactivo') mostrar = !activo;
            else if (filtroEstado === 'bajo-stock') mostrar = stock < 10;
        }
        
        fila.style.display = mostrar ? '' : 'none';
    });
}
</script>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Reportes - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-graph-up"></i> Reportes y Estadísticas</h1>
    </div>

    <div class="cards-grid">
        <div class="stat-card success">
            <div class="stat-card-label">
                <i class="bi bi-currency-dollar"></i> Ventas del Mes
            </div>
            <div class="stat-card-value">${{ total_ventas_mes|intcomma }}</div>
        </div>
        <div class="stat-card primary">
            <div class="stat-card-label">
                <i class="bi bi-receipt"></i> Transacciones
            </div>
            <div class="stat-card-value">{{ cantidad_ventas_mes }}</div>
        </div>
        <div class="stat-card info">
            <div class="stat-card-label">
                <i class="bi bi-graph-up-arrow"></i> Promedio por Venta
            </div>
            <div class="stat-card-value">${{ promedio_venta|intcomma }}</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-card-label">
                <i class="bi bi-box-seam"></i> Productos Activos
            </div>
            <div class="stat-card-value">{{ total_productos }}</div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Top 10 Productos Más Vendidos</h5>
                </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in top_productos %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ item.producto__nombre }}</td>
                                <td><span class="badge badge-modern badge-success-modern">{{ item.total_vendido }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No hay datos</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Ventas por Método de Pago</h5>
                </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Método</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for metodo in ventas_por_metodo %}
                            <tr>
                                <td>{{ metodo.metodo_pago|capfirst }}</td>
                                <td>{{ metodo.cantidad }}</td>
                                <td><strong>${{ metodo.total|intcomma }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No hay datos</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="card-modern mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtrar Reportes</h5>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Desde</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_desde" value="{{ fecha_desde|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-modern">Fecha Hasta</label>
                        <input type="date" class="form-control form-control-modern" name="fecha_hasta" value="{{ fecha_hasta|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary-pos w-100">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}Salida de Mercancía - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-arrow-up-circle-fill"></i> Salida de Mercancía</h1>
        <a href="{% url 'pos:crear_salida' %}" class="btn btn-primary-pos">
            <i class="bi bi-plus-circle"></i> Nueva Salida
        </a>
    </div>

    <div class="card-modern">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Destino</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for salida in salidas %}
                    <tr>
                        <td>{{ salida.id }}</td>
                        <td>{{ salida.fecha|date:"d/m/Y H:i" }}</td>
                        <td><span class="badge badge-modern badge-info-modern">{{ salida.get_tipo_display }}</span></td>
                        <td>{{ salida.destino|default:"N/A" }}</td>
                        <td>{{ salida.motivo|truncatewords:10 }}</td>
                        <td>
                            {% if salida.completado %}
                            <span class="badge badge-modern badge-success-modern">Completado</span>
                            {% else %}
                            <span class="badge badge-modern badge-warning-modern">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if salida.usuario %}
                                {{ salida.usuario.get_full_name|default:salida.usuario.username }}
                            {% else %}
                                Sistema
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'pos:detalle_salida' salida.id %}" class="btn btn-sm" style="background: #dbeafe; color: #2563eb; border: none;">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay salidas registradas</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #{{ venta.id }}</title>
    <style>
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 5mm;
                font-size: 12px;
            }
            .no-print {
                display: none;
            }
        }
        
        body {
            font-family: 'Courier New', monospace;
            width: 80mm;
            margin: 0 auto;
            padding: 5mm;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 5mm;
            margin-bottom: 5mm;
        }
        
        .header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: bold;
        }
        
        .header p {
            margin: 2mm 0;
            font-size: 10px;
        }
        
        .info {
            margin: 3mm 0;
            font-size: 11px;
        }
        
        .info strong {
            font-weight: bold;
        }
        
        .items {
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 3mm 0;
            margin: 5mm 0;
        }
        
        .item {
            margin: 2mm 0;
            font-size: 11px;
        }
        
        .item-name {
            font-weight: bold;
        }
        
        .item-detail {
            display: flex;
            justify-content: space-between;
            margin-top: 1mm;
            font-size: 10px;
        }
        
        .total {
            text-align: right;
            margin-top: 5mm;
            font-size: 14px;
            font-weight: bold;
        }
        
        .footer {
            text-align: center;
            margin-top: 10mm;
            padding-top: 5mm;
            border-top: 1px dashed #000;
            font-size: 10px;
        }
        
        .separator {
            text-align: center;
            margin: 3mm 0;
            font-size: 10px;
        }
        
        .btn-print {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-print:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <button class="btn-print no-print" onclick="window.print()">🖨️ Imprimir</button>
    
    <div class="header">
        <h1>TIENDA</h1>
        <p>Dirección de la tienda</p>
        <p>Tel: (000) 000-0000</p>
        <p>NIT: 000000000-0</p>
    </div>
    
    <div class="info">
        <p><strong>Ticket:</strong> #{{ venta.id }}</p>
        <p><strong>Fecha:</strong> {{ venta.fecha|date:"d/m/Y H:i" }}</p>
        {% if venta.usuario %}
        <p><strong>Vendedor:</strong> {{ venta.usuario.get_full_name|default:venta.usuario.username }}</p>
        {% endif %}
        <p><strong>Método:</strong> {{ venta.get_metodo_pago_display }}</p>
    </div>
    
    <div class="separator">--------------------------------</div>
    
    <div class="items">
        {% for item in venta.items.all %}
        <div class="item">
            <div class="item-name">{{ item.producto.nombre|upper }}</div>
            <div class="item-detail">
                <span>{{ item.cantidad }} x ${{ item.precio_unitario|intcomma }}</span>
                <span>${{ item.subtotal|intcomma }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="separator">--------------------------------</div>
    
    <div class="total">
        <p>TOTAL: ${{ venta.total|intcomma }}</p>
        {% if venta.metodo_pago == 'efectivo' and venta.monto_recibido %}
        <p style="font-size: 11px;">Recibido: ${{ venta.monto_recibido|intcomma }}</p>
        <p style="font-size: 11px;">Cambio: ${{ venta.monto_recibido|add:"-"|add:venta.total|intcomma }}</p>
        {% endif %}
    </div>
    
    <div class="footer">
        <p>¡Gracias por su compra!</p>
        <p>{{ venta.fecha|date:"d/m/Y H:i" }}</p>
        {% if venta.anulada %}
        <p style="color: red; font-weight: bold;">*** ANULADA ***</p>
        {% endif %}
    </div>
</body>
</html>


{% extends 'pos/base.html' %}

{% block title %}Usuarios - Sistema POS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="bi bi-person-fill"></i> Gestión de Usuarios</h1>
        <a href="{% url 'pos:crear_usuario' %}" class="btn btn-primary-pos">
            <i class="bi bi-plus-circle"></i> Nuevo Usuario
        </a>
    </div>

    <div class="card-modern">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table-modern table">
                    <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Grupos</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>PIN</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios %}
                    <tr>
                        <td><strong>{{ usuario.username }}</strong></td>
                        <td>{{ usuario.get_full_name|default:"-" }}</td>
                        <td>{{ usuario.email|default:"-" }}</td>
                        <td>
                            {% for grupo in usuario.groups.all %}
                            <span class="badge badge-modern badge-info-modern">{{ grupo.name }}</span>
                            {% empty %}
                            <span style="color: #94a3b8;">-</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if usuario.is_active %}
                            <span class="badge badge-modern badge-success-modern">Activo</span>
                            {% else %}
                            <span class="badge badge-modern badge-danger-modern">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.is_superuser %}
                            <span class="badge badge-modern badge-danger-modern">Superusuario</span>
                            {% elif usuario.is_staff %}
                            <span class="badge badge-modern badge-warning-modern">Staff</span>
                            {% else %}
                            <span class="badge badge-modern badge-info-modern">Usuario</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.perfil.pin_establecido %}
                            <code>{{ usuario.perfil.pin }}</code>
                            {% else %}
                            <span class="text-muted">Sin PIN</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'pos:editar_usuario' usuario.id %}" class="btn btn-sm btn-warning" style="padding: 0.25rem 0.5rem;">
                                <i class="bi bi-pencil"></i> Editar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% extends 'pos/base.html' %}

{% block title %}POS Dinámico - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .pos-container {
        display: flex;
        height: calc(100vh - 60px);
        min-height: calc(100vh - 60px);
        max-height: calc(100vh - 60px);
        gap: 0.4rem;
        margin: 0;
        padding: 0.4rem;
        width: 100%;
        box-sizing: border-box;
    }
    
    .pos-left {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        padding: 0.5rem;
        min-width: 0;
    }
    
    .pos-right {
        width: 380px;
        min-width: 320px;
        max-width: 380px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .pos-search-bar {
        position: relative;
        margin-bottom: 0.4rem;
    }
    
    .pos-search-bar input {
        width: 100%;
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-weight: 500;
        background: #f8fafc;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    
    .pos-search-bar input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 4px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
    }
    
    .productos-scroll {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.3rem;
    }
    
    .productos-scroll::-webkit-scrollbar {
        width: 6px;
    }
    
    .productos-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 8px;
    }
    
    .productos-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 8px;
    }
    
    .productos-scroll::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    .productos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.4rem;
        width: 100%;
    }
    
    .producto-card-pos {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 6px;
        padding: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .producto-imagen-container {
        width: 100%;
        height: 80px;
        margin-bottom: 0.4rem;
        border-radius: 4px;
        overflow: hidden;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .producto-imagen {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .producto-imagen-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 1.8rem;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }
    
    .producto-card-pos::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .producto-card-pos:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }
    
    .producto-card-pos:hover::before {
        transform: scaleX(1);
    }
    
    .producto-card-pos h4 {
        margin: 0 0 0.3rem 0;
        font-size: 0.75rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .producto-card-pos .precio-pos {
        font-size: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0.3rem 0;
    }
    
    .producto-card-pos .stock-pos {
        font-size: 0.7rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .stock-badge {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        background: #dcfce7;
        color: #166534;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    
    .carrito-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.4rem 0.6rem;
        font-weight: 700;
        font-size: 0.85rem;
        box-shadow: 0 1px 3px rgba(102, 126, 234, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.3rem;
    }
    
    .carrito-count-badge {
        background: rgba(255,255,255,0.3);
        padding: 0.15rem 0.4rem;
        border-radius: 10px;
        font-size: 0.7rem;
        backdrop-filter: blur(10px);
    }
    
    .btn-limpiar-carrito {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.3rem 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        min-width: 32px;
        height: 28px;
    }
    
    .btn-limpiar-carrito:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }
    
    .carrito-items {
        flex: 1;
        overflow-y: auto;
        padding: 0.4rem;
        background: #f8fafc;
    }
    
    .carrito-item {
        display: flex;
        flex-direction: column;
        padding: 0.4rem 0.5rem;
        background: white;
        margin-bottom: 0.35rem;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
        border-left: 2px solid #667eea;
        position: relative;
        gap: 0.35rem;
    }
    
    .carrito-item-numero {
        position: absolute;
        top: 0.35rem;
        left: 0.4rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: 700;
    }
    
    .carrito-footer {
        padding: 0.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-top: 1.5px solid #e2e8f0;
    }
    
    .carrito-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .carrito-total-monto {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 1.4rem;
        font-weight: 800;
    }
    
    .btn-procesar {
        width: 100%;
        padding: 0.6rem;
        font-size: 0.9rem;
        font-weight: 700;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 4px rgba(16, 185, 129, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }
    
    .btn-procesar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .metodo-pago-options {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }
    
    .metodo-pago-btn {
        flex: 1;
        padding: 0.5rem 0.4rem;
        border: 1.5px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: #64748b;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .metodo-pago-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .productos-mas-vendidos {
        margin-bottom: 0.4rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }
    
    .productos-mas-vendidos-header {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.35rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .productos-mas-vendidos-header h3 {
        font-size: 0.8rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .productos-mas-vendidos-scroll {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.4rem;
    }
    
    .producto-mas-vendido {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 6px;
        padding: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .producto-mas-vendido::after {
        content: '🔥';
        position: absolute;
        top: 0.35rem;
        right: 0.35rem;
        font-size: 1rem;
        opacity: 0.7;
        z-index: 1;
    }
    
    .producto-mas-vendido:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }
    
    .producto-mas-vendido h4 {
        margin: 0 0 0.3rem 0;
        font-size: 0.75rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .precio-mv {
        font-size: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0.3rem 0;
    }
    
    .empty-carrito {
        text-align: center;
        padding: 2rem 1.5rem;
        color: #94a3b8;
    }
    
    .empty-carrito::before {
        content: '🛒';
        font-size: 3rem;
        display: block;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    .empty-carrito-text {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .search-results-pos {
        position: absolute;
        top: calc(100% + 0.3rem);
        left: 0;
        right: 0;
        background: white;
        border: 1.5px solid #667eea;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .search-results-pos.active {
        display: block;
    }
    
    .search-item-pos {
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    
    .search-item-pos:hover {
        background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
        padding-left: 1rem;
    }
    
    .vendedor-section {
        margin-bottom: 0.5rem;
    }
    
    .btn-seleccionar-vendedor {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1.5px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: #1e293b;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .monto-recibido-container {
        background: white;
        padding: 0.6rem;
        border-radius: 6px;
        border: 1.5px solid #e2e8f0;
        margin-bottom: 0.5rem;
    }
    
    .monto-recibido-input-wrapper {
        display: flex;
        align-items: center;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        padding: 0 0.5rem;
    }
    
    .monto-recibido-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 800;
        text-align: right;
        color: #1e293b;
        outline: none;
    }
    
    .cambio-display {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 8px;
        border: 2px solid #3b82f6;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .cambio-monto {
        font-size: 1.8rem;
        font-weight: 900;
        color: #2563eb;
        text-align: center;
    }
    
    .carrito-item-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.25rem;
        flex-wrap: nowrap;
        margin-left: 0;
        padding-top: 0;
    }
    
    .carrito-item-info {
        flex: 1;
        min-width: 0;
        overflow: visible;
        margin-left: 1.4rem;
        padding-right: 0.3rem;
        padding-bottom: 0.1rem;
    }
    
    .carrito-item-nombre {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.75rem;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-wrap: break-word;
        line-height: 1.2;
        margin: 0;
    }
    
    .carrito-item-codigo {
        font-weight: 400;
        color: #64748b;
        font-size: 0.75rem;
    }
    
    .carrito-item-precio-wrapper {
        order: 2;
        flex-shrink: 0;
    }
    
    .carrito-item-cantidad {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        flex-shrink: 0;
        margin: 0;
        order: 1;
    }
    
    .carrito-item-cantidad input {
        width: 38px;
        padding: 0.25rem;
        text-align: center;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .btn-cantidad {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        width: 22px;
        height: 22px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .carrito-item-subtotal {
        font-weight: 700;
        color: #667eea;
        min-width: 70px;
        max-width: 85px;
        text-align: right;
        font-size: 0.8rem;
        flex-shrink: 0;
        white-space: nowrap;
        order: 3;
    }
    
    .carrito-item-eliminar {
        flex-shrink: 0;
        order: 4;
    }
    
    .btn-eliminar-item {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.25rem 0.4rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        font-weight: 600;
        min-width: 24px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .precio-display {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        padding: 0.25rem 0.4rem;
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .precio-display.editing {
        background: white;
        border-color: #667eea;
    }
    
    .input-precio {
        width: 80px;
        padding: 0.25rem 0.4rem;
        border: none;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 700;
        background: transparent;
        text-align: right;
        outline: none;
    }
    
    .precio-display:not(.editing) .input-precio {
        display: none;
    }
    
    .precio-display.editing .precio-valor,
    .precio-display.editing .precio-moneda {
        display: none;
    }
    
    .btn-precio-accion {
        display: none;
        background: #667eea;
        color: white;
        border: none;
        padding: 0.15rem 0.3rem;
        border-radius: 3px;
        font-size: 0.6rem;
        cursor: pointer;
        margin-left: 0.15rem;
    }
    
    .precio-display.editing .btn-precio-accion {
        display: inline-flex;
    }
    
    .btn-precio-accion.cancelar {
        background: #94a3b8;
    }
    
    .carrito-total-label {
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .metodo-pago-section {
        margin-bottom: 0.5rem;
    }
    
    .vendedor-section {
        margin-bottom: 0.5rem;
    }
    
    .monto-recibido-section {
        margin-bottom: 0.5rem;
    }
    
    .cambio-section {
        margin-bottom: 0.5rem;
    }
    
    .monto-insuficiente-section {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Columna izquierda: Productos -->
    <div class="pos-left">
        <div class="pos-search-bar">
            <input type="text" id="pos-search" placeholder="🔍 Buscar producto por nombre o código (Enter para agregar)" autocomplete="off" autofocus>
            <div class="search-results-pos" id="search-results-pos"></div>
        </div>
        
        {% if mas_vendidos_ids %}
        <div class="productos-mas-vendidos">
            <div class="productos-mas-vendidos-header">
                <h3><span class="icono">🔥</span> Más Vendidos</h3>
            </div>
            <div class="productos-mas-vendidos-scroll">
                {% for producto in productos %}
                    {% if producto.id in mas_vendidos_ids %}
                    <div class="producto-mas-vendido" data-id="{{ producto.id }}" onclick="agregarProductoRapido({{ producto.id }}, 1)">
                        <div class="producto-imagen-container">
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-imagen">
                            {% else %}
                            <div class="producto-imagen-placeholder">📦</div>
                            {% endif %}
                        </div>
                        <h4>{{ producto.nombre }}</h4>
                        <div class="precio-mv">${{ producto.precio|intcomma }}</div>
                        <div class="info-mv">
                            <span class="stock-badge">Stock: {{ producto.stock }}</span>
                            <span style="color: #94a3b8; font-size: 0.7rem;">{{ producto.codigo }}</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="productos-scroll">
            <div class="productos-grid" id="productos-grid">
                {% for producto in productos %}
                <div class="producto-card-pos" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre|lower }}" data-codigo="{{ producto.codigo|lower }}" data-codigo-barras="{{ producto.codigo_barras|default:''|lower }}" data-precio="{{ producto.precio }}" data-stock="{{ producto.stock }}" onclick="agregarProductoRapido({{ producto.id }}, 1)">
                    <div class="producto-imagen-container">
                        {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-imagen">
                        {% else %}
                        <div class="producto-imagen-placeholder">📦</div>
                        {% endif %}
                    </div>
                    <h4>{{ producto.nombre }}</h4>
                    <div class="precio-pos">${{ producto.precio|intcomma }}</div>
                    <div class="stock-pos">
                        <span class="stock-badge">Stock: {{ producto.stock }}</span>
                        <span style="color: #94a3b8;">{{ producto.codigo }}</span>
                    </div>
                </div>
                {% empty %}
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <p>No hay productos disponibles</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Columna derecha: Carrito -->
    <div class="pos-right">
        <div class="carrito-header">
            <div style="display: flex; align-items: center; gap: 0.3rem; flex: 1;">
                <span>🛒</span>
                <span>Carrito</span>
                <span class="carrito-count-badge" id="carrito-count">0</span>
            </div>
            {% if registradora_seleccionada %}
            <div style="font-size: 0.75rem; opacity: 0.9; margin-right: 0.5rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="font-size: 1rem;">🖨️</span>
                <span>{{ registradora_seleccionada.nombre }}</span>
            </div>
            <form method="post" action="{% url 'pos:cerrar_registradora' %}" style="margin: 0; margin-right: 0.3rem;">
                {% csrf_token %}
                <button type="submit" class="btn-limpiar-carrito" title="Cerrar registradora" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3);">
                    <span style="font-size: 0.9rem;">❌</span>
                </button>
            </form>
            {% endif %}
            <button class="btn-limpiar-carrito" id="btn-limpiar-carrito" type="button" title="Limpiar carrito" disabled>🗑️</button>
        </div>
        <div class="carrito-items" id="carrito-items">
            <div class="empty-carrito">
                <div class="empty-carrito-text">El carrito está vacío</div>
            </div>
        </div>
        <div class="carrito-footer">
            <div class="carrito-total">
                <span class="carrito-total-label">Total:</span>
                <span class="carrito-total-monto" id="carrito-total">$0</span>
            </div>
            
            <div class="metodo-pago-section">
                <label class="metodo-pago-label">Método de Pago:</label>
                <div class="metodo-pago-options">
                    <button type="button" class="metodo-pago-btn active" data-metodo="efectivo">💵 Efectivo</button>
                    <button type="button" class="metodo-pago-btn" data-metodo="tarjeta">💳 Tarjeta</button>
                    <button type="button" class="metodo-pago-btn" data-metodo="transferencia">📱 Transferencia</button>
                </div>
            </div>
            
            <div class="vendedor-section">
                <label class="vendedor-label">👤 Vendedor:</label>
                <button type="button" class="btn-seleccionar-vendedor" id="btn-seleccionar-vendedor" onclick="abrirSidebarVendedor()">
                    <span id="vendedor-seleccionado-texto">Seleccionar vendedor</span>
                    <span>▼</span>
                </button>
                <input type="hidden" id="vendedor-id" name="vendedor_id" value="">
            </div>
            
            <div class="monto-recibido-section" id="monto-recibido-section" style="display: block;">
                <div class="monto-recibido-container">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">💰 Monto Recibido:</label>
                    <div class="monto-recibido-input-wrapper">
                        <span style="font-size: 1rem; font-weight: 700; color: #64748b; margin-right: 0.3rem;">$</span>
                        <input type="text" id="monto-recibido" class="monto-recibido-input" placeholder="0" value="" autocomplete="off" inputmode="numeric">
                    </div>
                </div>
            </div>
            
            <div class="cambio-section" id="cambio-section" style="display: none;">
                <div class="cambio-display">
                    <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">💵</span>
                        <span style="font-size: 0.8rem; font-weight: 700; color: #1e40af; text-transform: uppercase;">Devuelta:</span>
                    </div>
                    <div style="text-align: center; padding: 0.5rem 0;">
                        <span class="cambio-monto" id="cambio-monto">$0</span>
                    </div>
                </div>
            </div>
            
            <div class="monto-insuficiente-section" id="monto-insuficiente-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 6px; border: 2px solid #ef4444; padding: 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.1rem;">⚠️</span>
                    <span style="font-size: 0.85rem; font-weight: 700; color: #991b1b; flex: 1;" id="monto-insuficiente-text">Monto insuficiente</span>
                </div>
            </div>
            
            <button class="btn-procesar" id="btn-procesar" onclick="procesarVenta()" disabled>💳 Procesar Venta</button>
        </div>
    </div>
</div>

<!-- Sidebar de selección de vendedor -->
<div class="sidebar-vendedor" id="sidebar-vendedor">
    <div class="sidebar-vendedor-header">
        <h3>👤 Seleccionar Vendedor</h3>
        <button class="sidebar-vendedor-cerrar" onclick="cerrarSidebarVendedor()">✕</button>
    </div>
    <div class="sidebar-vendedor-content" id="sidebar-vendedor-content">
        <div class="sidebar-vendedor-loading">Cargando usuarios...</div>
    </div>
</div>
<div class="sidebar-vendedor-overlay" id="sidebar-vendedor-overlay" onclick="cerrarSidebarVendedor()"></div>
{% endblock %}

{% block extra_js %}
<script>
// Cargar carrito desde sesión al iniciar
function cargarCarritoDesdeSesion() {
    fetch('{% url "pos:vender" %}?cargar_carrito=1', {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
        .then(r => r.json())
        .then(data => {
            if (data.carrito) {
                // Renderizar items del carrito
                renderizarCarrito(data.carrito);
            }
        })
        .catch(() => {});
}

// Renderizar carrito
function renderizarCarrito(carritoData) {
    const carritoItems = document.getElementById('carrito-items');
    if (!carritoItems) return;
    
    if (!carritoData || Object.keys(carritoData).length === 0) {
        carritoItems.innerHTML = '<div class="empty-carrito"><div class="empty-carrito-text">El carrito está vacío</div></div>';
        document.getElementById('carrito-count').textContent = '0';
        document.getElementById('carrito-total').textContent = '$0';
        document.getElementById('btn-procesar').disabled = true;
        return;
    }
    
    let html = '';
    let total = 0;
    let cantidadTotal = 0;
    let itemNum = 1;
    
    for (const [key, item] of Object.entries(carritoData)) {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        cantidadTotal += item.cantidad;
        
        html += `
            <div class="carrito-item" data-producto-id="${item.producto_id}">
                <div class="carrito-item-numero">#${itemNum++}</div>
                <div class="carrito-item-header">
                    <div class="carrito-item-info">
                        <div class="carrito-item-nombre">${item.nombre} <span class="carrito-item-codigo">(${item.codigo})</span></div>
                    </div>
                </div>
                <div class="carrito-item-controls">
                    <div class="carrito-item-precio-wrapper">
                        <div class="precio-display" data-producto-id="${item.producto_id}" data-precio-original="${item.precio}">
                            <span class="precio-valor">$${item.precio.toLocaleString('es-CO', {minimumFractionDigits: 0})}</span>
                            <span class="precio-moneda">COP</span>
                            <span class="precio-icono">✏️</span>
                            <input type="number" class="input-precio" value="${item.precio}" min="0" step="1">
                            <button class="btn-precio-accion confirmar">✓</button>
                            <button class="btn-precio-accion cancelar">✕</button>
                        </div>
                    </div>
                    <div class="carrito-item-cantidad">
                        <button class="btn-cantidad btn-restar" data-producto-id="${item.producto_id}">−</button>
                        <input type="number" class="input-cantidad" value="${item.cantidad}" min="1" data-producto-id="${item.producto_id}">
                        <button class="btn-cantidad btn-sumar" data-producto-id="${item.producto_id}">+</button>
                    </div>
                    <div class="carrito-item-subtotal">$${subtotal.toLocaleString('es-CO', {minimumFractionDigits: 0})}</div>
                    <div class="carrito-item-eliminar">
                        <button class="btn-eliminar-item" data-producto-id="${item.producto_id}">✕</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    carritoItems.innerHTML = html;
    document.getElementById('carrito-count').textContent = cantidadTotal;
    document.getElementById('carrito-total').textContent = '$' + total.toLocaleString('es-CO', {minimumFractionDigits: 0});
    document.getElementById('btn-procesar').disabled = cantidadTotal === 0;
    document.getElementById('btn-limpiar-carrito').disabled = cantidadTotal === 0;
}

// Función para agregar producto
function agregarProductoRapido(productoId, cantidad) {
    const formData = new FormData();
    formData.append('producto_id', productoId);
    formData.append('cantidad', cantidad);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "pos:agregar_carrito" %}', {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (window.showNotification) {
                window.showNotification(data.message || 'Producto agregado', 'success', 'Producto', 2000);
            }
            // Recargar carrito
            cargarCarritoDesdeSesion();
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 3000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (window.showNotification) {
            window.showNotification('Error de conexión', 'error', 'Error', 3000);
        }
    });
}

// Hacer función global
window.agregarProductoRapido = agregarProductoRapido;

// Procesar venta
async function procesarVenta() {
    const totalTexto = document.getElementById('carrito-total').textContent;
    const total = parseFloat(totalTexto.replace(/[^0-9]/g, ''));
    
    if (total === 0) {
        if (window.showNotification) {
            window.showNotification('El carrito está vacío', 'warning', 'Carrito vacío', 3000);
        }
        return;
    }
    
    const metodoPago = document.querySelector('.metodo-pago-btn.active')?.dataset.metodo || 'efectivo';
    const vendedorId = document.getElementById('vendedor-id')?.value || '';
    let montoRecibido = '';
    
    if (metodoPago === 'efectivo') {
        montoRecibido = document.getElementById('monto-recibido')?.value || '';
        if (montoRecibido) {
            const monto = parseFloat(montoRecibido.replace(/[^0-9]/g, ''));
            if (monto < total) {
                if (window.showNotification) {
                    window.showNotification('Monto insuficiente', 'error', 'Error', 3000);
                }
                return;
            }
        }
    }
    
    const confirmado = await confirm(`¿Procesar venta por $${total.toLocaleString('es-CO', {minimumFractionDigits: 0})}?`);
    if (!confirmado) return;
    
    const formData = new FormData();
    formData.append('metodo_pago', metodoPago);
    if (montoRecibido) {
        formData.append('monto_recibido', montoRecibido.replace(/[^0-9]/g, ''));
    }
    if (vendedorId) {
        formData.append('vendedor_id', vendedorId);
    }
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    if (window.showNotification) {
        window.showNotification('Procesando venta...', 'info', 'Procesando', 2000);
    }
    
    try {
        const response = await fetch('{% url "pos:procesar_venta_completa" %}', {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (window.showNotification) {
                window.showNotification(data.message, 'success', 'Venta Procesada', 3000);
            }
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 4000);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        if (window.showNotification) {
            window.showNotification('Error de conexión', 'error', 'Error', 4000);
        }
    }
}

// Hacer función global
window.procesarVenta = procesarVenta;

// Limpiar carrito
async function limpiarCarrito() {
    if (!confirm('¿Estás seguro de limpiar el carrito?')) return;
    
    fetch('{% url "pos:limpiar_carrito" %}', {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(() => {
        cargarCarritoDesdeSesion();
        if (window.showNotification) {
            window.showNotification('Carrito limpiado', 'success', 'Carrito', 2000);
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error al limpiar', 'error', 'Error', 3000);
        }
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Cargar carrito al iniciar
    cargarCarritoDesdeSesion();
    
    // Búsqueda
    const searchInput = document.getElementById('pos-search');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const productos = document.querySelectorAll('.producto-card-pos');
            
            productos.forEach(producto => {
                const nombre = producto.dataset.nombre || '';
                const codigo = producto.dataset.codigo || '';
                const codigoBarras = producto.dataset.codigoBarras || '';
                
                if (nombre.includes(query) || codigo.includes(query) || codigoBarras.includes(query)) {
                    producto.style.display = '';
                } else {
                    producto.style.display = 'none';
                }
            });
        });
    }
    
    // Método de pago
    let metodoPagoActual = 'efectivo';
    document.querySelectorAll('.metodo-pago-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.metodo-pago-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            metodoPagoActual = this.dataset.metodo;
            
            if (metodoPagoActual === 'efectivo') {
                document.getElementById('monto-recibido-section').style.display = 'block';
                document.getElementById('cambio-section').style.display = 'none';
                document.getElementById('monto-insuficiente-section').style.display = 'none';
            } else {
                document.getElementById('monto-recibido-section').style.display = 'none';
                document.getElementById('cambio-section').style.display = 'none';
                document.getElementById('monto-insuficiente-section').style.display = 'none';
            }
        });
    });
    
    // Calcular cambio
    const montoRecibidoInput = document.getElementById('monto-recibido');
    if (montoRecibidoInput) {
        montoRecibidoInput.addEventListener('input', function() {
            calcularCambio();
        });
    }
    
    function calcularCambio() {
        if (metodoPagoActual !== 'efectivo') return;
        
        const totalTexto = document.getElementById('carrito-total').textContent;
        const total = parseFloat(totalTexto.replace(/[^0-9]/g, '')) || 0;
        const montoRecibido = parseFloat(montoRecibidoInput.value.replace(/[^0-9]/g, '')) || 0;
        
        const cambioSection = document.getElementById('cambio-section');
        const insuficienteSection = document.getElementById('monto-insuficiente-section');
        
        if (montoRecibido === 0) {
            cambioSection.style.display = 'none';
            insuficienteSection.style.display = 'none';
            return;
        }
        
        if (montoRecibido >= total) {
            const cambio = montoRecibido - total;
            document.getElementById('cambio-monto').textContent = '$' + cambio.toLocaleString('es-CO', {minimumFractionDigits: 0});
            cambioSection.style.display = 'block';
            insuficienteSection.style.display = 'none';
        } else {
            const faltante = total - montoRecibido;
            document.getElementById('monto-insuficiente-text').textContent = `Faltan $${faltante.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            cambioSection.style.display = 'none';
            insuficienteSection.style.display = 'block';
        }
    }
    
    // Formatear monto recibido con separadores de miles
    if (montoRecibidoInput) {
        montoRecibidoInput.addEventListener('input', function() {
            // Guardar posición del cursor
            const cursorPos = this.selectionStart;
            const valorAnterior = this.value;
            
            // Limpiar y formatear
            const valorLimpio = this.value.replace(/[^0-9]/g, '');
            if (valorLimpio) {
                const num = parseInt(valorLimpio) || 0;
                this.value = num.toLocaleString('es-CO', {minimumFractionDigits: 0});
            } else {
                this.value = '';
            }
            
            // Restaurar posición del cursor
            const diff = this.value.length - valorAnterior.length;
            const newPos = Math.max(0, Math.min(cursorPos + diff, this.value.length));
            this.setSelectionRange(newPos, newPos);
            
            calcularCambio();
        });
        
        // Enter para procesar si hay cambio válido
        montoRecibidoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const totalTexto = document.getElementById('carrito-total').textContent;
                const total = parseFloat(totalTexto.replace(/[^0-9]/g, '')) || 0;
                const montoRecibido = parseFloat(this.value.replace(/[^0-9]/g, '')) || 0;
                
                if (montoRecibido >= total && !document.getElementById('btn-procesar').disabled) {
                    procesarVenta();
                }
            }
        });
    }
    
    // Limpiar carrito
    const btnLimpiar = document.getElementById('btn-limpiar-carrito');
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', limpiarCarrito);
    }
    
    // Delegación de eventos para el carrito
    const carritoItems = document.getElementById('carrito-items');
    if (carritoItems) {
        carritoItems.addEventListener('click', function(e) {
            const productoId = parseInt(e.target.getAttribute('data-producto-id'));
            if (!productoId) return;
            
            if (e.target.classList.contains('btn-sumar')) {
                cambiarCantidad(productoId, 1);
            } else if (e.target.classList.contains('btn-restar')) {
                cambiarCantidad(productoId, -1);
            } else if (e.target.classList.contains('btn-eliminar-item')) {
                eliminarItem(productoId);
            }
        });
    }
});

function cambiarCantidad(productoId, cambio) {
    const input = document.querySelector(`.input-cantidad[data-producto-id="${productoId}"]`);
    if (!input) return;
    
    const cantidadActual = parseInt(input.value) || 1;
    const nuevaCantidad = cantidadActual + cambio;
    
    if (nuevaCantidad > 0) {
        actualizarCantidad(productoId, nuevaCantidad);
    } else {
        eliminarItem(productoId);
    }
}

function actualizarCantidad(productoId, cantidad) {
    const formData = new FormData();
    formData.append('cantidad', cantidad);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`{% url "pos:actualizar_cantidad" 999 %}`.replace('999', productoId), {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarCarritoDesdeSesion();
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 3000);
            }
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error de conexión', 'error', 'Error', 3000);
        }
    });
}

async function eliminarItem(productoId) {
    const confirmado = await confirm('¿Eliminar este producto del carrito?');
    if (!confirmado) return;
    
    fetch(`{% url "pos:eliminar_item" 999 %}`.replace('999', productoId), {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarCarritoDesdeSesion();
            if (window.showNotification) {
                window.showNotification('Producto eliminado', 'success', 'Carrito', 2000);
            }
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error al eliminar', 'error', 'Error', 3000);
        }
    });
}

// Funciones de vendedor
function abrirSidebarVendedor() {
    document.getElementById('sidebar-vendedor').classList.add('active');
    document.getElementById('sidebar-vendedor-overlay').classList.add('active');
    cargarUsuarios();
}

function cerrarSidebarVendedor() {
    document.getElementById('sidebar-vendedor').classList.remove('active');
    document.getElementById('sidebar-vendedor-overlay').classList.remove('active');
}

function cargarUsuarios() {
    const content = document.getElementById('sidebar-vendedor-content');
    content.innerHTML = '<div class="sidebar-vendedor-loading">Cargando usuarios...</div>';
    
    fetch('{% url "pos:api_usuarios" %}')
        .then(r => r.json())
        .then(data => {
            content.innerHTML = '';
            
            // Botón "Sin vendedor"
            const btnSinVendedor = document.createElement('button');
            btnSinVendedor.className = 'usuario-btn';
            btnSinVendedor.innerHTML = '<div class="usuario-btn-nombre">Sin vendedor</div>';
            btnSinVendedor.onclick = () => seleccionarVendedor(null);
            content.appendChild(btnSinVendedor);
            
            data.usuarios.forEach(usuario => {
                const btn = document.createElement('button');
                btn.className = 'usuario-btn';
                btn.innerHTML = `
                    <div class="usuario-btn-nombre">${usuario.nombre_completo}</div>
                    <div class="usuario-btn-username">@${usuario.username}</div>
                    ${usuario.email ? `<div class="usuario-btn-email">${usuario.email}</div>` : ''}
                `;
                btn.onclick = () => seleccionarVendedor(usuario);
                content.appendChild(btn);
            });
        })
        .catch(() => {
            content.innerHTML = '<div class="sidebar-vendedor-loading" style="color: #ef4444;">Error al cargar usuarios</div>';
        });
}

function seleccionarVendedor(usuario) {
    const vendedorIdInput = document.getElementById('vendedor-id');
    const textoVendedor = document.getElementById('vendedor-seleccionado-texto');
    const btnSeleccionar = document.getElementById('btn-seleccionar-vendedor');
    
    if (usuario) {
        vendedorIdInput.value = usuario.id;
        textoVendedor.textContent = usuario.nombre_completo;
        btnSeleccionar.classList.add('vendedor-seleccionado');
    } else {
        vendedorIdInput.value = '';
        textoVendedor.textContent = 'Seleccionar vendedor';
        btnSeleccionar.classList.remove('vendedor-seleccionado');
    }
    
    // Actualizar botones en sidebar
    document.querySelectorAll('.usuario-btn').forEach(btn => {
        btn.classList.remove('selected');
        const nombre = btn.querySelector('.usuario-btn-nombre')?.textContent;
        if ((usuario && nombre === usuario.nombre_completo) || (!usuario && nombre === 'Sin vendedor')) {
            btn.classList.add('selected');
        }
    });
    
    cerrarSidebarVendedor();
}

window.abrirSidebarVendedor = abrirSidebarVendedor;
window.cerrarSidebarVendedor = cerrarSidebarVendedor;
</script>
{% endblock %}

