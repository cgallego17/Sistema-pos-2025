{% extends 'pos/base.html' %}
{% load humanize %}

{% block title %}POS Din√°mico - MegaPos By Megadominio.co{% endblock %}

{% block extra_css %}
<style>
    .pos-container {
        display: flex;
        height: calc(100vh - 60px);
        min-height: calc(100vh - 60px);
        max-height: calc(100vh - 60px);
        gap: 0.4rem;
        margin: 0;
        padding: 0.4rem;
        width: 100%;
        box-sizing: border-box;
    }
    
    .pos-left {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        padding: 0.5rem;
        min-width: 0;
    }
    
    .pos-right {
        width: 380px;
        min-width: 320px;
        max-width: 380px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .pos-search-bar {
        position: relative;
        margin-bottom: 0.4rem;
    }
    
    .pos-search-bar input {
        width: 100%;
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-weight: 500;
        background: #f8fafc;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    
    .pos-search-bar input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 4px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
    }
    
    .productos-scroll {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.3rem;
    }
    
    .productos-scroll::-webkit-scrollbar {
        width: 6px;
    }
    
    .productos-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 8px;
    }
    
    .productos-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 8px;
    }
    
    .productos-scroll::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    .productos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.4rem;
        width: 100%;
    }
    
    .producto-card-pos {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 6px;
        padding: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .producto-imagen-container {
        width: 100%;
        height: 80px;
        margin-bottom: 0.4rem;
        border-radius: 4px;
        overflow: hidden;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .producto-imagen {
        width: 100%;
        height: 100%;
        object-fit: scale-down;
        background: white;
    }
    
    .producto-imagen-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 1.8rem;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }
    
    .producto-card-pos::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .producto-card-pos:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }
    
    .producto-card-pos:hover::before {
        transform: scaleX(1);
    }
    
    .producto-card-pos h4 {
        margin: 0 0 0.3rem 0;
        font-size: 0.75rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .producto-card-pos .precio-pos {
        font-size: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0.3rem 0;
    }
    
    .producto-card-pos .stock-pos {
        font-size: 0.7rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .stock-badge {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        background: #dcfce7;
        color: #166534;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    
    .carrito-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.4rem 0.6rem;
        font-weight: 700;
        font-size: 0.85rem;
        box-shadow: 0 1px 3px rgba(102, 126, 234, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.3rem;
    }
    
    .carrito-count-badge {
        background: rgba(255,255,255,0.3);
        padding: 0.15rem 0.4rem;
        border-radius: 10px;
        font-size: 0.7rem;
        backdrop-filter: blur(10px);
    }
    
    .btn-limpiar-carrito {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.3rem 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        min-width: 32px;
        height: 28px;
    }
    
    .btn-limpiar-carrito:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }
    
    .carrito-items {
        flex: 1;
        overflow-y: auto;
        padding: 0.4rem;
        background: #f8fafc;
    }
    
    .carrito-item {
        display: flex;
        flex-direction: column;
        padding: 0.4rem 0.5rem;
        background: white;
        margin-bottom: 0.35rem;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
        border-left: 2px solid #667eea;
        position: relative;
        gap: 0.35rem;
    }
    
    .carrito-item-numero {
        position: absolute;
        top: 0.35rem;
        left: 0.4rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: 700;
    }
    
    .carrito-footer {
        padding: 0.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-top: 1.5px solid #e2e8f0;
    }
    
    .carrito-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .carrito-total-monto {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 1.4rem;
        font-weight: 800;
    }
    
    .btn-procesar {
        width: 100%;
        padding: 0.6rem;
        font-size: 0.9rem;
        font-weight: 700;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 4px rgba(16, 185, 129, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }
    
    .btn-procesar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .metodo-pago-options {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }
    
    .metodo-pago-btn {
        flex: 1;
        padding: 0.5rem 0.4rem;
        border: 1.5px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: #64748b;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .metodo-pago-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .productos-mas-vendidos {
        margin-bottom: 0.4rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }
    
    .productos-mas-vendidos-header {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.35rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .productos-mas-vendidos-header h3 {
        font-size: 0.8rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .productos-mas-vendidos-scroll {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.4rem;
    }
    
    .producto-mas-vendido {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 6px;
        padding: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .producto-mas-vendido::after {
        content: 'üî•';
        position: absolute;
        top: 0.35rem;
        right: 0.35rem;
        font-size: 1rem;
        opacity: 0.7;
        z-index: 1;
    }
    
    .producto-mas-vendido:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }
    
    .producto-mas-vendido h4 {
        margin: 0 0 0.3rem 0;
        font-size: 0.75rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .precio-mv {
        font-size: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0.3rem 0;
    }
    
    .empty-carrito {
        text-align: center;
        padding: 2rem 1.5rem;
        color: #94a3b8;
    }
    
    .empty-carrito::before {
        content: 'üõí';
        font-size: 3rem;
        display: block;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    .empty-carrito-text {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .search-results-pos {
        position: absolute;
        top: calc(100% + 0.3rem);
        left: 0;
        right: 0;
        background: white;
        border: 1.5px solid #667eea;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .search-results-pos.active {
        display: block;
    }
    
    .search-item-pos {
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    
    .search-item-pos:hover {
        background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
        padding-left: 1rem;
    }
    
    .vendedor-section {
        margin-bottom: 0.5rem;
    }
    
    .btn-seleccionar-vendedor {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1.5px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: #1e293b;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .monto-recibido-container {
        background: white;
        padding: 0.6rem;
        border-radius: 6px;
        border: 1.5px solid #e2e8f0;
        margin-bottom: 0.5rem;
    }
    
    .monto-recibido-input-wrapper {
        display: flex;
        align-items: center;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        padding: 0 0.5rem;
    }
    
    .monto-recibido-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 800;
        text-align: right;
        color: #1e293b;
        outline: none;
    }
    
    .cambio-display {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 8px;
        border: 2px solid #3b82f6;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .cambio-monto {
        font-size: 1.8rem;
        font-weight: 900;
        color: #2563eb;
        text-align: center;
    }
    
    .carrito-item-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.25rem;
        flex-wrap: nowrap;
        margin-left: 0;
        padding-top: 0;
    }
    
    .carrito-item-info {
        flex: 1;
        min-width: 0;
        overflow: visible;
        margin-left: 1.4rem;
        padding-right: 0.3rem;
        padding-bottom: 0.1rem;
    }
    
    .carrito-item-nombre {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.75rem;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-wrap: break-word;
        line-height: 1.2;
        margin: 0;
    }
    
    .carrito-item-codigo {
        font-weight: 400;
        color: #64748b;
        font-size: 0.75rem;
    }
    
    .carrito-item-precio-wrapper {
        order: 2;
        flex-shrink: 0;
    }
    
    .carrito-item-cantidad {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        flex-shrink: 0;
        margin: 0;
        order: 1;
    }
    
    .carrito-item-cantidad input {
        width: 38px;
        padding: 0.25rem;
        text-align: center;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .btn-cantidad {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        width: 22px;
        height: 22px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .carrito-item-subtotal {
        font-weight: 700;
        color: #667eea;
        min-width: 70px;
        max-width: 85px;
        text-align: right;
        font-size: 0.8rem;
        flex-shrink: 0;
        white-space: nowrap;
        order: 3;
    }
    
    .carrito-item-eliminar {
        flex-shrink: 0;
        order: 4;
    }
    
    .btn-eliminar-item {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.25rem 0.4rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        font-weight: 600;
        min-width: 24px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .precio-display {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        padding: 0.25rem 0.4rem;
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .precio-display.editing {
        background: white;
        border-color: #667eea;
    }
    
    .input-precio {
        width: 80px;
        padding: 0.25rem 0.4rem;
        border: none;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 700;
        background: transparent;
        text-align: right;
        outline: none;
    }
    
    .precio-display:not(.editing) .input-precio {
        display: none;
    }
    
    .precio-display.editing .precio-valor,
    .precio-display.editing .precio-moneda {
        display: none;
    }
    
    .btn-precio-accion {
        display: none;
        background: #667eea;
        color: white;
        border: none;
        padding: 0.15rem 0.3rem;
        border-radius: 3px;
        font-size: 0.6rem;
        cursor: pointer;
        margin-left: 0.15rem;
    }
    
    .precio-display.editing .btn-precio-accion {
        display: inline-flex;
    }
    
    .btn-precio-accion.cancelar {
        background: #94a3b8;
    }
    
    .carrito-total-label {
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .metodo-pago-section {
        margin-bottom: 0.5rem;
    }
    
    .vendedor-section {
        margin-bottom: 0.5rem;
    }
    
    .monto-recibido-section {
        margin-bottom: 0.5rem;
    }
    
    .cambio-section {
        margin-bottom: 0.5rem;
    }
    
    .monto-insuficiente-section {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Columna izquierda: Productos -->
    <div class="pos-left">
        <div class="pos-search-bar">
            <input type="text" id="pos-search" placeholder="üîç Buscar producto por nombre, c√≥digo o c√≥digo de barras (Enter para agregar)" autocomplete="off" autofocus>
            <div class="search-results-pos" id="search-results-pos"></div>
        </div>
        
        {% if mas_vendidos_ids %}
        <div class="productos-mas-vendidos">
            <div class="productos-mas-vendidos-header">
                <h3><span class="icono">üî•</span> M√°s Vendidos</h3>
            </div>
            <div class="productos-mas-vendidos-scroll">
                {% for producto in productos %}
                    {% if producto.id in mas_vendidos_ids %}
                    <div class="producto-mas-vendido" data-id="{{ producto.id }}" onclick="agregarProductoRapido({{ producto.id }}, 1)">
                        <div class="producto-imagen-container">
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-imagen">
                            {% else %}
                            <div class="producto-imagen-placeholder">üì¶</div>
                            {% endif %}
                        </div>
                        <h4>
                            {{ producto.nombre }}
                            {% if producto.atributo %}
                            <span style="display: inline-block; font-size: 0.6rem; background: #dbeafe; color: #2563eb; padding: 0.15rem 0.35rem; border-radius: 4px; margin-left: 0.3rem; font-weight: 600; vertical-align: middle;">
                                <i class="bi bi-tag-fill" style="font-size: 0.55rem;"></i> {{ producto.atributo }}
                            </span>
                            {% endif %}
                        </h4>
                        <div class="precio-mv">${{ producto.precio|intcomma }}</div>
                        <div class="info-mv">
                            <span class="stock-badge">Stock: {{ producto.stock|intcomma }}</span>
                            <span style="color: #94a3b8; font-size: 0.7rem;">{{ producto.codigo }}</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="productos-scroll">
            <div class="productos-grid" id="productos-grid">
                {% for producto in productos %}
                <div class="producto-card-pos" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre|lower }}" data-codigo="{{ producto.codigo|lower }}" data-codigo-barras="{{ producto.codigo_barras|default:''|lower }}" data-atributo="{{ producto.atributo|default:''|lower }}" data-precio="{{ producto.precio }}" data-stock="{{ producto.stock }}" onclick="agregarProductoRapido({{ producto.id }}, 1)">
                    <div class="producto-imagen-container">
                        {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-imagen">
                        {% else %}
                        <div class="producto-imagen-placeholder">üì¶</div>
                        {% endif %}
                    </div>
                    <h4>
                        {{ producto.nombre }}
                        {% if producto.atributo %}
                        <span style="display: inline-block; font-size: 0.65rem; background: #dbeafe; color: #2563eb; padding: 0.15rem 0.4rem; border-radius: 4px; margin-left: 0.3rem; font-weight: 600; vertical-align: middle;">
                            <i class="bi bi-tag-fill" style="font-size: 0.6rem;"></i> {{ producto.atributo }}
                        </span>
                        {% endif %}
                    </h4>
                    <div class="precio-pos">${{ producto.precio|intcomma }}</div>
                    <div class="stock-pos">
                        <span class="stock-badge">Stock: {{ producto.stock }}</span>
                        <span style="color: #94a3b8;">{{ producto.codigo }}</span>
                    </div>
                </div>
                {% empty %}
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <p>No hay productos disponibles</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Columna derecha: Carrito -->
    <div class="pos-right">
        <div class="carrito-header">
            <div style="display: flex; align-items: center; gap: 0.3rem; flex: 1;">
                <span>üõí</span>
                <span>Carrito</span>
                <span class="carrito-count-badge" id="carrito-count">0</span>
            </div>
            {% if registradora_seleccionada %}
            <div style="font-size: 0.75rem; opacity: 0.9; margin-right: 0.5rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="font-size: 1rem;">üñ®Ô∏è</span>
                <span>{{ registradora_seleccionada.nombre }}</span>
            </div>
            <form method="post" action="{% url 'pos:cerrar_registradora' %}" style="margin: 0; margin-right: 0.3rem;">
                {% csrf_token %}
                <button type="submit" class="btn-limpiar-carrito" title="Cerrar registradora" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3);">
                    <span style="font-size: 0.9rem;">‚ùå</span>
                </button>
            </form>
            {% endif %}
            <button class="btn-limpiar-carrito" id="btn-limpiar-carrito" type="button" title="Limpiar carrito" disabled>üóëÔ∏è</button>
        </div>
        <div class="carrito-items" id="carrito-items">
            <div class="empty-carrito">
                <div class="empty-carrito-text">El carrito est√° vac√≠o</div>
            </div>
        </div>
        <div class="carrito-footer">
            <div class="carrito-total">
                <span class="carrito-total-label">Total:</span>
                <span class="carrito-total-monto" id="carrito-total">$0</span>
            </div>
            
            <div class="metodo-pago-section">
                <label class="metodo-pago-label">M√©todo de Pago:</label>
                <div class="metodo-pago-options">
                    <button type="button" class="metodo-pago-btn active" data-metodo="efectivo">üíµ Efectivo</button>
                    <button type="button" class="metodo-pago-btn" data-metodo="tarjeta">üí≥ Tarjeta</button>
                    <button type="button" class="metodo-pago-btn" data-metodo="transferencia">üì± Transferencia</button>
                </div>
            </div>
            
            <div class="vendedor-section">
                <label class="vendedor-label">üë§ Vendedor:</label>
                <button type="button" class="btn-seleccionar-vendedor" id="btn-seleccionar-vendedor" onclick="abrirSidebarVendedor()">
                    <span id="vendedor-seleccionado-texto">Seleccionar vendedor</span>
                    <span>‚ñº</span>
                </button>
                <input type="hidden" id="vendedor-id" name="vendedor_id" value="">
            </div>
            
            <div class="monto-recibido-section" id="monto-recibido-section" style="display: block;">
                <div class="monto-recibido-container">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">üí∞ Monto Recibido:</label>
                    <div class="monto-recibido-input-wrapper">
                        <span style="font-size: 1rem; font-weight: 700; color: #64748b; margin-right: 0.3rem;">$</span>
                        <input type="text" id="monto-recibido" class="monto-recibido-input" placeholder="0" value="" autocomplete="off" inputmode="numeric">
                    </div>
                </div>
            </div>
            
            <div class="cambio-section" id="cambio-section" style="display: none;">
                <div class="cambio-display">
                    <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">üíµ</span>
                        <span style="font-size: 0.8rem; font-weight: 700; color: #1e40af; text-transform: uppercase;">Devuelta:</span>
                    </div>
                    <div style="text-align: center; padding: 0.5rem 0;">
                        <span class="cambio-monto" id="cambio-monto">$0</span>
                    </div>
                </div>
            </div>
            
            <div class="monto-insuficiente-section" id="monto-insuficiente-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 6px; border: 2px solid #ef4444; padding: 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.1rem;">‚ö†Ô∏è</span>
                    <span style="font-size: 0.85rem; font-weight: 700; color: #991b1b; flex: 1;" id="monto-insuficiente-text">Monto insuficiente</span>
                </div>
            </div>
            
            <button class="btn-procesar" id="btn-procesar" onclick="procesarVenta()" disabled>üí≥ Procesar Venta</button>
        </div>
    </div>
</div>

<!-- Sidebar de selecci√≥n de vendedor -->
<div class="sidebar-vendedor" id="sidebar-vendedor">
    <div class="sidebar-vendedor-header">
        <h3>üë§ Seleccionar Vendedor</h3>
        <button class="sidebar-vendedor-cerrar" onclick="cerrarSidebarVendedor()">‚úï</button>
    </div>
    <div class="sidebar-vendedor-search">
        <input type="text" id="sidebar-vendedor-buscar" class="sidebar-vendedor-input" placeholder="üîç Buscar vendedor por nombre, usuario o email..." autocomplete="off">
    </div>
    <div class="sidebar-vendedor-content" id="sidebar-vendedor-content">
        <div class="sidebar-vendedor-loading">Cargando usuarios...</div>
    </div>
</div>
<div class="sidebar-vendedor-overlay" id="sidebar-vendedor-overlay" onclick="cerrarSidebarVendedor()"></div>
{% endblock %}

{% block extra_js %}
<script>
// Cargar carrito desde sesi√≥n al iniciar
function cargarCarritoDesdeSesion() {
    fetch('{% url "pos:vender" %}?cargar_carrito=1', {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
        .then(r => r.json())
        .then(data => {
            if (data.carrito) {
                // Renderizar items del carrito
                renderizarCarrito(data.carrito);
            }
        })
        .catch(() => {});
}

// Renderizar carrito
function renderizarCarrito(carritoData) {
    const carritoItems = document.getElementById('carrito-items');
    if (!carritoItems) return;
    
    if (!carritoData || Object.keys(carritoData).length === 0) {
        carritoItems.innerHTML = '<div class="empty-carrito"><div class="empty-carrito-text">El carrito est√° vac√≠o</div></div>';
        document.getElementById('carrito-count').textContent = '0';
        document.getElementById('carrito-total').textContent = '$0';
        document.getElementById('btn-procesar').disabled = true;
        return;
    }
    
    let html = '';
    let total = 0;
    let cantidadTotal = 0;
    let itemNum = 1;
    
    for (const [key, item] of Object.entries(carritoData)) {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        cantidadTotal += item.cantidad;
        
        const atributoHtml = item.atributo ? `<span style="display: inline-block; font-size: 0.65rem; background: #dbeafe; color: #2563eb; padding: 0.15rem 0.35rem; border-radius: 4px; margin-left: 0.3rem; font-weight: 600; vertical-align: middle;"><i class="bi bi-tag-fill" style="font-size: 0.6rem;"></i> ${item.atributo}</span>` : '';
        
        html += `
            <div class="carrito-item" data-producto-id="${item.producto_id}">
                <div class="carrito-item-numero">#${itemNum++}</div>
                <div class="carrito-item-header">
                    <div class="carrito-item-info">
                        <div class="carrito-item-nombre">${item.nombre}${atributoHtml} <span class="carrito-item-codigo">(${item.codigo})</span></div>
                    </div>
                </div>
                <div class="carrito-item-controls">
                    <div class="carrito-item-precio-wrapper">
                        <div class="precio-display" data-producto-id="${item.producto_id}" data-precio-original="${item.precio}">
                            <span class="precio-valor">$${item.precio.toLocaleString('es-CO', {minimumFractionDigits: 0})}</span>
                            <span class="precio-moneda">COP</span>
                            <span class="precio-icono">‚úèÔ∏è</span>
                            <input type="number" class="input-precio" value="${item.precio}" min="0" step="1">
                            <button class="btn-precio-accion confirmar">‚úì</button>
                            <button class="btn-precio-accion cancelar">‚úï</button>
                        </div>
                    </div>
                    <div class="carrito-item-cantidad">
                        <button class="btn-cantidad btn-restar" data-producto-id="${item.producto_id}">‚àí</button>
                        <input type="number" class="input-cantidad" value="${item.cantidad}" min="1" data-producto-id="${item.producto_id}">
                        <button class="btn-cantidad btn-sumar" data-producto-id="${item.producto_id}">+</button>
                    </div>
                    <div class="carrito-item-subtotal">$${subtotal.toLocaleString('es-CO', {minimumFractionDigits: 0})}</div>
                    <div class="carrito-item-eliminar">
                        <button class="btn-eliminar-item" data-producto-id="${item.producto_id}">‚úï</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    carritoItems.innerHTML = html;
    document.getElementById('carrito-count').textContent = cantidadTotal;
    document.getElementById('carrito-total').textContent = '$' + total.toLocaleString('es-CO', {minimumFractionDigits: 0});
    document.getElementById('btn-procesar').disabled = cantidadTotal === 0;
    document.getElementById('btn-limpiar-carrito').disabled = cantidadTotal === 0;
}

// Funci√≥n para agregar producto
function agregarProductoRapido(productoId, cantidad) {
    const formData = new FormData();
    formData.append('producto_id', productoId);
    formData.append('cantidad', cantidad);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "pos:agregar_carrito" %}', {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (window.showNotification) {
                window.showNotification(data.message || 'Producto agregado', 'success', 'Producto', 2000);
            }
            // Recargar carrito
            cargarCarritoDesdeSesion();
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 3000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (window.showNotification) {
            window.showNotification('Error de conexi√≥n', 'error', 'Error', 3000);
        }
    });
}

// Hacer funci√≥n global
window.agregarProductoRapido = agregarProductoRapido;

// Procesar venta
async function procesarVenta() {
    const totalTexto = document.getElementById('carrito-total').textContent;
    const total = parseFloat(totalTexto.replace(/[^0-9]/g, ''));
    
    if (total === 0) {
        if (window.showNotification) {
            window.showNotification('El carrito est√° vac√≠o', 'warning', 'Carrito vac√≠o', 3000);
        }
        return;
    }
    
    const metodoPago = document.querySelector('.metodo-pago-btn.active')?.dataset.metodo || 'efectivo';
    const vendedorId = document.getElementById('vendedor-id')?.value || '';
    let montoRecibido = '';
    
    if (metodoPago === 'efectivo') {
        montoRecibido = document.getElementById('monto-recibido')?.value || '';
        if (montoRecibido) {
            const monto = parseFloat(montoRecibido.replace(/[^0-9]/g, ''));
            if (monto < total) {
                if (window.showNotification) {
                    window.showNotification('Monto insuficiente', 'error', 'Error', 3000);
                }
                return;
            }
        }
    }
    
    const confirmado = await confirm(`¬øProcesar venta por $${total.toLocaleString('es-CO', {minimumFractionDigits: 0})}?`);
    if (!confirmado) return;
    
    const formData = new FormData();
    formData.append('metodo_pago', metodoPago);
    
    // Si es efectivo, siempre enviar monto recibido (si no se ingresa, se usar√° el total en el backend)
    if (metodoPago === 'efectivo') {
        const montoRecibidoLimpio = montoRecibido ? montoRecibido.replace(/[^0-9]/g, '') : '';
        if (montoRecibidoLimpio) {
            formData.append('monto_recibido', montoRecibidoLimpio);
        }
        // Si no se ingres√≥ monto recibido, el backend usar√° el total como monto recibido (sin vuelto)
    }
    
    if (vendedorId) {
        formData.append('vendedor_id', vendedorId);
    }
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    if (window.showNotification) {
        window.showNotification('Procesando venta...', 'info', 'Procesando', 2000);
    }
    
    try {
        const response = await fetch('{% url "pos:procesar_venta_completa" %}', {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (window.showNotification) {
                window.showNotification(data.message, 'success', 'Venta Procesada', 3000);
            }
            
            // Preguntar si desea imprimir el ticket
            const imprimir = confirm('¬øDesea imprimir el ticket de la venta?');
            
            if (imprimir && data.venta_id) {
                // Abrir ventana de impresi√≥n
                const urlImprimir = `{% url 'pos:imprimir_ticket' 0 %}`.replace('0', data.venta_id);
                const ventanaImpresion = window.open(urlImprimir, '_blank');
                
                if (ventanaImpresion) {
                    // Esperar a que la ventana cargue y luego imprimir
                    ventanaImpresion.onload = function() {
                        setTimeout(() => {
                            ventanaImpresion.print();
                        }, 500);
                    };
                    
                    // Fallback: si onload no funciona, intentar despu√©s de un tiempo
                    setTimeout(() => {
                        try {
                            ventanaImpresion.print();
                        } catch (e) {
                            console.log('No se pudo imprimir autom√°ticamente');
                        }
                    }, 1000);
                }
            }
            
            // Recargar la p√°gina despu√©s de un breve delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 4000);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        if (window.showNotification) {
            window.showNotification('Error de conexi√≥n', 'error', 'Error', 4000);
        }
    }
}

// Hacer funci√≥n global
window.procesarVenta = procesarVenta;

// Limpiar carrito
async function limpiarCarrito() {
    if (!confirm('¬øEst√°s seguro de limpiar el carrito?')) return;
    
    fetch('{% url "pos:limpiar_carrito" %}', {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(() => {
        cargarCarritoDesdeSesion();
        if (window.showNotification) {
            window.showNotification('Carrito limpiado', 'success', 'Carrito', 2000);
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error al limpiar', 'error', 'Error', 3000);
        }
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Cargar carrito al iniciar
    cargarCarritoDesdeSesion();
    
    // B√∫squeda
    const searchInput = document.getElementById('pos-search');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            const productos = document.querySelectorAll('.producto-card-pos');
            
            if (query === '') {
                // Si no hay b√∫squeda, mostrar todos los productos
                productos.forEach(producto => {
                    producto.style.display = '';
                });
                return;
            }
            
            productos.forEach(producto => {
                const nombre = (producto.dataset.nombre || '').toLowerCase();
                const codigo = (producto.dataset.codigo || '').toLowerCase();
                // Obtener c√≥digo de barras - data-codigo-barras se convierte a codigoBarras en dataset
                const codigoBarras = (producto.dataset.codigoBarras || '').toLowerCase();
                // Obtener atributo - data-atributo se convierte a atributo en dataset
                const atributo = (producto.dataset.atributo || '').toLowerCase();
                
                // Buscar en nombre, c√≥digo, c√≥digo de barras y atributo
                const coincide = nombre.includes(query) || 
                                codigo.includes(query) || 
                                codigoBarras.includes(query) ||
                                atributo.includes(query);
                
                if (coincide) {
                    producto.style.display = '';
                } else {
                    producto.style.display = 'none';
                }
            });
        });
    }
    
    // M√©todo de pago
    let metodoPagoActual = 'efectivo';
    document.querySelectorAll('.metodo-pago-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.metodo-pago-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            metodoPagoActual = this.dataset.metodo;
            
            if (metodoPagoActual === 'efectivo') {
                document.getElementById('monto-recibido-section').style.display = 'block';
                document.getElementById('cambio-section').style.display = 'none';
                document.getElementById('monto-insuficiente-section').style.display = 'none';
            } else {
                document.getElementById('monto-recibido-section').style.display = 'none';
                document.getElementById('cambio-section').style.display = 'none';
                document.getElementById('monto-insuficiente-section').style.display = 'none';
            }
        });
    });
    
    // Calcular cambio
    const montoRecibidoInput = document.getElementById('monto-recibido');
    if (montoRecibidoInput) {
        montoRecibidoInput.addEventListener('input', function() {
            calcularCambio();
        });
    }
    
    function calcularCambio() {
        if (metodoPagoActual !== 'efectivo') return;
        
        const totalTexto = document.getElementById('carrito-total').textContent;
        const total = parseFloat(totalTexto.replace(/[^0-9]/g, '')) || 0;
        const montoRecibido = parseFloat(montoRecibidoInput.value.replace(/[^0-9]/g, '')) || 0;
        
        const cambioSection = document.getElementById('cambio-section');
        const insuficienteSection = document.getElementById('monto-insuficiente-section');
        
        if (montoRecibido === 0) {
            cambioSection.style.display = 'none';
            insuficienteSection.style.display = 'none';
            return;
        }
        
        if (montoRecibido >= total) {
            const cambio = montoRecibido - total;
            document.getElementById('cambio-monto').textContent = '$' + cambio.toLocaleString('es-CO', {minimumFractionDigits: 0});
            cambioSection.style.display = 'block';
            insuficienteSection.style.display = 'none';
        } else {
            const faltante = total - montoRecibido;
            document.getElementById('monto-insuficiente-text').textContent = `Faltan $${faltante.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            cambioSection.style.display = 'none';
            insuficienteSection.style.display = 'block';
        }
    }
    
    // Formatear monto recibido con separadores de miles
    if (montoRecibidoInput) {
        montoRecibidoInput.addEventListener('input', function() {
            // Guardar posici√≥n del cursor
            const cursorPos = this.selectionStart;
            const valorAnterior = this.value;
            
            // Limpiar y formatear
            const valorLimpio = this.value.replace(/[^0-9]/g, '');
            if (valorLimpio) {
                const num = parseInt(valorLimpio) || 0;
                this.value = num.toLocaleString('es-CO', {minimumFractionDigits: 0});
            } else {
                this.value = '';
            }
            
            // Restaurar posici√≥n del cursor
            const diff = this.value.length - valorAnterior.length;
            const newPos = Math.max(0, Math.min(cursorPos + diff, this.value.length));
            this.setSelectionRange(newPos, newPos);
            
            calcularCambio();
        });
        
        // Enter para procesar si hay cambio v√°lido
        montoRecibidoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const totalTexto = document.getElementById('carrito-total').textContent;
                const total = parseFloat(totalTexto.replace(/[^0-9]/g, '')) || 0;
                const montoRecibido = parseFloat(this.value.replace(/[^0-9]/g, '')) || 0;
                
                if (montoRecibido >= total && !document.getElementById('btn-procesar').disabled) {
                    procesarVenta();
                }
            }
        });
    }
    
    // Limpiar carrito
    const btnLimpiar = document.getElementById('btn-limpiar-carrito');
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', limpiarCarrito);
    }
    
    // Delegaci√≥n de eventos para el carrito
    const carritoItems = document.getElementById('carrito-items');
    if (carritoItems) {
        carritoItems.addEventListener('click', function(e) {
            const productoId = parseInt(e.target.getAttribute('data-producto-id'));
            if (!productoId) return;
            
            if (e.target.classList.contains('btn-sumar')) {
                cambiarCantidad(productoId, 1);
            } else if (e.target.classList.contains('btn-restar')) {
                cambiarCantidad(productoId, -1);
            } else if (e.target.classList.contains('btn-eliminar-item')) {
                eliminarItem(productoId);
            }
        });
    }
    
    // B√∫squeda de vendedores en el sidebar
    const buscarVendedorInput = document.getElementById('sidebar-vendedor-buscar');
    if (buscarVendedorInput) {
        buscarVendedorInput.addEventListener('input', function(e) {
            filtrarUsuarios(e.target.value);
        });
    }
});

function cambiarCantidad(productoId, cambio) {
    const input = document.querySelector(`.input-cantidad[data-producto-id="${productoId}"]`);
    if (!input) return;
    
    const cantidadActual = parseInt(input.value) || 1;
    const nuevaCantidad = cantidadActual + cambio;
    
    if (nuevaCantidad > 0) {
        actualizarCantidad(productoId, nuevaCantidad);
    } else {
        eliminarItem(productoId);
    }
}

function actualizarCantidad(productoId, cantidad) {
    const formData = new FormData();
    formData.append('cantidad', cantidad);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`{% url "pos:actualizar_cantidad" 999 %}`.replace('999', productoId), {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarCarritoDesdeSesion();
        } else {
            if (window.showNotification) {
                window.showNotification(data.error || 'Error', 'error', 'Error', 3000);
            }
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error de conexi√≥n', 'error', 'Error', 3000);
        }
    });
}

async function eliminarItem(productoId) {
    const confirmado = await confirm('¬øEliminar este producto del carrito?');
    if (!confirmado) return;
    
    fetch(`{% url "pos:eliminar_item" 999 %}`.replace('999', productoId), {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarCarritoDesdeSesion();
            if (window.showNotification) {
                window.showNotification('Producto eliminado', 'success', 'Carrito', 2000);
            }
        }
    })
    .catch(() => {
        if (window.showNotification) {
            window.showNotification('Error al eliminar', 'error', 'Error', 3000);
        }
    });
}

// Funciones de vendedor
function abrirSidebarVendedor() {
    document.getElementById('sidebar-vendedor').classList.add('active');
    document.getElementById('sidebar-vendedor-overlay').classList.add('active');
    cargarUsuarios();
    
    // Enfocar el campo de b√∫squeda despu√©s de un breve delay
    setTimeout(() => {
        const buscarInput = document.getElementById('sidebar-vendedor-buscar');
        if (buscarInput) {
            buscarInput.focus();
        }
    }, 300);
}

function cerrarSidebarVendedor() {
    document.getElementById('sidebar-vendedor').classList.remove('active');
    document.getElementById('sidebar-vendedor-overlay').classList.remove('active');
}

// Variable global para almacenar todos los usuarios
let todosLosUsuarios = [];

function cargarUsuarios() {
    const content = document.getElementById('sidebar-vendedor-content');
    content.innerHTML = '<div class="sidebar-vendedor-loading">Cargando usuarios...</div>';
    
    // Limpiar el campo de b√∫squeda
    const buscarInput = document.getElementById('sidebar-vendedor-buscar');
    if (buscarInput) {
        buscarInput.value = '';
    }
    
    fetch('{% url "pos:api_usuarios" %}')
        .then(r => r.json())
        .then(data => {
            todosLosUsuarios = data.usuarios;
            renderizarUsuarios(todosLosUsuarios);
        })
        .catch(() => {
            content.innerHTML = '<div class="sidebar-vendedor-loading" style="color: #ef4444;">Error al cargar usuarios</div>';
        });
}

function renderizarUsuarios(usuarios) {
    const content = document.getElementById('sidebar-vendedor-content');
    content.innerHTML = '';
    
    if (usuarios.length === 0) {
        content.innerHTML = '<div class="sidebar-vendedor-empty">No se encontraron vendedores</div>';
        return;
    }
    
    // Bot√≥n "Sin vendedor"
    const btnSinVendedor = document.createElement('button');
    btnSinVendedor.className = 'usuario-btn';
    btnSinVendedor.setAttribute('data-nombre', 'Sin vendedor');
    btnSinVendedor.setAttribute('data-username', '');
    btnSinVendedor.setAttribute('data-email', '');
    btnSinVendedor.innerHTML = '<div class="usuario-btn-nombre">Sin vendedor</div>';
    btnSinVendedor.onclick = () => seleccionarVendedor(null);
    content.appendChild(btnSinVendedor);
    
    usuarios.forEach(usuario => {
        const btn = document.createElement('button');
        btn.className = 'usuario-btn';
        btn.setAttribute('data-nombre', usuario.nombre_completo || '');
        btn.setAttribute('data-username', usuario.username || '');
        btn.setAttribute('data-email', usuario.email || '');
        btn.innerHTML = `
            <div class="usuario-btn-nombre">${usuario.nombre_completo}</div>
            <div class="usuario-btn-username">@${usuario.username}</div>
            ${usuario.email ? `<div class="usuario-btn-email">${usuario.email}</div>` : ''}
        `;
        btn.onclick = () => seleccionarVendedor(usuario);
        content.appendChild(btn);
    });
}

function filtrarUsuarios(query) {
    if (!query || query.trim() === '') {
        renderizarUsuarios(todosLosUsuarios);
        return;
    }
    
    const queryLower = query.toLowerCase().trim();
    const usuariosFiltrados = todosLosUsuarios.filter(usuario => {
        const nombre = (usuario.nombre_completo || '').toLowerCase();
        const username = (usuario.username || '').toLowerCase();
        const email = (usuario.email || '').toLowerCase();
        
        return nombre.includes(queryLower) || 
               username.includes(queryLower) || 
               email.includes(queryLower);
    });
    
    renderizarUsuarios(usuariosFiltrados);
}

function seleccionarVendedor(usuario) {
    const vendedorIdInput = document.getElementById('vendedor-id');
    const textoVendedor = document.getElementById('vendedor-seleccionado-texto');
    const btnSeleccionar = document.getElementById('btn-seleccionar-vendedor');
    
    if (usuario) {
        vendedorIdInput.value = usuario.id;
        textoVendedor.textContent = usuario.nombre_completo;
        btnSeleccionar.classList.add('vendedor-seleccionado');
    } else {
        vendedorIdInput.value = '';
        textoVendedor.textContent = 'Seleccionar vendedor';
        btnSeleccionar.classList.remove('vendedor-seleccionado');
    }
    
    // Actualizar botones en sidebar
    document.querySelectorAll('.usuario-btn').forEach(btn => {
        btn.classList.remove('selected');
        const nombre = btn.querySelector('.usuario-btn-nombre')?.textContent;
        if ((usuario && nombre === usuario.nombre_completo) || (!usuario && nombre === 'Sin vendedor')) {
            btn.classList.add('selected');
        }
    });
    
    cerrarSidebarVendedor();
}

window.abrirSidebarVendedor = abrirSidebarVendedor;
window.cerrarSidebarVendedor = cerrarSidebarVendedor;
</script>
{% endblock %}
